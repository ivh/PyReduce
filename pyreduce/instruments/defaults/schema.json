{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "pyreduce.schema",
    "title": "PyReduce Settings",
    "description": "Available settings for the PyReduce reduction pipeline",
    "type": "object",
    "properties": {
        "__instrument__": {
            "description": "The name of the instrument these settings are designed for",
            "type": "string"
        },
        "reduce": {
            "type": "object",
            "properties": {
                "base_dir": {
                    "description": "Base directory of all reduce operations, to keep input and output seperate",
                    "type": "string"
                },
                "input_dir": {
                    "description": "Directory containing the input data, relative to the base directory. May contain {instrument}, {night}, {mode}, {target} tags.",
                    "type": "string"
                },
                "output_dir": {
                    "description": "Directory to place the output (and temporary) files in, relative to the base directory. May contain {instrument}, {night}, {mode}, {target} tags.",
                    "type": "string"
                }
            }
        },
        "instrument": {
            "type": "object"
        },
        "mask": {
            "type": "object"
        },
        "bias": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "type": "object",
                    "properties": {
                        "degree": {
                            "description": "Polynomial degree of the fit between exposure time and pixel values",
                            "type": "number",
                            "minimum": 0
                        }
                    }
                }
            ]
        },
        "flat": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                }
            ]
        },
        "trace": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                },
                {
                    "type": "object",
                    "properties": {
                        "degree": {
                            "description": "Polynomial degree of the fit to the orders on the detector",
                            "type": "integer",
                            "minimum": 0
                        },
                        "degree_before_merge": {
                            "description": "Polynomial degree of the first fit to the orders, before merging clusters",
                            "type": [
                                "integer",
                                "string"
                            ],
                            "minimum": 0
                        },
                        "regularization": {
                            "description": "Regularization parameter for the order fitting (before merging)",
                            "type": "number",
                            "minimum": 0
                        },
                        "closing_shape": {
                            "description": "Shape for binary closing (fills gaps within traces)",
                            "type": "array",
                            "minItems": 2,
                            "maxItems": 2,
                            "items": {
                                "type": "integer",
                                "minimum": 1
                            }
                        },
                        "opening_shape": {
                            "description": "Shape for binary opening (removes isolated noise pixels)",
                            "type": "array",
                            "minItems": 2,
                            "maxItems": 2,
                            "items": {
                                "type": "integer",
                                "minimum": 1
                            }
                        },
                        "auto_merge_threshold": {
                            "description": "Minimum overlap score (0-1) required to auto-merge clusters. Higher values = less merging. Set to 1 to disable auto-merging entirely.",
                            "type": "number",
                            "minimum": 0,
                            "maximum": 1
                        },
                        "merge_min_threshold": {
                            "description": "Minimum merge probabilty to consider",
                            "type": "number",
                            "minimum": 0,
                            "maximum": 1
                        },
                        "split_sigma": {
                            "description": "Number of standard deviations around the best fit polyonomial of all orders, to split data points of of. Set to 0 to disable splitting.",
                            "type": "number",
                            "minimum": 0
                        },
                        "filter_x": {
                            "description": "Gaussian smoothing sigma along x-axis (dispersion direction). Set to 0 to disable. Useful for noisy data or thin fiber traces.",
                            "type": "integer",
                            "minimum": 0,
                            "default": 0
                        },
                        "filter_y": {
                            "description": "Smoothing width along y-axis (cross-dispersion) for background estimation. Estimated automatically if null. Use small values for thin closely-spaced traces.",
                            "type": [
                                "integer",
                                "null"
                            ],
                            "minimum": 0
                        },
                        "filter_type": {
                            "description": "Type of smoothing filter for background estimation: boxcar (uniform average), gaussian, or whittaker (edge-preserving).",
                            "type": "string",
                            "enum": [
                                "boxcar",
                                "gaussian",
                                "whittaker"
                            ],
                            "default": "boxcar"
                        },
                        "min_cluster": {
                            "description": "Smallest allowed size of clusters before merging. Estimated automatically if null.",
                            "type": [
                                "integer",
                                "null"
                            ],
                            "minimum": 0
                        },
                        "min_width": {
                            "description": "Minimum width of a cluster to be considered after merging. If between 0 and 1, use that fraction of the detector width. Estimated automatically if null",
                            "type": [
                                "number",
                                "null"
                            ],
                            "minimum": 0
                        },
                        "noise": {
                            "description": "Absolute noise threshold added to background (default: 0).",
                            "type": "number",
                            "minimum": 0
                        },
                        "noise_relative": {
                            "description": "Relative noise threshold as fraction of background (default: 0). If both noise and noise_relative are 0, defaults to 0.001 (0.1%).",
                            "type": "number",
                            "minimum": 0
                        },
                        "border_width": {
                            "description": "Pixels to ignore at image edges. Int for all sides, or [top, bottom, left, right]. Estimated automatically if null.",
                            "oneOf": [
                                {"type": "null"},
                                {"type": "integer", "minimum": 0},
                                {
                                    "type": "array",
                                    "items": {"type": "integer", "minimum": 0},
                                    "minItems": 4,
                                    "maxItems": 4
                                }
                            ]
                        },
                        "manual": {
                            "description": "Ask for manual confirmation before merging any clusters. Otherwise only ask when overlap below 90%.",
                            "type": "boolean"
                        }
                    }
                }
            ]
        },
        "scatter": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                },
                {
                    "type": "object",
                    "properties": {
                        "scatter_degree": {
                            "description": "Polynomial degree of the background scatter, in both pixel dimensions",
                            "type": [
                                "integer",
                                "array"
                            ],
                            "minimum": 0,
                            "items": {
                                "type": "integer",
                                "minimum": 0
                            }
                        },
                        "extraction_height": {
                            "description": "Total extraction height in pixels (split evenly above/below trace). Values under 2 are interpreted as fractions of order spacing. If null, uses heights computed from trace spacing.",
                            "type": [
                                "integer",
                                "number",
                                "null"
                            ],
                            "items": {
                                "type": [
                                    "integer",
                                    "number"
                                ]
                            }
                        },
                        "scatter_cutoff": {
                            "description": "Number of sigmas around the mean to include in the background scatter fit",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "border_width": {
                            "description": "Border Width to ignore for background fit.",
                            "type": [
                                "number",
                                "null"
                            ],
                            "minimum": 0
                        }
                    }
                }
            ]
        },
        "norm_flat": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/extraction"
                },
                {
                    "type": "object",
                    "properties": {
                        "threshold": {
                            "description": "Background level threshold, if lower than 0, it is understood as a fraction of the maximum",
                            "type": [
                                "number",
                                "integer"
                            ],
                            "exclusiveMinimum": 0
                        },
                        "threshold_lower": {
                            "description": "Lower background level threshold, after the extraction. Always absolute, by default 0.",
                            "type": "number",
                            "minimum": 0
                        }
                    }
                }
            ]
        },
        "wavecal_master": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/extraction"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                }
            ]
        },
        "wavecal_init": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "type": "object",
                    "properties": {
                        "degree": {
                            "description": "Degree of the polynomial fit for the initial guess",
                            "type": "number",
                            "minimum": 2
                        },
                        "atlas": {
                            "description": "Name of the line atlas to use for calibration (e.g. thar, une, lfc)",
                            "type": "string"
                        },
                        "medium": {
                            "description": "Medium of the detector, either air or vaccum. This affects the wavelength scale",
                            "type": "string",
                            "enum": [
                                "vac",
                                "air"
                            ]
                        },
                        "match_tolerance": {
                            "description": "Wavelength match tolerance between detected peak and atlas line in Angstrom",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "resid_delta": {
                            "description": "Maximum velocity residual for outlier rejection in m/s",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "iterations": {
                            "description": "Number of match-fit-reject iterations",
                            "type": "integer",
                            "minimum": 1
                        },
                        "edge_margin": {
                            "description": "Pixels from detector edge to reject peaks",
                            "type": "integer",
                            "minimum": 0
                        },
                        "width_min": {
                            "description": "Minimum peak FWHM in pixels",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "width_max": {
                            "description": "Maximum peak FWHM in pixels",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "smoothing": {
                            "description": "Gaussian smoothing parameter applied to the observed spectrum in pixel scale, set to 0 to disable smoothing",
                            "type": "number",
                            "minimum": 0
                        },
                        "cutoff": {
                            "description": "Minimum height of spectral lines in the normalized spectrum, values of 1 and above are interpreted as percentiles of the spectrum, set to 0 to disable the cutoff",
                            "type": "number",
                            "minimum": 0,
                            "maximum": 100
                        }
                    }
                }
            ]
        },
        "wavecal": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/polynomialfit"
                },
                {
                    "type": "object",
                    "properties": {
                        "manual": {
                            "description": "Use only manual order alignment if true. When false still allow manual alignment after automatic alignment if plot is true",
                            "type": "boolean"
                        },
                        "correlate_cols": {
                            "description": "The number of columns used for 2D cross correlation alignment. 0 means all pixels (slow).",
                            "type": "integer",
                            "minimum": 0
                        },
                        "shift_window": {
                            "description": "The fraction of the columns that each order can be shifted individually to align with the reference",
                            "type": "number",
                            "minimum": 0,
                            "maximum": 1
                        },
                        "threshold": {
                            "description": "Residual threshold in m/s above which lines will be removed from the fit",
                            "type": "number",
                            "exclusiveMinimum": 0
                        },
                        "iterations": {
                            "description": "Number of iterations in the Remove Lines, Identify Lines loop",
                            "type": "integer",
                            "minimum": 0
                        },
                        "atlas": {
                            "description": "Name of the line atlas to use for calibration (e.g. thar, une, lfc)",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "medium": {
                            "description": "Medium of the detector, either air or vaccum. This affects the wavelength scale",
                            "type": "string",
                            "enum": [
                                "vac",
                                "air"
                            ]
                        }
                    }
                }
            ]
        },
        "freq_comb_master": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/extraction"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                }
            ]
        },
        "freq_comb": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/polynomialfit"
                },
                {
                    "type": "object",
                    "properties": {
                        "lfc_peak_width": {
                            "description": "Required width of the frequency comb peaks, in the peak detection algorithm",
                            "type": [
                                "integer",
                                "null"
                            ],
                            "minimum": 1
                        },
                        "threshold": {
                            "description": "Residual threshold in m/s above which lines will be removed from the fit",
                            "type": "number",
                            "exclusiveMinimum": 0
                        }
                    }
                }
            ]
        },
        "curvature": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/polynomialfit"
                },
                {
                    "$ref": "#/definitions/bias_scaling"
                },
                {
                    "$ref": "#/definitions/extraction"
                },
                {
                    "type": "object",
                    "properties": {
                        "extraction_height": {
                            "description": "Number of rows to bin together when measuring curvature. Unlike other steps, this is always interpreted as literal pixels (no fractional conversion). If null, uses trace.height.",
                            "type": [
                                "integer",
                                "number",
                                "null"
                            ],
                            "minimum": 1
                        },
                        "curve_degree": {
                            "description": "Polynomial degree of slit curvature (1=linear, 2=quadratic, up to 5)",
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 5
                        },
                        "curve_height": {
                            "description": "Height of the 2D cutout for curvature fitting (per side). If a value under 1.5 is given it will be understood as the fractional difference to the next order.",
                            "type": [
                                "integer",
                                "number",
                                "array"
                            ],
                            "items": {
                                "type": [
                                    "integer",
                                    "number"
                                ]
                            }
                        },
                        "peak_threshold": {
                            "description": "Peak detection noise threshold. This much times * 10% noise must be the prominence of the peaks",
                            "type": "number",
                            "minimum": 0
                        },
                        "peak_width": {
                            "description": "Minimum width of the peaks in the curvature detection. Usually 1 for sharp peaks as in the wavecal, or 3 for broader peaks of the freq comb",
                            "type": [
                                "null",
                                "number",
                                "array"
                            ],
                            "minimum": 1,
                            "items": {
                                "type": "number"
                            },
                            "minItems": 2,
                            "maxItems": 2
                        },
                        "window_width": {
                            "description": "Width of the window to look for the peak of each row, within each line. The value here speciefies only on direction the window size is actually twice this +1.",
                            "type": "integer",
                            "minimum": 1
                        },
                        "peak_function": {
                            "description": "Function that is used to fit individual line peaks",
                            "type": "string",
                            "enum": [
                                "gaussian",
                                "lorentzian"
                            ]
                        }
                    }
                }
            ]
        },
        "rectify": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "type": "object",
                    "properties": {
                        "extraction_height": {
                            "description": "Total extraction height in pixels (split evenly above/below trace). Values under 2 are interpreted as fractions of order spacing. If null, uses heights computed from trace spacing.",
                            "type": [
                                "integer",
                                "number",
                                "null"
                            ],
                            "items": {
                                "type": [
                                    "integer",
                                    "number"
                                ]
                            }
                        },
                        "input_files": {
                            "description": "Which input files to rectify. Usually 'science' for the science files, but could be any other step with input files",
                            "type": "string",
                            "enum": [
                                "science",
                                "flat",
                                "bias",
                                "scatter",
                                "trace",
                                "curvature",
                                "wavecal",
                                "freq_comb"
                            ]
                        }
                    }
                }
            ]
        },
        "science": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "$ref": "#/definitions/extraction"
                }
            ]
        },
        "continuum": {
            "$ref": "#/definitions/step"
        },
        "finalize": {
            "allOf": [
                {
                    "$ref": "#/definitions/step"
                },
                {
                    "properties": {
                        "filename": {
                            "description": "Name of the output file. Can include placeholders for instrument, mode, night and observation this night",
                            "type": "string"
                        }
                    }
                }
            ]
        }
    },
    "definitions": {
        "step": {
            "type": "object",
            "properties": {
                "plot": {
                    "description": "Plot results and progress if true",
                    "type": [
                        "boolean",
                        "integer"
                    ],
                    "minimum": 0
                },
                "plot_title": {
                    "description": "Title used in the plots, if any",
                    "type": [
                        "string",
                        "null"
                    ]
                }
            }
        },
        "extraction": {
            "description": "Common settings for an extraction",
            "type": "object",
            "$comment": "There are two options for the extraction. Each has its own set of parameters that need to be present",
            "oneOf": [
                {
                    "title": "Optimal Extraction",
                    "properties": {
                        "extraction_method": {
                            "description": "The method to use for extraction",
                            "type": "string",
                            "enum": [
                                "normalize",
                                "optimal"
                            ]
                        },
                        "oversampling": {
                            "description": "Ovsersampling factor",
                            "type": "integer",
                            "minimum": 1
                        },
                        "smooth_slitfunction": {
                            "description": "Smoothing parameter for the slitfunction",
                            "type": "number",
                            "minimum": 0
                        },
                        "smooth_spectrum": {
                            "description": "Smoothing parameter for the spectrum",
                            "type": "number",
                            "minimum": 0
                        },
                        "swath_width": {
                            "description": "Approximate width of each swath. Exact width might vary slightly",
                            "type": "integer",
                            "minimum": 3
                        },
                        "extraction_height": {
                            "description": "Total extraction height in pixels (split evenly above/below trace). Values under 2 are interpreted as fractions of order spacing. If null, uses heights computed from trace spacing.",
                            "type": [
                                "integer",
                                "number",
                                "null"
                            ],
                            "items": {
                                "type": [
                                    "integer",
                                    "number"
                                ]
                            }
                        },
                        "extraction_reject": {
                            "description": "Outlier rejection threshold during optimal extraction, in units of standard deviations. Pixels deviating more than this from the model are masked. Set to 0 to disable rejection.",
                            "type": "number",
                            "minimum": 0
                        }
                    }
                },
                {
                    "title": "Simple Extraction",
                    "properties": {
                        "extraction_method": {
                            "description": "The method to use for extraction",
                            "type": "string",
                            "enum": [
                                "simple"
                            ]
                        },
                        "extraction_height": {
                            "description": "Total extraction height in pixels (split evenly above/below trace). Values under 2 are interpreted as fractions of order spacing. If null, uses heights computed from trace spacing.",
                            "type": [
                                "integer",
                                "number",
                                "null"
                            ],
                            "items": {
                                "type": [
                                    "integer",
                                    "number"
                                ]
                            }
                        },
                        "collapse_function": {
                            "description": "Function used to collapse the image into a spectrum",
                            "type": "string",
                            "enum": [
                                "sum",
                                "mean",
                                "median"
                            ]
                        }
                    }
                }
            ]
        },
        "polynomialfit": {
            "type": "object",
            "oneOf": [
                {
                    "properties": {
                        "dimensionality": {
                            "type": "string",
                            "enum": [
                                "1D"
                            ]
                        },
                        "degree": {
                            "description": "Polynomial degree in column direction",
                            "type": "integer",
                            "minimum": 0
                        }
                    }
                },
                {
                    "properties": {
                        "dimensionality": {
                            "type": "string",
                            "enum": [
                                "2D"
                            ]
                        },
                        "degree": {
                            "description": "Polynomial degree in each direction. The first element is in column direction, the second in order direction",
                            "type": "array",
                            "items": {
                                "type": "integer",
                                "minimum": 0
                            },
                            "minItems": 2,
                            "maxItems": 2
                        }
                    }
                }
            ]
        },
        "bias_scaling": {
            "type": "object",
            "properties": {
                "bias_scaling": {
                    "description": "determines how the bias is applied",
                    "type": "string",
                    "enum": [
                        "number_of_files",
                        "exposure_time",
                        "mean",
                        "median",
                        "none"
                    ]
                },
                "norm_scaling": {
                    "description": "determines how to apply the normalized flat",
                    "type": "string",
                    "enum": [
                        "divide",
                        "none"
                    ]
                }
            }
        }
    }
}
