<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.extract &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.extract</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for extracting data from observations</span>

<span class="sd">Authors</span>
<span class="sd">-------</span>

<span class="sd">Version</span>
<span class="sd">-------</span>

<span class="sd">License</span>
<span class="sd">-------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.cwrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">slitfunc_curved</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_index</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ProgressPlot">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProgressPlot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">nslitf</span><span class="p">,</span> <span class="n">nbad</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">=</span> <span class="n">nrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">ncol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nslitf</span> <span class="o">=</span> <span class="n">nslitf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nbad</span> <span class="o">=</span> <span class="n">nbad</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="c1"># self.ax1 = self.fig.add_subplot(231, projection=&quot;3d&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">231</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Swath&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;flux [arb. unit]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Slit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;contribution [1]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">))</span>
        <span class="c1"># self.ax4 = self.fig.add_subplot(234, projection=&quot;3d&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">234</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Just plot empty pictures, to create the plots</span>
        <span class="c1"># Update the data later</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
        <span class="c1"># y, x = np.indices((nrow, ncol))</span>
        <span class="c1"># self.im_obs = self.ax1.plot_surface(x, y, img)</span>
        <span class="c1"># self.im_model = self.ax4.plot_surface(x, y, img)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dots_spec</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">),</span> <span class="s2">&quot;.r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_spec</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncol</span><span class="p">),</span> <span class="s2">&quot;-k&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_spec</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">),</span> <span class="s2">&quot;Pg&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dots_slit</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">),</span> <span class="s2">&quot;.r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_slit</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrow</span><span class="p">),</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_slit</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">),</span> <span class="s2">&quot;Pg&quot;</span><span class="p">)</span>

        <span class="c1"># self.ax1.set_zscale(&quot;log&quot;)</span>
        <span class="c1"># self.ax4.set_zscale(&quot;log&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>

<div class="viewcode-block" id="ProgressPlot.fix_linear">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot.fix_linear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assures the size of the 1D array data is equal to limit&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">fill</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">padding</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ProgressPlot.plot">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ord_num</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">slitf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slitf</span><span class="p">)</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ycen</span><span class="p">)</span>

        <span class="n">ny</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nspec</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_spec</span><span class="p">,</span> <span class="n">y_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spec</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>
        <span class="n">x_slit</span><span class="p">,</span> <span class="n">y_slit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slitf</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">+</span> <span class="n">ny</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slitf</span><span class="p">))</span>

        <span class="c1"># Fix Sizes</span>
        <span class="n">mask_spec_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">x_spec</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">y_spec</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_slit_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">x_slit</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_slit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">y_slit</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbad</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">ycen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">ycen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">)</span>
        <span class="n">x_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">x_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">y_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">y_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">)</span>
        <span class="n">x_slit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">x_slit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">y_slit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">y_slit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslitf</span><span class="p">)</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_linear</span><span class="p">(</span><span class="n">slitf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslitf</span><span class="p">)</span>

        <span class="c1"># Update Data</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_obs</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># y, x = np.indices(img.shape)</span>
        <span class="c1"># self.im_obs = self.ax1.plot_surface(x, y, img)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_obs</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_obs</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">vmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_model</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="c1"># y, x = np.indices(model.shape)</span>
        <span class="c1"># self.im_model = self.ax4.plot_surface(x, y, model)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>

        <span class="c1"># self.line_ycen.set_ydata(ycen)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dots_spec</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">x_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dots_spec</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">y_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_spec</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_spec</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">mask_spec_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_spec</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">mask_spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dots_slit</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">x_slit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dots_slit</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">y_slit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_slit</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_slit</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_slit</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">mask_slit_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_slit</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">mask_slit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nspec</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>

        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">ord_num</span><span class="si">}</span><span class="s2">, Columns </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProgressPlot.close">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProgressPlot.get_spec">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot.get_spec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">ycen</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get the spectrum corrected by the slit function&quot;&quot;&quot;</span>
        <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">-</span> <span class="n">ycen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">ycen</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slitf</span><span class="p">))</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">slitf</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="n">sf</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span></div>


<div class="viewcode-block" id="ProgressPlot.get_slitf">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.ProgressPlot.get_slitf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_slitf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">ycen</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get the slit function&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">-</span> <span class="n">ycen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">[</span><span class="n">spec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">spec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span>
                <span class="p">)(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="n">spec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="n">spec</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">ycen</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>
</div>



<div class="viewcode-block" id="Swath">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.Swath">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Swath</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nswath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nswath</span> <span class="o">=</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slitf</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nswath</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slitf</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unc</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slitf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span></div>



<div class="viewcode-block" id="fix_parameters">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.fix_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_parameters</span><span class="p">(</span><span class="n">xwd</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">nord</span><span class="p">,</span> <span class="n">ignore_column_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix extraction width and column range, so that all pixels used are within the image.</span>
<span class="sd">    I.e. the column range is cut so that the everything is within the image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xwd : float, array</span>
<span class="sd">        Extraction width, either one value for all orders, or the whole array</span>
<span class="sd">    cr : 2-tuple(int), array</span>
<span class="sd">        Column range, either one value for all orders, or the whole array</span>
<span class="sd">    orders : array</span>
<span class="sd">        polynomial coefficients that describe each order</span>
<span class="sd">    nrow : int</span>
<span class="sd">        Number of rows in the image</span>
<span class="sd">    ncol : int</span>
<span class="sd">        Number of columns in the image</span>
<span class="sd">    nord : int</span>
<span class="sd">        Number of orders in the image</span>
<span class="sd">    ignore_column_range : bool, optional</span>
<span class="sd">        if true does not change the column range, however this may lead to problems with the extraction, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xwd : array</span>
<span class="sd">        fixed extraction width</span>
<span class="sd">    cr : array</span>
<span class="sd">        fixed column range</span>
<span class="sd">    orders : array</span>
<span class="sd">        the same orders as before</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">xwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xwd</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xwd</span><span class="p">):</span>
        <span class="n">xwd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="n">xwd</span><span class="p">,</span> <span class="n">xwd</span><span class="p">],</span> <span class="p">(</span><span class="n">nord</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xwd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xwd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xwd</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">xwd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xwd</span><span class="p">,</span> <span class="p">(</span><span class="n">nord</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">],</span> <span class="p">(</span><span class="n">nord</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="p">(</span><span class="n">nord</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>

    <span class="n">xwd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xwd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">xwd</span><span class="p">,</span> <span class="n">xwd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">cr</span><span class="p">,</span> <span class="n">cr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">extend_orders</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">nrow</span><span class="p">)</span>

    <span class="n">xwd</span> <span class="o">=</span> <span class="n">fix_extraction_width</span><span class="p">(</span><span class="n">xwd</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_column_range</span><span class="p">:</span>
        <span class="n">cr</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">fix_column_range</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">xwd</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>

    <span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xwd</span> <span class="o">=</span> <span class="n">xwd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">xwd</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">orders</span></div>



<div class="viewcode-block" id="extend_orders">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.extend_orders">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extend_orders</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">nrow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extrapolate extra orders above and below the existing ones</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orders : array[nord, degree]</span>
<span class="sd">        order tracing coefficients</span>
<span class="sd">    nrow : int</span>
<span class="sd">        number of rows in the image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    orders : array[nord + 2, degree]</span>
<span class="sd">        extended orders</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nord</span><span class="p">,</span> <span class="n">ncoef</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">nord</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">order_low</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">orders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">order_high</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">orders</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">orders</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order_low</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncoef</span><span class="p">)]</span>
        <span class="n">order_high</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncoef</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nrow</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">order_low</span><span class="p">,</span> <span class="o">*</span><span class="n">orders</span><span class="p">,</span> <span class="n">order_high</span><span class="p">])</span></div>



<div class="viewcode-block" id="fix_extraction_width">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.fix_extraction_width">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_extraction_width</span><span class="p">(</span><span class="n">xwd</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert fractional extraction width to pixel range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    extraction_width : array[nord, 2]</span>
<span class="sd">        current extraction width, in pixels or fractions (for values below 1.5)</span>
<span class="sd">    orders : array[nord, degree]</span>
<span class="sd">        order tracing coefficients</span>
<span class="sd">    column_range : array[nord, 2]</span>
<span class="sd">        column range to use</span>
<span class="sd">    ncol : int</span>
<span class="sd">        number of columns in image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    extraction_width : array[nord, 2]</span>
<span class="sd">        updated extraction width in pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">xwd</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">):</span>
        <span class="c1"># if extraction width is in relative scale transform to pixel scale</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xwd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">xwd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cr</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cr</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">right</span> <span class="o">&lt;</span> <span class="n">left</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Check your column ranges. Orders </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> are weird&quot;</span>
                        <span class="p">)</span>

                    <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">])</span>
                    <span class="n">below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">])</span>
                    <span class="n">xwd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">below</span><span class="p">))</span>

        <span class="n">xwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xwd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xwd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">xwd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xwd</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xwd</span></div>



<div class="viewcode-block" id="fix_column_range">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.fix_column_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_column_range</span><span class="p">(</span><span class="n">column_range</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">extraction_width</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix the column range, so that no pixels outside the image will be accessed (Thus avoiding errors)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array[nrow, ncol]</span>
<span class="sd">        image</span>
<span class="sd">    orders : array[nord, degree]</span>
<span class="sd">        order tracing coefficients</span>
<span class="sd">    extraction_width : array[nord, 2]</span>
<span class="sd">        extraction width in pixels, (below, above)</span>
<span class="sd">    column_range : array[nord, 2]</span>
<span class="sd">        current column range</span>
<span class="sd">    no_clip : bool, optional</span>
<span class="sd">        if False, new column range will be smaller or equal to current column range, otherwise it can also be larger (default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    column_range : array[nord, 2]</span>
<span class="sd">        updated column range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over non extension orders</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">orders</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Shift order trace up/down by extraction_width</span>
        <span class="n">coeff_bot</span><span class="p">,</span> <span class="n">coeff_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="n">coeff_bot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">coeff_top</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">y_bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff_bot</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>  <span class="c1"># low edge of arc</span>
        <span class="n">y_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff_top</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>  <span class="c1"># high edge of arc</span>

        <span class="c1"># find regions of pixels inside the image</span>
        <span class="c1"># then use the region that most closely resembles the existing column range (from order tracing)</span>
        <span class="c1"># but clip it to the existing column range (order tracing polynomials are not well defined outside the original range)</span>
        <span class="n">points_in_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">y_bot</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_top</span> <span class="o">&lt;</span> <span class="n">nrow</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_in_image</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># print(y_bot, y_top,nrow, ncol, points_in_image)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No pixels are completely within the extraction width for order </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, removing it.&quot;</span>
            <span class="p">)</span>
            <span class="n">to_remove</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="n">regions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">points_in_image</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">points_in_image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="o">*</span><span class="n">points_in_image</span><span class="p">[(</span><span class="n">regions</span><span class="p">,)]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">points_in_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[[</span><span class="n">regions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regions</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span>
        <span class="p">]</span>
        <span class="n">iregion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
        <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">regions</span><span class="p">[</span><span class="n">iregion</span><span class="p">],</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">column_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">column_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">column_range</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">column_range</span><span class="p">,</span> <span class="n">orders</span></div>



<div class="viewcode-block" id="make_bins">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.make_bins">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_bins</span><span class="p">(</span><span class="n">swath_width</span><span class="p">,</span> <span class="n">xlow</span><span class="p">,</span> <span class="n">xhigh</span><span class="p">,</span> <span class="n">ycen</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create bins for the swathes</span>
<span class="sd">    Bins are roughly equally sized, have roughly length swath width (if given)</span>
<span class="sd">    and overlap roughly half-half with each other</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    swath_width : {int, None}</span>
<span class="sd">        initial value for the swath_width, bins will have roughly that size, but exact value may change</span>
<span class="sd">        if swath_width is None, determine a good value, from the data</span>
<span class="sd">    xlow : int</span>
<span class="sd">        lower bound for x values</span>
<span class="sd">    xhigh : int</span>
<span class="sd">        upper bound for x values</span>
<span class="sd">    ycen : array[ncol]</span>
<span class="sd">        center of the order trace</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nbin : int</span>
<span class="sd">        number of bins</span>
<span class="sd">    bins_start : array[nbin]</span>
<span class="sd">        left(beginning) side of the bins</span>
<span class="sd">    bins_end : array[nbin]</span>
<span class="sd">        right(ending) side of the bins</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">swath_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ycen</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ycen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>  <span class="c1"># Points of row crossing</span>
        <span class="c1"># ni = len(i)  # This is how many times this order crosses to the next row</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Curved order crosses rows</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ncol</span> <span class="o">/</span> <span class="n">i</span><span class="p">))</span> <span class="o">//</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span>
            <span class="p">)</span>  <span class="c1"># number of swaths along the order</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Perfectly aligned orders</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ncol</span> <span class="o">//</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Still follow the changes in PSF</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="n">nbin</span> <span class="o">*</span> <span class="p">(</span><span class="n">xhigh</span> <span class="o">-</span> <span class="n">xlow</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncol</span>  <span class="c1"># Adjust for the true order length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">xhigh</span> <span class="o">-</span> <span class="n">xlow</span><span class="p">)</span> <span class="o">/</span> <span class="n">swath_width</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xlow</span><span class="p">,</span> <span class="n">xhigh</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nbin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># boundaries of bins</span>
    <span class="n">bins_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># beginning of each bin</span>
    <span class="n">bins_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># end of each bin</span>

    <span class="k">return</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">bins_start</span><span class="p">,</span> <span class="n">bins_end</span></div>



<div class="viewcode-block" id="calc_telluric_correction">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.calc_telluric_correction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_telluric_correction</span><span class="p">(</span><span class="n">telluric</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate telluric correction</span>

<span class="sd">    If set to specific integer larger than 1 is used as the</span>
<span class="sd">    offset from the order center line. The sky is then estimated by computing</span>
<span class="sd">    median signal between this offset and the upper/lower limit of the</span>
<span class="sd">    extraction window.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    telluric : int</span>
<span class="sd">        telluric correction parameter</span>
<span class="sd">    img : array</span>
<span class="sd">        image of the swath</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tell : array</span>
<span class="sd">        telluric correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">tel_lim</span> <span class="o">=</span> <span class="n">telluric</span> <span class="k">if</span> <span class="n">telluric</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">telluric</span> <span class="o">&lt;</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">itel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
    <span class="n">itel</span> <span class="o">=</span> <span class="n">itel</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itel</span> <span class="o">-</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">tel_lim</span><span class="p">]</span>
    <span class="n">tel</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">itel</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">itel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
        <span class="n">sc</span><span class="p">[</span><span class="n">itel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tel</span><span class="p">[</span><span class="n">itel</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sc</span></div>



<div class="viewcode-block" id="calc_scatter_correction">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.calc_scatter_correction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_scatter_correction</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate scatter correction</span>
<span class="sd">    by interpolating between values?</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scatter : array of shape (degree_x, degree_y)</span>
<span class="sd">        2D polynomial coefficients of the background scatter</span>
<span class="sd">    index : tuple (array, array)</span>
<span class="sd">        indices of the swath within the overall image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scatter_correction : array of shape (swath_width, swath_height)</span>
<span class="sd">        correction for scattered light</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The indices in the image are switched</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">index</span>
    <span class="n">scatter_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyval2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scatter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter_correction</span></div>



<div class="viewcode-block" id="extract_spectrum">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.extract_spectrum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_spectrum</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">ycen</span><span class="p">,</span>
    <span class="n">yrange</span><span class="p">,</span>
    <span class="n">xrange</span><span class="p">,</span>
    <span class="n">gain</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">readnoise</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">lambda_sf</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">lambda_sp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">osample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">swath_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">telluric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">im_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">im_ordr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_sunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_slitf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ord_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the spectrum of a single order from an image</span>
<span class="sd">    The order is split into several swathes of roughly swath_width length, which overlap half-half</span>
<span class="sd">    For each swath a spectrum and slitfunction are extracted</span>
<span class="sd">    overlapping sections are combined using linear weights (centrum is strongest, falling off to the edges)</span>
<span class="sd">    Here is the layout for the bins:</span>

<span class="sd">    ::</span>

<span class="sd">           1st swath    3rd swath    5th swath      ...</span>
<span class="sd">        /============|============|============|============|============|</span>

<span class="sd">                  2nd swath    4th swath    6th swath</span>
<span class="sd">               |------------|------------|------------|------------|</span>
<span class="sd">               |.....|</span>
<span class="sd">               overlap</span>

<span class="sd">               +     ******* 1</span>
<span class="sd">                +   *</span>
<span class="sd">                 + *</span>
<span class="sd">                  *            weights (+) previous swath, (*) current swath</span>
<span class="sd">                 * +</span>
<span class="sd">                *   +</span>
<span class="sd">               *     +++++++ 0</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array[nrow, ncol]</span>
<span class="sd">        observation (or similar)</span>
<span class="sd">    ycen : array[ncol]</span>
<span class="sd">        order trace of the current order</span>
<span class="sd">    yrange : tuple(int, int)</span>
<span class="sd">        extraction width in pixles, below and above</span>
<span class="sd">    xrange : tuple(int, int)</span>
<span class="sd">        columns range to extract (low, high)</span>
<span class="sd">    gain : float, optional</span>
<span class="sd">        adu to electron, amplifier gain (default: 1)</span>
<span class="sd">    readnoise : float, optional</span>
<span class="sd">        read out noise factor (default: 0)</span>
<span class="sd">    lambda_sf : float, optional</span>
<span class="sd">        slit function smoothing parameter, usually very small (default: 0.1)</span>
<span class="sd">    lambda_sp : int, optional</span>
<span class="sd">        spectrum smoothing parameter, usually very small (default: 0)</span>
<span class="sd">    osample : int, optional</span>
<span class="sd">        oversampling factor, i.e. how many subpixels to create per pixel (default: 1, i.e. no oversampling)</span>
<span class="sd">    swath_width : int, optional</span>
<span class="sd">        swath width suggestion, actual width depends also on ncol, see make_bins (default: None, which will determine the width based on the order tracing)</span>
<span class="sd">    telluric : {float, None}, optional</span>
<span class="sd">        telluric correction factor (default: None, i.e. no telluric correction)</span>
<span class="sd">    scatter : {array, None}, optional</span>
<span class="sd">        background scatter as 2d polynomial coefficients (default: None, no correction)</span>
<span class="sd">    normalize : bool, optional</span>
<span class="sd">        whether to create a normalized image. If true, im_norm and im_ordr are used as output (default: False)</span>
<span class="sd">    threshold : int, optional</span>
<span class="sd">        threshold for normalization (default: 0)</span>
<span class="sd">    tilt : array[ncol], optional</span>
<span class="sd">        The tilt (1st order curvature) of the slit in this order for the curved extraction (default: None, i.e. tilt = 0)</span>
<span class="sd">    shear : array[ncol], optional</span>
<span class="sd">        The shear (2nd order curvature) of the slit in this order for the curved extraction (default: None, i.e. shear = 0)</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        wether to plot the progress, plotting will slow down the procedure significantly (default: False)</span>
<span class="sd">    ord_num : int, optional</span>
<span class="sd">        current order number, just for plotting (default: 0)</span>
<span class="sd">    im_norm : array[nrow, ncol], optional</span>
<span class="sd">        normalized image, only output if normalize is True (default: None)</span>
<span class="sd">    im_ordr : array[nrow, ncol], optional</span>
<span class="sd">        image of the order blaze, only output if normalize is True (default: None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spec : array[ncol]</span>
<span class="sd">        extracted spectrum</span>
<span class="sd">    slitf : array[nslitf]</span>
<span class="sd">        extracted slitfunction</span>
<span class="sd">    mask : array[ncol]</span>
<span class="sd">        mask of the column range to use in the spectrum</span>
<span class="sd">    unc : array[ncol]</span>
<span class="sd">        uncertainty on the spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span> <span class="o">=</span> <span class="n">yrange</span>
    <span class="n">xlow</span><span class="p">,</span> <span class="n">xhigh</span> <span class="o">=</span> <span class="n">xrange</span>
    <span class="n">nslitf</span> <span class="o">=</span> <span class="n">osample</span> <span class="o">*</span> <span class="p">(</span><span class="n">ylow</span> <span class="o">+</span> <span class="n">yhigh</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">yhigh</span> <span class="o">+</span> <span class="n">ylow</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">ycen_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ycen</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_spec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out_spec</span>
    <span class="n">sunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_sunc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out_sunc</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out_mask</span>
    <span class="n">slitf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nslitf</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_slitf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out_slitf</span>

    <span class="n">nbin</span><span class="p">,</span> <span class="n">bins_start</span><span class="p">,</span> <span class="n">bins_end</span> <span class="o">=</span> <span class="n">make_bins</span><span class="p">(</span><span class="n">swath_width</span><span class="p">,</span> <span class="n">xlow</span><span class="p">,</span> <span class="n">xhigh</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>
    <span class="n">nswath</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nbin</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">swath</span> <span class="o">=</span> <span class="n">Swath</span><span class="p">(</span><span class="n">nswath</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nswath</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">norm_img</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>
        <span class="n">norm_model</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nswath</span>

    <span class="c1"># Perform slit decomposition within each swath stepping through the order with</span>
    <span class="c1"># half swath width. Spectra for each decomposition are combined with linear weights.</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bins_start</span><span class="p">,</span> <span class="n">bins_end</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bins_start</span><span class="p">),</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Swath&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ihalf</span><span class="p">,</span> <span class="p">(</span><span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Extracting Swath </span><span class="si">%i</span><span class="s2">, Columns: </span><span class="si">%i</span><span class="s2"> - </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ihalf</span><span class="p">,</span> <span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span>

            <span class="c1"># Cut out swath from image</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span><span class="n">ycen_int</span> <span class="o">-</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">ycen_int</span> <span class="o">+</span> <span class="n">yhigh</span><span class="p">,</span> <span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span>
            <span class="n">swath_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">swath_ycen</span> <span class="o">=</span> <span class="n">ycen</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>

            <span class="c1"># Corrections</span>
            <span class="c1"># TODO: what is it even supposed to do?</span>
            <span class="k">if</span> <span class="n">telluric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">telluric_correction</span> <span class="o">=</span> <span class="n">calc_telluric_correction</span><span class="p">(</span><span class="n">telluric</span><span class="p">,</span> <span class="n">swath_img</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">telluric_correction</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">scatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scatter_correction</span> <span class="o">=</span> <span class="n">calc_scatter_correction</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scatter_correction</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">swath_img</span> <span class="o">-=</span> <span class="n">scatter_correction</span> <span class="o">+</span> <span class="n">telluric_correction</span>

            <span class="c1"># Do Slitfunction extraction</span>
            <span class="n">swath_tilt</span> <span class="o">=</span> <span class="n">tilt</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span> <span class="k">if</span> <span class="n">tilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">swath_shear</span> <span class="o">=</span> <span class="n">shear</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span> <span class="k">if</span> <span class="n">shear</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">swath</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]</span> <span class="o">=</span> <span class="n">slitfunc_curved</span><span class="p">(</span>
                <span class="n">swath_img</span><span class="p">,</span>
                <span class="n">swath_ycen</span><span class="p">,</span>
                <span class="n">swath_tilt</span><span class="p">,</span>
                <span class="n">swath_shear</span><span class="p">,</span>
                <span class="n">lambda_sp</span><span class="o">=</span><span class="n">lambda_sp</span><span class="p">,</span>
                <span class="n">lambda_sf</span><span class="o">=</span><span class="n">lambda_sf</span><span class="p">,</span>
                <span class="n">osample</span><span class="o">=</span><span class="n">osample</span><span class="p">,</span>
                <span class="n">yrange</span><span class="o">=</span><span class="n">yrange</span><span class="p">,</span>
                <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">chi</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swath</span><span class="p">[</span><span class="n">ihalf</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">1.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="c1"># Save image and model for later</span>
                <span class="c1"># Use np.divide to avoid divisions by zero</span>
                <span class="n">where</span> <span class="o">=</span> <span class="n">swath</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="o">/</span> <span class="n">gain</span>
                <span class="n">norm_img</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">swath</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">])</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">swath_img</span><span class="p">),</span>
                    <span class="n">swath</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                    <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">norm_img</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">norm_model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]</span> <span class="o">=</span> <span class="n">swath</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">swath_img</span><span class="p">)):</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressPlot</span><span class="p">(</span>
                        <span class="n">swath_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">swath_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nslitf</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span>
                    <span class="p">)</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">swath_img</span><span class="p">,</span>
                    <span class="n">swath</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                    <span class="n">swath</span><span class="o">.</span><span class="n">slitf</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                    <span class="n">swath</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                    <span class="n">swath_ycen</span><span class="p">,</span>
                    <span class="n">swath</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ihalf</span><span class="p">],</span>
                    <span class="n">ord_num</span><span class="p">,</span>
                    <span class="n">ibeg</span><span class="p">,</span>
                    <span class="n">iend</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># Remove points at the border of the each swath, if order has tilt</span>
    <span class="c1"># as those pixels have bad information</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nswath</span><span class="p">):</span>
        <span class="n">margin</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">swath</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Weight for combining swaths</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">bins_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_start</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nswath</span><span class="p">)]</span>
    <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span> <span class="n">margin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">weight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">margin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nswath</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nswath</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">bins_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">bins_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># Start and end indices for the two swaths</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">overlap</span> <span class="o">+</span> <span class="n">margin</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">end_i</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">margin</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">start_j</span> <span class="o">=</span> <span class="n">margin</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">end_j</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">-</span> <span class="n">margin</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Weights for one overlap from 0 to 1, but do not include those values (whats the point?)</span>
        <span class="n">triangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># Cut away the margins at the corners</span>
        <span class="n">triangle</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="n">margin</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangle</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Set values</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">start_i</span><span class="p">:</span><span class="n">end_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">triangle</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">start_j</span><span class="p">:</span><span class="n">end_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">triangle</span>

        <span class="c1"># Don&#39;t use the pixels at the egdes (due to curvature)</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">end_i</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="n">start_j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Update column range</span>
    <span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">margin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">xrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">margin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">mask</span><span class="p">[:</span> <span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">xrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Apply weights</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bins_start</span><span class="p">,</span> <span class="n">bins_end</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
        <span class="n">spec</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">swath</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sunc</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">swath</span><span class="o">.</span><span class="n">unc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bins_start</span><span class="p">,</span> <span class="n">bins_end</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span><span class="n">ycen_int</span> <span class="o">-</span> <span class="n">ylow</span><span class="p">,</span> <span class="n">ycen_int</span> <span class="o">+</span> <span class="n">yhigh</span><span class="p">,</span> <span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span>
            <span class="n">im_norm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">norm_img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">im_ordr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">norm_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">slitf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">swath</span><span class="o">.</span><span class="n">slitf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sunc</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sunc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">readnoise</span> <span class="o">/</span> <span class="n">gain</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">sunc</span></div>



<div class="viewcode-block" id="model">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">spec</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">slitf</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_y_scale">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.get_y_scale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_y_scale</span><span class="p">(</span><span class="n">ycen</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">extraction_width</span><span class="p">,</span> <span class="n">nrow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the y limits of the order</span>
<span class="sd">    This is especially important at the edges</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ycen : array[ncol]</span>
<span class="sd">        order trace</span>
<span class="sd">    xrange : tuple(int, int)</span>
<span class="sd">        column range</span>
<span class="sd">    extraction_width : tuple(int, int)</span>
<span class="sd">        extraction width in pixels below and above the order</span>
<span class="sd">    nrow : int</span>
<span class="sd">        number of rows in the image, defines upper edge</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_low, y_high : int, int</span>
<span class="sd">        lower and upper y bound for extraction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ycen</span> <span class="o">=</span> <span class="n">ycen</span><span class="p">[</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">xrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">-</span> <span class="n">extraction_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>  <span class="c1"># help for orders at edge</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nrow</span><span class="p">:</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span> <span class="o">+</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># helps at edge</span>

    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">+</span> <span class="n">extraction_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nrow</span><span class="p">:</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span> <span class="o">+</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># helps at edge</span>

    <span class="c1"># Define a fixed height area containing one spectral order</span>
    <span class="n">y_lower_lim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ycen</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">))</span>  <span class="c1"># Pixels below center line</span>
    <span class="n">y_upper_lim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ycen</span><span class="p">))</span>  <span class="c1"># Pixels above center line</span>

    <span class="k">return</span> <span class="n">y_lower_lim</span><span class="p">,</span> <span class="n">y_upper_lim</span></div>



<div class="viewcode-block" id="optimal_extraction">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.optimal_extraction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">optimal_extraction</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">orders</span><span class="p">,</span>
    <span class="n">extraction_width</span><span class="p">,</span>
    <span class="n">column_range</span><span class="p">,</span>
    <span class="n">tilt</span><span class="p">,</span>
    <span class="n">shear</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use optimal extraction to get spectra</span>

<span class="sd">    This functions just loops over the orders, the actual work is done in extract_spectrum</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array[nrow, ncol]</span>
<span class="sd">        image to extract</span>
<span class="sd">    orders : array[nord, degree]</span>
<span class="sd">        order tracing coefficients</span>
<span class="sd">    extraction_width : array[nord, 2]</span>
<span class="sd">        extraction width in pixels</span>
<span class="sd">    column_range : array[nord, 2]</span>
<span class="sd">        column range to use</span>
<span class="sd">    scatter : array[nord, 4, ncol]</span>
<span class="sd">        background scatter (or None)</span>
<span class="sd">    **kwargs</span>
<span class="sd">        other parameters for the extraction (see extract_spectrum)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectrum : array[nord, ncol]</span>
<span class="sd">        extracted spectrum</span>
<span class="sd">    slitfunction : array[nord, nslitf]</span>
<span class="sd">        recovered slitfunction</span>
<span class="sd">    uncertainties: array[nord, ncol]</span>
<span class="sd">        uncertainties on the spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using optimal extraction to produce spectrum&quot;</span><span class="p">)</span>

    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
    <span class="n">slitfunction</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">tilt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">shear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">)]</span>

    <span class="c1"># Add mask as defined by column ranges</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">):</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uncertainties</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">ncol_swath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;swath_width&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">400</span><span class="p">)</span>
        <span class="n">nrow_swath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_width</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">nslitf_swath</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrow_swath</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;osample&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressPlot</span><span class="p">(</span><span class="n">nrow_swath</span><span class="p">,</span> <span class="n">ncol_swath</span><span class="p">,</span> <span class="n">nslitf_swath</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Order&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Extracting relative order </span><span class="si">%i</span><span class="s2"> out of </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nord</span><span class="p">)</span>

        <span class="c1"># Define a fixed height area containing one spectral order</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">yrange</span> <span class="o">=</span> <span class="n">get_y_scale</span><span class="p">(</span><span class="n">ycen</span><span class="p">,</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrow</span><span class="p">)</span>

        <span class="n">osample</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;osample&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">slitfunction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">osample</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">yrange</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Return values are set by reference, as the out parameters</span>
        <span class="c1"># Also column_range is adjusted depending on the shear</span>
        <span class="c1"># This is to avoid large chunks of memory of essentially duplicates</span>
        <span class="n">extract_spectrum</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">ycen</span><span class="p">,</span>
            <span class="n">yrange</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">out_spec</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">out_sunc</span><span class="o">=</span><span class="n">uncertainties</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">out_slitf</span><span class="o">=</span><span class="n">slitfunction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">out_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="n">ord_num</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">plot_comparison</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">spectrum</span><span class="p">,</span>
            <span class="n">slitfunction</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">slitfunction</span><span class="p">,</span> <span class="n">uncertainties</span></div>



<div class="viewcode-block" id="correct_for_curvature">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.correct_for_curvature">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">correct_for_curvature</span><span class="p">(</span><span class="n">img_order</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">xwd</span><span class="p">):</span>
    <span class="c1"># img_order = np.ma.filled(img_order, np.nan)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">img_order</span><span class="p">)</span>

    <span class="n">xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">yt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">xwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">xwd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">xt</span> <span class="o">+</span> <span class="n">yt</span> <span class="o">*</span> <span class="n">tilt</span> <span class="o">+</span> <span class="n">yt</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">shear</span>
        <span class="n">img_order</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">xt</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="n">y</span><span class="p">]],</span> <span class="n">img_order</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">mask</span><span class="p">[</span><span class="n">y</span><span class="p">]],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="n">xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">img_order</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">xt</span><span class="p">,</span> <span class="n">xt</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]],</span> <span class="n">img_order</span><span class="p">[:,</span> <span class="n">x</span><span class="p">][</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">img_order</span></div>



<div class="viewcode-block" id="model_image">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.model_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">xwd</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span>
    <span class="c1"># Correct image for curvature</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">correct_for_curvature</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">xwd</span><span class="p">)</span>
    <span class="c1"># Find slitfunction using the median to avoid outliers</span>
    <span class="n">slitf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">slitf</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">slitf</span><span class="p">)</span>
    <span class="c1"># Use the slitfunction to find spectrum</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span> <span class="o">/</span> <span class="n">slitf</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Create model from slitfunction and spectrum</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">slitf</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># Reapply curvature to the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">correct_for_curvature</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">-</span><span class="n">tilt</span><span class="p">,</span> <span class="o">-</span><span class="n">shear</span><span class="p">,</span> <span class="n">xwd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">slitf</span></div>



<div class="viewcode-block" id="get_mask">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.get_mask">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="c1"># 99.73 = 3 sigma, 2 * 3 = 6 sigma</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">median</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">residual</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mf">99.73</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">residual</span> <span class="o">&gt;</span> <span class="n">vmax</span></div>



<div class="viewcode-block" id="arc_extraction">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.arc_extraction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">arc_extraction</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">orders</span><span class="p">,</span>
    <span class="n">extraction_width</span><span class="p">,</span>
    <span class="n">column_range</span><span class="p">,</span>
    <span class="n">gain</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">readnoise</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">dark</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">collapse_function</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use &quot;simple&quot; arc extraction to get a spectrum</span>
<span class="sd">    Arc extraction simply takes the sum orthogonal to the order for extraction width pixels</span>

<span class="sd">    This extraction makes a few rough assumptions and does not provide the most accurate results,</span>
<span class="sd">    but rather a good approximation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array[nrow, ncol]</span>
<span class="sd">        image to extract</span>
<span class="sd">    orders : array[nord, order]</span>
<span class="sd">        order tracing coefficients</span>
<span class="sd">    extraction_width : array[nord, 2]</span>
<span class="sd">        extraction width in pixels</span>
<span class="sd">    column_range : array[nord, 2]</span>
<span class="sd">        column range to use</span>
<span class="sd">    gain : float, optional</span>
<span class="sd">        adu to electron, amplifier gain (default: 1)</span>
<span class="sd">    readnoise : float, optional</span>
<span class="sd">        read out noise (default: 0)</span>
<span class="sd">    dark : float, optional</span>
<span class="sd">        dark current noise (default: 0)</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        wether to plot the results (default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectrum : array[nord, ncol]</span>
<span class="sd">        extracted spectrum</span>
<span class="sd">    uncertainties : array[nord, ncol]</span>
<span class="sd">        uncertainties on extracted spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using arc extraction to produce spectrum&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nord</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>

    <span class="c1"># Add mask as defined by column ranges</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">):</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uncertainties</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Order&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating order </span><span class="si">%i</span><span class="s2"> out of </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nord</span><span class="p">)</span>

        <span class="n">x_left_lim</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">x_right_lim</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Rectify the image, i.e. remove the shape of the order</span>
        <span class="c1"># Then the center of the order is within one pixel variations</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">yb</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">-</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ycen</span> <span class="o">+</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span><span class="n">yb</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">x_left_lim</span><span class="p">,</span> <span class="n">x_right_lim</span><span class="p">)</span>
        <span class="n">img_order</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Correct for tilt and shear</span>
        <span class="c1"># For each row of the rectified order, interpolate onto the shifted row</span>
        <span class="c1"># Masked pixels are set to 0, similar to the summation</span>
        <span class="k">if</span> <span class="n">tilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shear</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img_order</span> <span class="o">=</span> <span class="n">correct_for_curvature</span><span class="p">(</span>
                <span class="n">img_order</span><span class="p">,</span>
                <span class="n">tilt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x_left_lim</span><span class="p">:</span><span class="n">x_right_lim</span><span class="p">],</span>
                <span class="n">shear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x_left_lim</span><span class="p">:</span><span class="n">x_right_lim</span><span class="p">],</span>
                <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Sum over the prepared image</span>
        <span class="k">if</span> <span class="n">collapse_function</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img_order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">collapse_function</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">collapse_function</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img_order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine the arc method, expected one of (&#39;sum&#39;, &#39;mean&#39;, &#39;median&#39;), but got </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">collapse_function</span>
            <span class="p">)</span>

        <span class="c1"># Store results</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x_left_lim</span><span class="p">:</span><span class="n">x_right_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc</span>
        <span class="n">uncertainties</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x_left_lim</span><span class="p">:</span><span class="n">x_right_lim</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arc</span> <span class="o">*</span> <span class="n">gain</span> <span class="o">+</span> <span class="n">dark</span> <span class="o">+</span> <span class="n">readnoise</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">gain</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">plot_comparison</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">spectrum</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">uncertainties</span></div>



<div class="viewcode-block" id="plot_comparison">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.plot_comparison">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_comparison</span><span class="p">(</span>
    <span class="n">original</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">slitf</span><span class="p">,</span> <span class="n">extraction_width</span><span class="p">,</span> <span class="n">column_range</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">nord</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">):</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">-</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">yt</span> <span class="o">=</span> <span class="n">ycen</span> <span class="o">+</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span><span class="n">yb</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">)</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">]</span> <span class="o">=</span> <span class="n">original</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">],</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">))</span>
        <span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">],</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">]</span> <span class="o">-=</span> <span class="n">vmin</span>
        <span class="n">output</span><span class="p">[</span><span class="n">yl</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span><span class="n">xr</span><span class="p">]</span> <span class="o">/=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span>

        <span class="n">pos</span> <span class="o">+=</span> <span class="p">[</span><span class="n">yr</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">column_range</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># if len(tmp)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">vmin</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tmp</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_width</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">locs</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">locs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">locs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">)))</span>

    <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;Extracted Spectrum vs. Rectified Image&quot;</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">plot_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="extract">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.extract.extract">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">orders</span><span class="p">,</span>
    <span class="n">column_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">order_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extraction_width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">extraction_type</span><span class="o">=</span><span class="s2">&quot;optimal&quot;</span><span class="p">,</span>
    <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sigma_cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the spectrum from an image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array[nrow, ncol](float)</span>
<span class="sd">        observation to extract</span>
<span class="sd">    orders : array[nord, degree](float)</span>
<span class="sd">        polynomial coefficients of the order tracing</span>
<span class="sd">    column_range : array[nord, 2](int), optional</span>
<span class="sd">        range of pixels to use for each order (default: use all)</span>
<span class="sd">    order_range : array[2](int), optional</span>
<span class="sd">        range of orders to extract, orders have to be consecutive (default: use all)</span>
<span class="sd">    extraction_width : array[nord, 2]({float, int}), optional</span>
<span class="sd">        extraction width above and below each order, values below 1.5 are considered relative, while values above are absolute (default: 0.5)</span>
<span class="sd">    extraction_type : {&quot;optimal&quot;, &quot;arc&quot;, &quot;normalize&quot;}, optional</span>
<span class="sd">        which extracttion algorithm to use, &quot;optimal&quot; uses optimal extraction, &quot;arc&quot; uses simple arc extraction, and &quot;normalize&quot; also uses optimal extraction, but returns the normalized image (default: &quot;optimal&quot;)</span>
<span class="sd">    tilt : float or array[nord, ncol], optional</span>
<span class="sd">        The tilt (1st order curvature) of the slit for curved extraction. Will use vertical extraction if no tilt is set. (default: None, i.e. tilt = 0)</span>
<span class="sd">    shear : float or array[nord, ncol], optional</span>
<span class="sd">        The shear (2nd order curvature) of the slit for curved extraction (default: None, i.e. shear = 0)</span>
<span class="sd">    polarization : bool, optional</span>
<span class="sd">        if true, pairs of orders are considered to belong to the same order, but different polarization. Only affects the scatter (default: False)</span>
<span class="sd">    **kwargs, optional</span>
<span class="sd">        parameters for extraction functions</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spec : array[nord, ncol](float)</span>
<span class="sd">        extracted spectrum for each order</span>
<span class="sd">    uncertainties : array[nord, ncol](float)</span>
<span class="sd">        uncertainties on the spectrum</span>

<span class="sd">    if extraction_type == &quot;normalize&quot; instead return</span>

<span class="sd">    im_norm : array[nrow, ncol](float)</span>
<span class="sd">        normalized image</span>
<span class="sd">    im_ordr : array[nrow, ncol](float)</span>
<span class="sd">        image with just the orders</span>
<span class="sd">    blaze : array[nord, ncol](float)</span>
<span class="sd">        extracted spectrum (equals blaze if img was the flat field)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nord</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">order_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nord</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">tilt</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">tilt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">shear</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">shear</span><span class="p">)</span>

    <span class="c1"># Fix the input parameters</span>
    <span class="n">extraction_width</span><span class="p">,</span> <span class="n">column_range</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">fix_parameters</span><span class="p">(</span>
        <span class="n">extraction_width</span><span class="p">,</span> <span class="n">column_range</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">nord</span>
    <span class="p">)</span>
    <span class="c1"># Limit orders (and related properties) to orders in range</span>
    <span class="n">nord</span> <span class="o">=</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">column_range</span> <span class="o">=</span> <span class="n">column_range</span><span class="p">[</span><span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">extraction_width</span> <span class="o">=</span> <span class="n">extraction_width</span><span class="p">[</span><span class="n">order_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">order_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># if sigma_cutoff &gt; 0:</span>
    <span class="c1">#     # Blur the image and mask outliers</span>
    <span class="c1">#     img = np.ma.masked_invalid(img, copy=False)</span>
    <span class="c1">#     img.data[img.mask] = 0</span>
    <span class="c1">#     # Use the median of the sorounding pixels (excluding the pixel itself)</span>
    <span class="c1">#     footprint = np.array([[1, 1, 1], [1, 0, 1], [1, 1, 1]])</span>
    <span class="c1">#     dilated = median_filter(img, footprint=footprint)</span>
    <span class="c1">#     diff = np.ma.abs(img - dilated)</span>
    <span class="c1">#     # median = 50%; 3 sigma = 99.73 %</span>
    <span class="c1">#     median, std = np.percentile(diff.compressed(), (50, 99.73))</span>
    <span class="c1">#     mask = diff &gt; median + sigma_cutoff * std / 3</span>
    <span class="c1">#     img[mask] = np.ma.masked</span>

    <span class="k">if</span> <span class="n">extraction_type</span> <span class="o">==</span> <span class="s2">&quot;optimal&quot;</span><span class="p">:</span>
        <span class="c1"># the &quot;normal&quot; case, except for wavelength calibration files</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">slitfunction</span><span class="p">,</span> <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">optimal_extraction</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">extraction_type</span> <span class="o">==</span> <span class="s2">&quot;normalize&quot;</span><span class="p">:</span>
        <span class="c1"># TODO</span>
        <span class="c1"># Prepare normalized flat field image if necessary</span>
        <span class="c1"># These will be passed and &quot;returned&quot; by reference</span>
        <span class="c1"># I dont like it, but it works for now</span>
        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">im_ordr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">blaze</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimal_extraction</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">im_norm</span><span class="o">=</span><span class="n">im_norm</span><span class="p">,</span>
            <span class="n">im_ordr</span><span class="o">=</span><span class="n">im_ordr</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">threshold_lower</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold_lower&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">im_norm</span><span class="p">[</span><span class="n">im_norm</span> <span class="o">&lt;=</span> <span class="n">threshold_lower</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">im_ordr</span><span class="p">[</span><span class="n">im_ordr</span> <span class="o">&lt;=</span> <span class="n">threshold_lower</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">im_norm</span><span class="p">,</span> <span class="n">im_ordr</span><span class="p">,</span> <span class="n">blaze</span><span class="p">,</span> <span class="n">column_range</span>
    <span class="k">elif</span> <span class="n">extraction_type</span> <span class="o">==</span> <span class="s2">&quot;arc&quot;</span><span class="p">:</span>
        <span class="c1"># Simpler extraction, just summing along the arc of the order</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">arc_extraction</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">column_range</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">slitfunction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Parameter &#39;extraction_type&#39; not understood. Expected &#39;optimal&#39;, &#39;normalize&#39;, or &#39;arc&#39; bug got </span><span class="si">{</span><span class="n">extraction_type</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">uncertainties</span><span class="p">,</span> <span class="n">slitfunction</span><span class="p">,</span> <span class="n">column_range</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>