<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.wavelength_calibration &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.wavelength_calibration</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Wavelength Calibration</span>
<span class="sd">by comparison to a reference spectrum</span>
<span class="sd">Loosely bases on the IDL wavecal function</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">corner</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">emcee</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.polynomial.polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polynomial</span><span class="p">,</span> <span class="n">polyval2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">speed_of_light</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage.morphology</span><span class="w"> </span><span class="kn">import</span> <span class="n">grey_closing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="polyfit">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.polyfit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">coef</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">coef</span></div>



<div class="viewcode-block" id="AlignmentPlot">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.AlignmentPlot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AlignmentPlot</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a plot which can be clicked to align the two spectra, reference and observed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLUE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">order_first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_first</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_ref_image</span><span class="p">()</span>

<div class="viewcode-block" id="AlignmentPlot.make_ref_image">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.AlignmentPlot.make_ref_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_ref_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;create and show the reference plot, with the two spectra&quot;&quot;&quot;</span>
        <span class="n">ref_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
            <span class="n">ref_image</span><span class="p">[</span><span class="n">iord</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RED</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">iord</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">iord</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iord</span><span class="p">]:</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;xfirst&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;xlast&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">iord</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">ref_image</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GREEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">10</span>
                        <span class="o">*</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">signal</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="n">ref_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ref_image</span><span class="p">[</span><span class="n">ref_image</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">ref_image</span><span class="p">,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nord</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Alignment, Observed: RED, Reference: GREEN</span><span class="se">\n</span><span class="s2">Green should be above red!&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Order&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="AlignmentPlot.connect">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.AlignmentPlot.connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connect the click event with the appropiate function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cidclick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span>
            <span class="s2">&quot;button_press_event&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_click</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AlignmentPlot.on_click">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.AlignmentPlot.on_click">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;On click offset the reference by the distance between click positions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;ref&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span> <span class="o">-</span> <span class="n">order</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;obs&quot;</span>  <span class="c1"># if True then reference</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Order: </span><span class="si">%i</span><span class="s2">, Spectrum: </span><span class="si">%s</span><span class="s2">, x: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span> <span class="k">if</span> <span class="n">spec</span> <span class="k">else</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

        <span class="c1"># on every second click</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_first</span> <span class="o">=</span> <span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_first</span> <span class="o">=</span> <span class="n">spec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_first</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Clicked different spectra</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_first</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">offset_orders</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_first</span><span class="p">)</span> <span class="o">*</span> <span class="n">direction</span>
                <span class="n">offset_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_first</span><span class="p">)</span> <span class="o">*</span> <span class="n">direction</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">offset_orders</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">offset_x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_ref_image</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="LineAtlas">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineAtlas">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LineAtlas</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="s2">&quot;vac&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;wavecal/atlas&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If a specific linelist file is provided</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_list.txt&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;wavecal/atlas&quot;</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">)</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;f8,U8&quot;</span><span class="p">)</span>
            <span class="n">wpos</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;f0&quot;</span><span class="p">],</span> <span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">wpos</span><span class="p">)</span>
            <span class="n">heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span>
                <span class="p">[</span><span class="n">wpos</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">element</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">,</span> <span class="s2">&quot;heights&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="c1"># Otherwise fit the line positions from the spectrum</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No dedicated linelist found for </span><span class="si">%s</span><span class="s2">, determining peaks based on the reference spectrum instead.&quot;</span><span class="p">,</span>
                <span class="n">element</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">WavelengthCalibration</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">peaks</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">_find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wpos</span><span class="p">),</span> <span class="n">element</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">wpos</span><span class="p">)</span>
            <span class="n">heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span>
                <span class="p">[</span><span class="n">wpos</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">element</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">,</span> <span class="s2">&quot;heights&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># The data files are in vaccuum, if the instrument is in air, we need to convert</span>
        <span class="k">if</span> <span class="n">medium</span> <span class="o">==</span> <span class="s2">&quot;air&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">vac2air</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">vac2air</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="LineAtlas.load_fits">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineAtlas.load_fits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Its just the spectrum</span>
                <span class="c1"># with the wavelength defined via the header keywords</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">wmin</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span>
                <span class="n">wdel</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span>
                <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wmin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Its a binary Table, with two columns for the wavelength and the</span>
                <span class="c1"># spectrum</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">wave</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span>

        <span class="n">spec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wave</span><span class="p">,</span> <span class="n">spec</span></div>
</div>



<div class="viewcode-block" id="LineList">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LineList</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">record</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="p">((</span><span class="s2">&quot;wlc&quot;</span><span class="p">,</span> <span class="s2">&quot;WLC&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># Wavelength (before fit)</span>
                <span class="p">((</span><span class="s2">&quot;wll&quot;</span><span class="p">,</span> <span class="s2">&quot;WLL&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># Wavelength (after fit)</span>
                <span class="p">((</span><span class="s2">&quot;posc&quot;</span><span class="p">,</span> <span class="s2">&quot;POSC&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># Pixel Position (before fit)</span>
                <span class="p">((</span><span class="s2">&quot;posm&quot;</span><span class="p">,</span> <span class="s2">&quot;POSM&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># Pixel Position (after fit)</span>
                <span class="p">((</span><span class="s2">&quot;xfirst&quot;</span><span class="p">,</span> <span class="s2">&quot;XFIRST&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;i2&quot;</span><span class="p">),</span>  <span class="c1"># first pixel of the line</span>
                <span class="p">((</span><span class="s2">&quot;xlast&quot;</span><span class="p">,</span> <span class="s2">&quot;XLAST&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;i2&quot;</span><span class="p">),</span>  <span class="c1"># last pixel of the line</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;approx&quot;</span><span class="p">,</span> <span class="s2">&quot;APPROX&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;O&quot;</span><span class="p">,</span>
                <span class="p">),</span>  <span class="c1"># Not used. Describes the shape used to approximate the line. &quot;G&quot; for Gaussian</span>
                <span class="p">((</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;WIDTH&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># width of the line in pixels</span>
                <span class="p">((</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;HEIGHT&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;f8&quot;</span><span class="p">),</span>  <span class="c1"># relative strength of the line</span>
                <span class="p">((</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;ORDER&quot;</span><span class="p">),</span> <span class="s2">&quot;&gt;i2&quot;</span><span class="p">),</span>  <span class="c1"># echelle order the line is found in</span>
                <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">),</span>  <span class="c1"># flag that tells us if we should use the line or not</span>
            <span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="LineList.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cs_lines&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">linelist</span></div>


<div class="viewcode-block" id="LineList.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cs_lines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="LineList.append">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList.append">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linelist</span><span class="p">,</span> <span class="n">LineList</span><span class="p">):</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">linelist</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">linelist</span><span class="p">)</span></div>


<div class="viewcode-block" id="LineList.add_line">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList.add_line">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span><span class="n">wave</span><span class="p">],</span> <span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="p">[</span><span class="n">width</span><span class="p">],</span> <span class="p">[</span><span class="n">height</span><span class="p">],</span> <span class="p">[</span><span class="n">flag</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="LineList.from_list">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.LineList.from_list">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">wi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">wi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">wave</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibration">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wavelength Calibration Module</span>

<span class="sd">    Takes an observed wavelength image and the reference linelist</span>
<span class="sd">    and returns the wavelength at each pixel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">degree</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">dimensionality</span><span class="o">=</span><span class="s2">&quot;2D&quot;</span><span class="p">,</span>
        <span class="n">nstep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">correlate_cols</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">shift_window</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">manual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">polarim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lfc_peak_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">closing</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">medium</span><span class="o">=</span><span class="s2">&quot;vac&quot;</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1">#:float: Residual threshold in m/s above which to remove lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="c1">#:tuple(int, int): polynomial degree of the wavelength fit in (pixel, order) direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1">#:int: Number of iterations in the remove residuals, auto id, loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>
        <span class="c1">#:{&quot;1D&quot;, &quot;2D&quot;}: Whether to use 1d or 2d fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">=</span> <span class="n">dimensionality</span>
        <span class="c1">#:bool: Whether to fit for pixel steps (offsets) in the detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep</span>
        <span class="c1">#:int: How many columns to use in the 2D cross correlation alignment. 0 means all pixels (slow).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span> <span class="o">=</span> <span class="n">correlate_cols</span>
        <span class="c1">#:float: Fraction if the number of columns to use in the alignment of individual orders. Set to 0 to disable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_window</span> <span class="o">=</span> <span class="n">shift_window</span>
        <span class="c1">#:bool: Whether to manually align the reference instead of using cross correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">manual</span>
        <span class="c1">#:bool: Whether to use polarimetric orders instead of the usual ones. I.e. Each pair of two orders represents the same data. Not Supported yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarim</span> <span class="o">=</span> <span class="n">polarim</span>
        <span class="c1">#:int: Whether to plot the results. Set to 2 to plot during all steps.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span>
        <span class="c1">#:str: Elements used in the wavelength calibration. Used in AutoId to find more lines from the Atlas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="c1">#:str: Medium of the detector, vac or air</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="c1">#:int: Laser Frequency Peak width (for scipy.signal.find_peaks)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lfc_peak_width</span> <span class="o">=</span> <span class="n">lfc_peak_width</span>
        <span class="c1">#:int: grey closing range for the input image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1">#:int: Number of orders in the observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nord</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:int: Number of columns in the observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstep</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;{&quot;1D&quot;, &quot;2D&quot;}: Whether to use 1D or 2D polynomials for the wavelength solution&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimensionality</span>

    <span class="nd">@dimensionality</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">accepted_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1D&quot;</span><span class="p">,</span> <span class="s2">&quot;2D&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">accepted_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimensionality</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value for &#39;dimensionality&#39; not understood. Expected one of </span><span class="si">{</span><span class="n">accepted_values</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> instead&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="WavelengthCalibration.normalize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.normalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize the observation and reference list in each order individually</span>
<span class="sd">        Copies the data if the image, but not of the linelist</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            observed image</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            reference linelist</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            normalized image</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            normalized reference linelist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># normalize order by order</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">grey_closing</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">closing</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not determine the minimum value in order </span><span class="si">%i</span><span class="s2">. No positive values found&quot;</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Remove negative outliers</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="c1"># obs[obs &lt;= 0] = np.ma.masked</span>

        <span class="c1"># Normalize lines in each order</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]):</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span>
            <span class="n">topheight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">select</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">])</span>
            <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">/=</span> <span class="n">topheight</span>

        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.create_image_from_lines">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.create_image_from_lines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_image_from_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a reference image based on a line list</span>
<span class="sd">        Each line will be approximated by a Gaussian</span>
<span class="sd">        Space inbetween lines is 0</span>
<span class="sd">        The number of orders is from 0 to the maximum order</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            line data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : array of shape (nord, ncol)</span>
<span class="sd">            New reference image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]))</span>
        <span class="n">max_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_order</span> <span class="o">-</span> <span class="n">min_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;xlast&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;xfirst&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;xfirst&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;xlast&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
            <span class="n">img</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_order</span><span class="p">,</span> <span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span>
                <span class="s2">&quot;height&quot;</span>
            <span class="p">]</span> <span class="o">*</span> <span class="n">signal</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="WavelengthCalibration.align_manual">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.align_manual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open an AlignmentPlot window for manual selection of the alignment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            observed image</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            reference linelist</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        offset : tuple(int, int)</span>
<span class="sd">            offset in order and column to be applied to each line in the linelist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">AlignmentPlot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">)</span>
        <span class="n">ap</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">return</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="WavelengthCalibration.apply_alignment_offset">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.apply_alignment_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_alignment_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply an offset to the linelist</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            reference linelist</span>
<span class="sd">        offset : tuple(int, int)</span>
<span class="sd">            offset in (order, column)</span>
<span class="sd">        select : array of shape(nlines,), optional</span>
<span class="sd">            Mask that defines which lines the offset applies to</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            linelist with offset applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;xfirst&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;xlast&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.align">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.align">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align the observation with the reference spectrum</span>
<span class="sd">        Either automatically using cross correlation or manually (visually)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array[nrow, ncol]</span>
<span class="sd">            observed wavelength calibration spectrum (e.g. obs=ThoriumArgon)</span>
<span class="sd">        lines : struct_array</span>
<span class="sd">            reference line data</span>
<span class="sd">        manual : bool, optional</span>
<span class="sd">            wether to manually align the spectra (default: False)</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            wether to plot the alignment (default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        offset: tuple(int, int)</span>
<span class="sd">            offset in order and column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
            <span class="c1"># make image from lines</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_image_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="c1"># Crop the image to speed up cross correlation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ccimg</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">_slice</span><span class="p">]</span>
                <span class="n">ccobs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">_slice</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccimg</span><span class="p">,</span> <span class="n">ccobs</span> <span class="o">=</span> <span class="n">img</span><span class="p">,</span> <span class="n">obs</span>

            <span class="c1"># Cross correlate with obs image</span>
            <span class="c1"># And determine overall offset</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate2d</span><span class="p">(</span><span class="n">ccobs</span><span class="p">,</span> <span class="n">ccimg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
            <span class="n">offset_order</span><span class="p">,</span> <span class="n">offset_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">correlation</span><span class="p">),</span> <span class="n">correlation</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">correlation</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">offset_x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">correlation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">offset_order</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">correlation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">offset_order</span> <span class="o">=</span> <span class="n">offset_order</span> <span class="o">-</span> <span class="n">ccimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">offset_x</span> <span class="o">=</span> <span class="n">offset_x</span> <span class="o">-</span> <span class="n">ccimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">offset_order</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_x</span><span class="p">)]</span>

            <span class="c1"># apply offset</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alignment_offset</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_window</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Shift individual orders to fit reference</span>
                <span class="c1"># Only allow a small shift here (1%) ?</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_image_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">))):</span>
                    <span class="n">correlation</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_window</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">width</span>
                    <span class="n">offset_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span><span class="p">])</span> <span class="o">+</span> <span class="n">low</span>
                    <span class="n">offset_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">select</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alignment_offset</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">),</span> <span class="n">select</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_manual</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alignment_offset</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset order: </span><span class="si">{</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Offset pixel: </span><span class="si">{</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lines</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_single_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">gaussfit2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observation&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">gaussval2</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">coef</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fit&quot;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Gaussian Fit to spectral line&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity [a.u.]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">coef</span>

<div class="viewcode-block" id="WavelengthCalibration.fit_lines">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.fit_lines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine exact position of each line on the detector based on initial guess</span>

<span class="sd">        This fits a Gaussian to each line, and uses the peak position as a new solution</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            observed wavelength calibration image</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            reference line data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            Updated line information (posm is changed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For each line fit a gaussian to the observation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Lines&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Line outside pixel range</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
                <span class="c1"># Line outside order range</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_single_line</span><span class="p">(</span>
                    <span class="n">obs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">])],</span>
                    <span class="n">line</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">],</span>
                    <span class="n">line</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>
                    <span class="n">plot</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;posm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Gaussian fit failed, dont use line</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.build_2d_solution">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.build_2d_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_2d_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a 2D polynomial fit to flagged lines</span>
<span class="sd">        degree : tuple(int, int), optional</span>
<span class="sd">            polynomial degree of the fit in (column, order) dimension (default: (6, 6))</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : struc_array</span>
<span class="sd">            line data</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            wether to plot the solution (default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coef : array[degree_x, degree_y]</span>
<span class="sd">            2d polynomial coefficients</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_step_solution</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>

        <span class="c1"># Only use flagged data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>  <span class="c1"># True: use line, False: dont use line</span>
        <span class="n">m_wave</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">m_pix</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">m_ord</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
            <span class="n">nord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nord</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nord</span><span class="p">):</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">m_ord</span> <span class="o">==</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">select</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Not enough lines for wavelength solution</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Not enough valid lines found wavelength calibration in order </span><span class="si">% i</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">continue</span>

                <span class="n">deg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">select</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">deg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span>
                    <span class="n">m_pix</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">m_wave</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
            <span class="c1"># 2d polynomial fit with: x = column, y = order, z = wavelength</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">polyfit2d</span><span class="p">(</span><span class="n">m_pix</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">m_wave</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;mode&#39; not understood. Expected &#39;1D&#39; or &#39;2D&#39; but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Residuals&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">coef</span></div>


<div class="viewcode-block" id="WavelengthCalibration.g">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.g">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">step_coef_pos</span><span class="p">,</span> <span class="n">step_coef_diff</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">step_coef_pos</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">step_coef_diff</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">cumsum</span><span class="p">[</span><span class="n">digits</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="WavelengthCalibration.f">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.f">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">poly_coef</span><span class="p">,</span> <span class="n">step_coef_pos</span><span class="p">,</span> <span class="n">step_coef_diff</span><span class="p">):</span>
        <span class="n">xdash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">step_coef_pos</span><span class="p">,</span> <span class="n">step_coef_diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">xdash</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">poly_coef</span><span class="p">,</span> <span class="n">xdash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="WavelengthCalibration.build_step_solution">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.build_step_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_step_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the least squares fit to the wavelength points,</span>
<span class="sd">        with additional free parameters for detector gaps, e.g. due to stitching.</span>

<span class="sd">        The exact method of the fit depends on the dimensionality.</span>
<span class="sd">        Either way we are using the usual polynomial fit for the wavelength, but</span>
<span class="sd">        the x points are modified beforehand by shifting them some amount, at specific</span>
<span class="sd">        indices. We assume that the stitching effects are distributed evenly and we know how</span>
<span class="sd">        many steps we expect (this is set as &quot;nstep&quot;).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : np.recarray</span>
<span class="sd">            linedata</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            whether to plot results or not, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coef</span>
<span class="sd">            coefficients of the best fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>  <span class="c1"># True: use line, False: dont use line</span>
        <span class="n">m_wave</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">m_pix</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">m_ord</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">nstep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstep</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">m_ord</span><span class="p">):</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">m_ord</span> <span class="o">==</span> <span class="n">order</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xl</span> <span class="o">=</span> <span class="n">m_pix</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">m_wave</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
                <span class="n">step_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nstep</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ncol</span> <span class="o">/</span> <span class="p">(</span><span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">poly_coef</span><span class="p">,</span> <span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">poly_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                    <span class="n">xl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

                <span class="n">coef</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly_coef</span><span class="p">,</span> <span class="n">step_coef</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">m_ord</span><span class="p">)</span>
            <span class="n">nord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">step_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">step_coef</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ncol</span> <span class="o">/</span> <span class="p">(</span><span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">nstep</span><span class="p">))</span>
                <span class="n">xl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">):</span>
                    <span class="n">xl</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="n">i</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">polyval2d</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">poly_coef</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">z</span>

            <span class="c1"># TODO: this could use some optimization</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">m_pix</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">m_pix</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">))</span>
            <span class="n">resid_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
                <span class="n">poly_coef</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">polyfit2d</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">m_wave</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">m_wave</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">step_coef</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">step_coef</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nord</span><span class="p">,</span> <span class="n">nstep</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">):</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">m_ord</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span>
                        <span class="n">m_pix</span><span class="p">[</span><span class="n">m_ord</span> <span class="o">==</span> <span class="n">i</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="n">resid</span> <span class="o">=</span> <span class="n">polyval2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">poly_coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_wave</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">improvement</span> <span class="o">=</span> <span class="n">resid_old</span> <span class="o">-</span> <span class="n">resid</span>
                <span class="n">resid_old</span> <span class="o">=</span> <span class="n">resid</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Iteration: </span><span class="si">%i</span><span class="s2">, Residuals: </span><span class="si">%.5g</span><span class="s2">, Improvement: </span><span class="si">%.5g</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">k</span><span class="p">,</span>
                    <span class="n">resid</span><span class="p">,</span>
                    <span class="n">improvement</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">poly_coef</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">polyfit2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">m_wave</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">step_coef</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">)}</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="p">(</span><span class="n">poly_coef</span><span class="p">,</span> <span class="n">step_coef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;dimensionality&#39; not understood. Expected &#39;1D&#39; or &#39;2D&#39; but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">coef</span></div>


<div class="viewcode-block" id="WavelengthCalibration.evaluate_step_solution">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.evaluate_step_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_step_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pos and order must have the same shape&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">order</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">result</span><span class="p">[</span><span class="n">select</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">select</span><span class="p">],</span>
                    <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
            <span class="n">poly_coef</span><span class="p">,</span> <span class="n">step_coef</span> <span class="o">=</span> <span class="n">solution</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">order</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">order</span> <span class="o">==</span> <span class="n">i</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">step_coef</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">polyval2d</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">poly_coef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;mode&#39; not understood, expected &#39;1D&#39; or &#39;2D&#39; but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="WavelengthCalibration.evaluate_solution">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.evaluate_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the 1d or 2d wavelength solution at the given pixel positions and orders</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : array</span>
<span class="sd">            pixel position on the detector (i.e. x axis)</span>
<span class="sd">        order : array</span>
<span class="sd">            order of each point</span>
<span class="sd">        solution : array of shape (nord, ndegree) or (degree_x, degree_y)</span>
<span class="sd">            polynomial coefficients. For mode=1D, one set of coefficients per order.</span>
<span class="sd">            For mode=2D, the first dimension is for the positions and the second for the orders</span>
<span class="sd">        mode : str, optional</span>
<span class="sd">            Wether to interpret the solution as 1D or 2D polynomials, by default &quot;1D&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result: array</span>
<span class="sd">            Evaluated polynomial</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If pos and order have different shapes, or mode is of the wrong value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pos and order must have the same shape&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_step_solution</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">solution</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">order</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">result</span><span class="p">[</span><span class="n">select</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">pos</span><span class="p">[</span><span class="n">select</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyval2d</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">solution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;mode&#39; not understood, expected &#39;1D&#39; or &#39;2D&#39; but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="WavelengthCalibration.make_wave">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.make_wave">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_wave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expand polynomial wavelength solution into full image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wave_solution : array of shape(degree,)</span>
<span class="sd">            polynomial coefficients of wavelength solution</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            wether to plot the solution (default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave_img : array of shape (nord, ncol)</span>
<span class="sd">            wavelength solution for each point in the spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="n">wave_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wave_img</span></div>


<div class="viewcode-block" id="WavelengthCalibration.auto_id">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.auto_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">auto_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">wave_img</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Automatically identify peaks that are close to known lines</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            observed spectrum</span>
<span class="sd">        wave_img : array of shape (nord, ncol)</span>
<span class="sd">            wavelength solution image</span>
<span class="sd">        lines : struc_array</span>
<span class="sd">            line data</span>
<span class="sd">        threshold : int, optional</span>
<span class="sd">            difference threshold between line positions in m/s, until which a line is considered identified (default: 1)</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            wether to plot the new lines</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lines : struct_array</span>
<span class="sd">            line data with new flags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># For each order, find the corresponding section in the Atlas</span>
            <span class="c1"># Look for strong lines in the atlas and the spectrum that match in position</span>
            <span class="c1"># Add new lines to the linelist</span>
            <span class="n">width_of_atlas_peaks</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>
                <span class="n">index_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">data_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">mask</span><span class="p">]</span>
                <span class="n">wave_obs</span> <span class="o">=</span> <span class="n">wave_img</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">mask</span><span class="p">]</span>

                <span class="n">threshold_of_peak_closeness</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wave_obs</span><span class="p">)</span> <span class="o">/</span> <span class="n">wave_obs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">speed_of_light</span>
                <span class="p">)</span>
                <span class="n">threshold_of_peak_closeness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">threshold_of_peak_closeness</span><span class="p">)</span>

                <span class="n">wmin</span><span class="p">,</span> <span class="n">wmax</span> <span class="o">=</span> <span class="n">wave_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wave_obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="p">(</span><span class="n">wmin</span><span class="p">,</span> <span class="n">wmax</span><span class="p">))</span>
                <span class="n">wave_atlas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">wave</span><span class="p">[</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>
                <span class="n">data_atlas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_atlas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">data_atlas</span> <span class="o">=</span> <span class="n">data_atlas</span> <span class="o">/</span> <span class="n">data_atlas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wmin</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="n">peaks_atlas</span><span class="p">,</span> <span class="n">peak_info_atlas</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
                    <span class="n">data_atlas</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width_of_atlas_peaks</span>
                <span class="p">)</span>
                <span class="n">peaks_obs</span><span class="p">,</span> <span class="n">peak_info_obs</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
                    <span class="n">data_obs</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks_atlas</span><span class="p">):</span>
                    <span class="c1"># Look for an existing line in the vicinityq</span>
                    <span class="n">wpeak</span> <span class="o">=</span> <span class="n">wave_atlas</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">wpeak</span><span class="p">)</span> <span class="o">/</span> <span class="n">wpeak</span> <span class="o">*</span> <span class="n">speed_of_light</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">threshold_of_peak_closeness</span><span class="p">):</span>
                        <span class="c1"># Line already in the linelist, ignore</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Look for matching peak in observation</span>
                        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wpeak</span> <span class="o">-</span> <span class="n">wave_obs</span><span class="p">[</span><span class="n">peaks_obs</span><span class="p">])</span> <span class="o">/</span> <span class="n">wpeak</span> <span class="o">*</span> <span class="n">speed_of_light</span>
                        <span class="p">)</span>
                        <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">diff</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold_of_peak_closeness</span><span class="p">:</span>
                            <span class="c1"># Add line to linelist</span>
                            <span class="c1"># Location on the detector</span>
                            <span class="c1"># Include the masked areas!!!</span>
                            <span class="n">ipeak</span> <span class="o">=</span> <span class="n">peaks_obs</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>
                            <span class="n">ipeak</span> <span class="o">=</span> <span class="n">index_mask</span><span class="p">[</span><span class="n">ipeak</span><span class="p">]</span>

                            <span class="c1"># relative height of the peak</span>
                            <span class="n">hpeak</span> <span class="o">=</span> <span class="n">data_obs</span><span class="p">[</span><span class="n">peaks_obs</span><span class="p">[</span><span class="n">imin</span><span class="p">]]</span>
                            <span class="n">wipeak</span> <span class="o">=</span> <span class="n">peak_info_obs</span><span class="p">[</span><span class="s2">&quot;widths&quot;</span><span class="p">][</span><span class="n">imin</span><span class="p">]</span>
                            <span class="c1"># wave, order, pos, width, height, flag</span>
                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">wpeak</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">ipeak</span><span class="p">,</span> <span class="n">wipeak</span><span class="p">,</span> <span class="n">hpeak</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>

            <span class="c1"># Add new lines to the linelist</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="o">*</span><span class="n">new_lines</span><span class="p">)</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>

        <span class="c1"># Option 1:</span>
        <span class="c1"># Step 1: Loop over unused lines in lines</span>
        <span class="c1"># Step 2: find peaks in neighbourhood</span>
        <span class="c1"># Step 3: Toggle flag on if close</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]:</span>
                <span class="c1"># Line is already in use</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">:</span>
                <span class="c1"># Line outside order range</span>
                <span class="k">continue</span>
            <span class="n">iord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wave_img</span><span class="p">[</span><span class="n">iord</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wave_img</span><span class="p">[</span><span class="n">iord</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Line outside pixel range</span>
                <span class="k">continue</span>

            <span class="n">wl</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">wave_img</span><span class="p">[</span><span class="n">iord</span><span class="p">]</span>
            <span class="n">order_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">iord</span><span class="p">]</span>
            <span class="c1"># Find where the line should be</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wave</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Wavelength solution is not monotonic</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wave</span> <span class="o">&gt;=</span> <span class="n">wl</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_obs</span><span class="p">))</span>

            <span class="n">vec</span> <span class="o">=</span> <span class="n">order_obs</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">vec</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="c1"># Find the best fitting peak</span>
            <span class="c1"># TODO use gaussian fit?</span>
            <span class="n">peak_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">peak_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">peak_idx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peak_idx</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_single_line</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">peak_idx</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">])</span>
                        <span class="n">peak_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">peak_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">pass</span>

                <span class="n">pos_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">peak_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">),</span> <span class="n">wave</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span><span class="p">])</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wl</span> <span class="o">-</span> <span class="n">pos_wave</span><span class="p">)</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">*</span> <span class="n">speed_of_light</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">residual</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="n">peak_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AutoID identified </span><span class="si">%i</span><span class="s2"> new lines&quot;</span><span class="p">,</span> <span class="n">counter</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.calculate_residual">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.calculate_residual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate all residuals of all given lines</span>

<span class="sd">        Residual = (Wavelength Solution - Expected Wavelength) / Expected Wavelength * speed of light</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wave_solution : array of shape (degree_x, degree_y)</span>
<span class="sd">            polynomial coefficients of the wavelength solution (in numpy format)</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            contains the position of the line on the detector (posm), the order (order), and the expected wavelength (wll)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        residual : array of shape (nlines,)</span>
<span class="sd">            Residual of each line in m/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">)</span>

        <span class="n">residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">solution</span> <span class="o">-</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">speed_of_light</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">residual</span></div>


<div class="viewcode-block" id="WavelengthCalibration.reject_outlier">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.reject_outlier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reject_outlier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reject the strongest outlier</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        residual : array of shape (nlines,)</span>
<span class="sd">            residuals of all lines</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            line data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lines : struct_array</span>
<span class="sd">            line data with one more flagged line</span>
<span class="sd">        residual : array of shape (nlines,)</span>
<span class="sd">            residuals of each line, with outliers masked (including the new one)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Strongest outlier</span>
        <span class="n">ibad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residual</span><span class="p">))</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">][</span><span class="n">ibad</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.reject_lines">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.reject_lines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reject_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reject the largest outlier one by one until all residuals are lower than the threshold</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            Line data with pixel position, and expected wavelength</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            upper limit for the residual, by default 100</span>
<span class="sd">        degree : tuple, optional</span>
<span class="sd">            polynomial degree of the wavelength solution (pixel, column) (default: (6, 6))</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Wether to plot the results (default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            Line data with updated flags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wave_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_solution</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_residual</span><span class="p">(</span><span class="n">wave_solution</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="n">nbad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_outlier</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
            <span class="n">wave_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_solution</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_residual</span><span class="p">(</span><span class="n">wave_solution</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
            <span class="n">nbad</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding </span><span class="si">%i</span><span class="s2"> lines&quot;</span><span class="p">,</span> <span class="n">nbad</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">residual</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Accepted Lines&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">residual</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rejected Lines&quot;</span>
            <span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Order&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residual [m/s]&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals versus order&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Residuals of each order versus image columns&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">iord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
                <span class="n">order_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iord</span><span class="p">]</span>
                <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span>
                    <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">],</span> <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span> <span class="n">wave_solution</span>
                <span class="p">)</span>
                <span class="c1"># Residual in m/s</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">solution</span> <span class="o">-</span> <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">])</span>
                    <span class="o">/</span> <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">speed_of_light</span>
                <span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">iord</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iord</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">residual</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Accepted Lines&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">iord</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iord</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">residual</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                    <span class="s2">&quot;D&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rejected Lines&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># ax[iord // 2, iord % 2].tick_params(labelleft=False)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">iord</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iord</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="mf">1.5</span>
                <span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="WavelengthCalibration.plot_results">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.plot_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave_img</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Wavelength solution with Wavelength calibration spectrum</span><span class="se">\n</span><span class="s2">Orders are in different colours&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Observed spectrum&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_img</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Order </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;2D Wavelength solution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">wave_img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Order&quot;</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Wavelength []&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WavelengthCalibration.plot_residuals">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.plot_residuals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Residuals&quot;</span><span class="p">):</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">])</span>
        <span class="n">norders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">nplots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">norders</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orders</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nplots</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">order_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_residual</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">order_lines</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">order_lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">],</span> <span class="n">residual</span><span class="p">,</span> <span class="s2">&quot;rX&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">norders</span><span class="p">,</span> <span class="n">norders</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [Pixel]&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
            <span class="c1"># else:</span>
            <span class="c1"># plt.yticks([-self.threshold, 0, self.threshold])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># order = 0</span>
        <span class="c1"># order_lines = lines[lines[&quot;order&quot;] == order]</span>
        <span class="c1"># if len(order_lines) &gt; 0:</span>
        <span class="c1">#     residual = self.calculate_residual(coef, order_lines)</span>
        <span class="c1">#     plt.plot(order_lines[&quot;posm&quot;], residual, &quot;rX&quot;)</span>
        <span class="c1">#     plt.hlines([0], 0, self.ncol)</span>
        <span class="c1"># plt.xlim(0, self.ncol)</span>
        <span class="c1"># plt.ylim(-self.threshold, self.threshold)</span>
        <span class="c1"># plt.xlabel(&quot;x [Pixel]&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Residual [m/s]&quot;)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comb</span><span class="p">):</span>
        <span class="c1"># Find peaks in the comb spectrum</span>
        <span class="c1"># Run find_peak twice</span>
        <span class="c1"># once to find the average distance between peaks</span>
        <span class="c1"># once for real (disregarding close peaks)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">comb</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lfc_peak_width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">peaks</span><span class="p">))</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

        <span class="c1"># Fit peaks with gaussian to get accurate position</span>
        <span class="n">new_peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">peaks</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">gaussfit3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span> <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">new_peaks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span> <span class="o">-</span> <span class="n">width</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">new_peaks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">))</span>

        <span class="c1"># keep peaks within the range</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_peaks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_peaks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">new_peaks</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">new_peaks</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">new_peaks</span>

<div class="viewcode-block" id="WavelengthCalibration.calculate_AIC">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.calculate_AIC">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_AIC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;1D&quot;</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">wave_solution</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="s2">&quot;2D&quot;</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">poly_coef</span><span class="p">,</span> <span class="n">steps_coef</span> <span class="o">=</span> <span class="n">wave_solution</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">steps_coef</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">poly_coef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">wave_solution</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># We get the residuals in velocity space</span>
        <span class="c1"># but need to remove the speed of light component, to get dimensionless parameters</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">)</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="p">(</span><span class="n">solution</span> <span class="o">-</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;wll&quot;</span><span class="p">]</span>

        <span class="c1"># rss = self.calculate_residual(wave_solution, lines)</span>
        <span class="c1"># rss /= speed_of_light</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">rss</span><span class="o">.</span><span class="n">size</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rss</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># As per Wikipedia https://en.wikipedia.org/wiki/Akaike_information_criterion</span>
        <span class="n">logl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span>
        <span class="n">aic</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">logl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logl</span> <span class="o">=</span> <span class="n">logl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aicc</span> <span class="o">=</span> <span class="n">aic</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aic</span> <span class="o">=</span> <span class="n">aic</span>
        <span class="k">return</span> <span class="n">aic</span></div>


<div class="viewcode-block" id="WavelengthCalibration.execute">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibration.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the whole wavelength calibration procedure with the current settings</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array of shape (nord, ncol)</span>
<span class="sd">            observed image</span>
<span class="sd">        lines : recarray of shape (nlines,)</span>
<span class="sd">            reference linelist</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave_img : array of shape (nord, ncol)</span>
<span class="sd">            Wavelength solution for each pixel</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If polarimitry flag is set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;polarized orders not implemented yet&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">LineList</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">LineAtlas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Atlas file found for element </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">obs</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="c1"># Step 1: align obs and reference</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

        <span class="c1"># Keep original positions for reference</span>
        <span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;posm&quot;</span><span class="p">])</span>

        <span class="c1"># Step 2: Locate the lines on the detector, and update the pixel position</span>
        <span class="c1"># lines[&quot;flag&quot;] = True</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wavelength calibration iteration: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Step 3: Create a wavelength solution on known lines</span>
            <span class="n">wave_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_solution</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">wave_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_wave</span><span class="p">(</span><span class="n">wave_solution</span><span class="p">)</span>
            <span class="c1"># Step 4: Identify lines that fit into the solution</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_id</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">wave_img</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
            <span class="c1"># Step 5: Reject outliers</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="c1"># lines = self.reject_lines(lines)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Number of lines used for wavelength calibration: </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Step 6: build final 2d solution</span>
        <span class="n">wave_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_solution</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
        <span class="n">wave_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_wave</span><span class="p">(</span><span class="n">wave_solution</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">wave_img</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>

        <span class="n">aic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_AIC</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AIC of wavelength fit: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">aic</span><span class="p">)</span>

        <span class="c1"># np.savez(&quot;cs_lines.npz&quot;, cs_lines=lines.data)</span>

        <span class="k">return</span> <span class="n">wave_img</span><span class="p">,</span> <span class="n">wave_solution</span><span class="p">,</span> <span class="n">lines</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibrationComb">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationComb">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibrationComb</span><span class="p">(</span><span class="n">WavelengthCalibration</span><span class="p">):</span>
<div class="viewcode-block" id="WavelengthCalibrationComb.execute">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationComb.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comb</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># TODO give everything better names</span>
        <span class="n">pixel</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">n_all</span><span class="p">,</span> <span class="n">f_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">comb</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
            <span class="c1"># Find Peak positions in current order</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_peaks</span><span class="p">(</span><span class="n">comb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Determine the n-offset of this order, relative to the anchor frequency</span>
            <span class="c1"># Use the existing absolute wavelength calibration as reference</span>
            <span class="n">y_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">w_old</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">wave</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">)(</span><span class="n">peaks</span><span class="p">)</span>
            <span class="n">f_old</span> <span class="o">=</span> <span class="n">speed_of_light</span> <span class="o">/</span> <span class="n">w_old</span>

            <span class="c1"># fr: repeating frequency</span>
            <span class="c1"># fd: anchor frequency of this order, needs to be shifted to the absolute reference frame</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">f_old</span><span class="p">))</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">f_old</span> <span class="o">%</span> <span class="n">fr</span><span class="p">)</span>
            <span class="n">n_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_old</span> <span class="o">-</span> <span class="n">fd</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n_raw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n_raw</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Bad peaks detected in the frequency comb in order </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span>
                <span class="p">)</span>

            <span class="n">fr</span><span class="p">,</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">f_old</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">n_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># The first order is used as the baseline for all other orders</span>
            <span class="c1"># The choice is arbitrary and doesn&#39;t matter</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f0</span> <span class="o">=</span> <span class="n">fd</span>
                <span class="n">n_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># n0: shift in n, relative to the absolute reference</span>
                <span class="c1"># shift n to the absolute grid, so that all peaks are given by the same f0</span>
                <span class="n">n_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">f0</span> <span class="o">-</span> <span class="n">fd</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr</span>
                <span class="n">n_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n_offset</span><span class="p">))</span>
                <span class="n">n</span> <span class="o">-=</span> <span class="n">n_offset</span>
                <span class="n">fd</span> <span class="o">+=</span> <span class="n">n_offset</span> <span class="o">*</span> <span class="n">fr</span>

            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="n">n_all</span> <span class="o">+=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">f_all</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f_old</span><span class="p">]</span>
            <span class="n">pixel</span> <span class="o">+=</span> <span class="p">[</span><span class="n">peaks</span><span class="p">]</span>
            <span class="n">order</span> <span class="o">+=</span> <span class="p">[</span><span class="n">y_ord</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;LFC Order: </span><span class="si">%i</span><span class="s2">, f0: </span><span class="si">%.3f</span><span class="s2">, fr: </span><span class="si">%.5f</span><span class="s2">, n0: </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n_offset</span>
            <span class="p">)</span>

        <span class="c1"># Here we postualte that m * lambda = const</span>
        <span class="c1"># where m is the peak number</span>
        <span class="c1"># this is the result of the grating equation</span>
        <span class="c1"># at least const is roughly constant for neighbouring peaks</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">correct</span><span class="p">:</span>
            <span class="n">w_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">speed_of_light</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_all</span><span class="p">]</span>
            <span class="n">mw_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="n">w</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_all</span><span class="p">,</span> <span class="n">w_all</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mw_all</span><span class="p">)</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
                <span class="n">corri</span> <span class="o">=</span> <span class="n">gap</span> <span class="o">/</span> <span class="n">w_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">corri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">corri</span><span class="p">)</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">corri</span><span class="p">)</span>
                <span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LFC order offset correction: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nord</span><span class="p">):</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">w_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">mw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">w_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mw</span> <span class="o">/</span> <span class="n">n_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">f_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed_of_light</span> <span class="o">/</span> <span class="n">w_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Merge Data</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">n_all</span><span class="p">)</span>
        <span class="n">f_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">f_all</span><span class="p">)</span>
        <span class="n">pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Fit f0 and fr to all data</span>
        <span class="c1"># (fr, f0), cov = np.polyfit(n_all, f_all, deg=1, cov=True)</span>
        <span class="n">fr</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">n_all</span><span class="p">,</span> <span class="n">f_all</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Laser Frequency Comb Anchor Frequency: </span><span class="si">%.3f</span><span class="s2"> 10**10 Hz&quot;</span><span class="p">,</span> <span class="n">f0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Laser Frequency Comb Repeating Frequency: </span><span class="si">%.5f</span><span class="s2"> 10**10 Hz&quot;</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>

        <span class="c1"># All peaks are then given by f0 + n * fr</span>
        <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">speed_of_light</span> <span class="o">/</span> <span class="p">(</span><span class="n">f0</span> <span class="o">+</span> <span class="n">n_all</span> <span class="o">*</span> <span class="n">fr</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">laser_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span>
            <span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">flag</span><span class="p">),</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;wll&quot;</span><span class="p">,</span> <span class="s2">&quot;posm&quot;</span><span class="p">,</span> <span class="s2">&quot;posc&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;flag&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Use now better resolution to find the new solution</span>
        <span class="c1"># A single pass of discarding outliers should be enough</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_solution</span><span class="p">(</span><span class="n">laser_lines</span><span class="p">)</span>
        <span class="c1"># resid = self.calculate_residual(coef, laser_lines)</span>
        <span class="c1"># laser_lines[&quot;flag&quot;] = np.abs(resid) &lt; self.threshold</span>
        <span class="c1"># coef = self.build_2d_solution(laser_lines)</span>
        <span class="n">new_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_wave</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

        <span class="n">aic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_AIC</span><span class="p">(</span><span class="n">laser_lines</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_lines_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">laser_lines</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Laser Frequency Comb solution based on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_lines_good</span><span class="si">}</span><span class="s2"> lines.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">-</span> <span class="n">new_wave</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">68</span><span class="p">))</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;ThAr - LFC&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\lambda$ []&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span>
                    <span class="n">lines</span><span class="p">,</span>
                    <span class="n">coef</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;GasLamp Line Residuals in the Laser Frequency Comb Solution&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span>
                <span class="n">laser_lines</span><span class="p">,</span>
                <span class="n">coef</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Laser Frequency Comb Peak Residuals in the LFC Solution&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="n">wave_img</span> <span class="o">=</span> <span class="n">wave</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Difference between GasLamp Solution and Laser Frequency Comb solution</span><span class="se">\n</span><span class="s2">Each plot shows one order&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_wave</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_wave</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_wave</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">new_wave</span><span class="p">,</span> <span class="n">comb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_wave</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibrationInitialize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibrationInitialize</span><span class="p">(</span><span class="n">WavelengthCalibration</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_title</span><span class="o">=</span><span class="s2">&quot;Wavecal Initial&quot;</span><span class="p">,</span>
        <span class="n">wave_delta</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">nwalkers</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="mi">50_000</span><span class="p">,</span>
        <span class="n">resid_delta</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="s2">&quot;thar&quot;</span><span class="p">,</span>
        <span class="n">medium</span><span class="o">=</span><span class="s2">&quot;vac&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">dimensionality</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">#:float: wavelength uncertainty on the initial guess in Angstrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span> <span class="o">=</span> <span class="n">wave_delta</span>
        <span class="c1">#:int: number of walkers in the MCMC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="n">nwalkers</span>
        <span class="c1">#:int: number of steps in the MCMC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
        <span class="c1">#:float: residual uncertainty allowed when matching observation with known lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_delta</span> <span class="o">=</span> <span class="n">resid_delta</span>
        <span class="c1">#:float: gaussian smoothing applied to the wavecal spectrum before the MCMC in pixel scale, disable it by setting it to 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>
        <span class="c1">#:float: minimum value in the spectrum to be considered a spectral line, if the value is above (or equal 1) it defines the percentile of the spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>

<div class="viewcode-block" id="WavelengthCalibrationInitialize.get_cutoff">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize.get_cutoff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">spectrum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cutoff</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.normalize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize.normalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
        <span class="n">smoothing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smoothing</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">smoothing</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="n">spectrum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">spectrum</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spectrum</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.determine_wavelength_coefficients">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize.determine_wavelength_coefficients">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">determine_wavelength_coefficients</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spectrum</span><span class="p">,</span>
        <span class="n">atlas</span><span class="p">,</span>
        <span class="n">wave_range</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the wavelength polynomial coefficients of a spectrum,</span>
<span class="sd">        based on an line atlas with known spectral lines,</span>
<span class="sd">        and an initial guess for the wavelength range.</span>
<span class="sd">        The calculation uses an MCMC approach to sample the probability space and</span>
<span class="sd">        find the best cross correlation value, between observation and atlas.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum : array</span>
<span class="sd">            observed spectrum at each pixel</span>
<span class="sd">        atlas : LineAtlas</span>
<span class="sd">            atlas containing a known spectrum with wavelength and flux</span>
<span class="sd">        wave_range : 2-tuple</span>
<span class="sd">            initial wavelength guess (begin, end)</span>
<span class="sd">        degrees : int, optional</span>
<span class="sd">            number of degrees of the wavelength polynomial,</span>
<span class="sd">            lower numbers yield better results, by default 2</span>
<span class="sd">        w_range : float, optional</span>
<span class="sd">            uncertainty on the initial wavelength guess in Ansgtrom, by default 20</span>
<span class="sd">        nwalkers : int, optional</span>
<span class="sd">            number of walkers for the MCMC, more is better but increases</span>
<span class="sd">            the time, by default 100</span>
<span class="sd">        steps : int, optional</span>
<span class="sd">            number of steps in the MCMC per walker, more is better but increases</span>
<span class="sd">            the time, by default 20_000</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            whether to plot the results or not, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coef : array</span>
<span class="sd">            polynomial coefficients in numpy order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;The polynomial degree must be at least 2&quot;</span>
        <span class="k">assert</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The spectrum should only have 1 dimension&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;The wavelength uncertainty needs to be positive&quot;</span>

        <span class="n">n_features</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_output</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Normalize the spectrum, and copy it just in case</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cutoff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># The pixel scale used for everything else</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        <span class="c1"># Initial guess for the wavelength solution</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_output</span><span class="p">)</span>
        <span class="n">coef</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">coef</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wave_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n_features</span>

        <span class="c1"># We scale every coefficient to roughly order 1</span>
        <span class="c1"># this is then in units of the maximum offset due to a change in this value</span>
        <span class="c1"># in angstrom</span>
        <span class="n">w_scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_output</span><span class="p">))</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">w_scale</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">coef</span> <span class="o">/=</span> <span class="n">factors</span>

        <span class="c1"># Here we define the functions we need for the MCMC</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">polyval_vectorize</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">n_poly</span><span class="p">,</span> <span class="n">n_coef</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">n_points</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_poly</span><span class="p">,</span> <span class="n">n_points</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_coef</span><span class="p">):</span>
                    <span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x</span>
                    <span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_coef</span><span class="p">):</span>
                    <span class="n">y</span> <span class="o">*=</span> <span class="n">x</span>
                    <span class="n">y</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">y</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_prior</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prior</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">prior</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">coef</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">return</span> <span class="n">prior</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_prior_2</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="c1"># Chech that w is increasing</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prior</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">w</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">prior</span><span class="p">[</span><span class="n">w</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wave_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">prior</span><span class="p">[</span><span class="n">w</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wave_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">return</span> <span class="n">prior</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1"># Check that p is within bounds</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">log_prior</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span>
            <span class="c1"># Calculate the wavelength scale</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">polyval_vectorize</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">factors</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">)</span>
            <span class="c1"># Check that it is monotonically increasing</span>
            <span class="n">prior</span> <span class="o">+=</span> <span class="n">log_prior_2</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="p">:],</span> <span class="n">atlas</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="n">atlas</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># This is the cross correlation value squared</span>
            <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="c1"># chi2 = - np.sum((y - spectrum)**2, axis=1)</span>
            <span class="c1"># chi2 = - np.sum((np.where(y &gt; 0.01, 1, 0) - np.where(spectrum &gt; 0.01, 1, 0))**2, axis=1)</span>
            <span class="c1"># this is the same as above, but a lot faster thanks to the magic of bitwise xor</span>
            <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">chi2</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">spectrum</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">)</span>
                <span class="n">chi2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chi2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">spectrum</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>
            <span class="k">return</span> <span class="n">prior</span> <span class="o">+</span> <span class="n">cross</span> <span class="o">+</span> <span class="n">chi2</span>

        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
        <span class="n">p0</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">p0</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span>
            <span class="n">ndim</span><span class="p">,</span>
            <span class="n">log_prob</span><span class="p">,</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">moves</span><span class="o">=</span><span class="p">[(</span><span class="n">emcee</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">DEMove</span><span class="p">(),</span> <span class="mf">0.8</span><span class="p">),</span> <span class="p">(</span><span class="n">emcee</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">DESnookerMove</span><span class="p">(),</span> <span class="mf">0.2</span><span class="p">)],</span>
        <span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_autocorr_time</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">burnin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">thin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">discard</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="n">thin</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">low</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">68</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">*</span> <span class="n">factors</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">atlas</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="n">atlas</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">coef</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.create_new_linelist_from_solution">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize.create_new_linelist_from_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_new_linelist_from_solution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spectrum</span><span class="p">,</span>
        <span class="n">wavelength</span><span class="p">,</span>
        <span class="n">atlas</span><span class="p">,</span>
        <span class="n">order</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineList</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new linelist based on an existing wavelength solution for a spectrum,</span>
<span class="sd">        and a line atlas with known lines. The linelist is the one used by the rest of</span>
<span class="sd">        PyReduce wavelength calibration.</span>

<span class="sd">        Observed lines are matched with the lines in the atlas to</span>
<span class="sd">        improve the wavelength solution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum : array</span>
<span class="sd">            Observed spectrum at each pixel</span>
<span class="sd">        wavelength : array</span>
<span class="sd">            Wavelength of spectrum at each pixel</span>
<span class="sd">        atlas : LineAtlas</span>
<span class="sd">            Atlas with wavelength of known lines</span>
<span class="sd">        order : int</span>
<span class="sd">            Order of the spectrum within the detector</span>
<span class="sd">        resid_delta : float, optional</span>
<span class="sd">            Maximum residual allowed between a peak and the closest line in the atlas,</span>
<span class="sd">            to still match them, in m/s, by default 1000.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        linelist : LineList</span>
<span class="sd">            new linelist with lines from this order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The new linelist</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">LineList</span><span class="p">()</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">resid_delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Residuals Delta must be positive&quot;</span>
        <span class="k">assert</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Spectrum must have only 1 dimension&quot;</span>
        <span class="k">assert</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Wavelength must have only 1 dimension&quot;</span>
        <span class="k">assert</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Spectrum and Wavelength must have the same size&quot;</span>
        <span class="p">)</span>

        <span class="n">n_features</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        <span class="n">smoothing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span>

        <span class="c1"># Normalize just in case</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cutoff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># TODO: make this use another function, and pass the hight as a parameter</span>
        <span class="n">scopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scopy</span><span class="p">[</span><span class="n">scopy</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_peaks</span><span class="p">(</span><span class="n">scopy</span><span class="p">)</span>

        <span class="n">peak_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">)</span>
        <span class="n">peak_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># Here we only look at the lines within range</span>
        <span class="n">atlas_linelist</span> <span class="o">=</span> <span class="n">atlas</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span>
            <span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wavelength</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">peak_wave</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peak_wave</span><span class="p">):</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pw</span> <span class="o">-</span> <span class="n">atlas_linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">resid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">pw</span> <span class="o">*</span> <span class="n">speed_of_light</span>
            <span class="k">if</span> <span class="n">residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resid_delta</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
                    <span class="n">atlas_linelist</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">order</span><span class="p">,</span>
                    <span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="n">peak_height</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">linelist</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.execute">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.wavelength_calibration.WavelengthCalibrationInitialize.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">wave_range</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineList</span><span class="p">:</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">LineAtlas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">LineList</span><span class="p">()</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="n">wrange</span> <span class="o">=</span> <span class="n">wave_range</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_wavelength_coefficients</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">wrange</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">linelist_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_linelist_from_solution</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>
            <span class="n">linelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linelist_loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>