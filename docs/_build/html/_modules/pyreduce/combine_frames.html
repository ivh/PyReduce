<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.combine_frames &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.combine_frames</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Combine several fits files into one master frame</span>

<span class="sd">Used to create master bias and master flat</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.io.fits</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fits</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.clipnflip</span><span class="w"> </span><span class="kn">import</span> <span class="n">clipnflip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.instruments.instrument_info</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_instrument</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussbroad</span><span class="p">,</span> <span class="n">gaussfit</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="running_median">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.running_median">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">running_median</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the running median of a 2D sequence</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seq : 2d array [n, l]</span>
<span class="sd">        n datasets of length l</span>
<span class="sd">    size : int</span>
<span class="sd">        number of elements to consider for each median</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    2d array [n, l-size]</span>
<span class="sd">        running median</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">median_filter</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">])</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[:,</span> <span class="n">m</span><span class="p">:</span><span class="o">-</span><span class="n">m</span><span class="p">]</span></div>



<div class="viewcode-block" id="running_sum">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.running_sum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">running_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the running sum over the 2D sequence</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : array[n, l]</span>
<span class="sd">        sequence to calculate running sum over, n datasets of length l</span>
<span class="sd">    size : int</span>
<span class="sd">        number of elements to sum</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    2D array</span>
<span class="sd">        running sum</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="n">size</span><span class="p">:]</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">size</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[:,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span></div>



<div class="viewcode-block" id="calculate_probability">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.calculate_probability">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_probability</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a probability function based on buffer data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    buffer : array of shape (nx, ny)</span>
<span class="sd">        buffer</span>
<span class="sd">    window : int</span>
<span class="sd">        size of the running window</span>
<span class="sd">    method : {&quot;sum&quot;, &quot;median&quot;}, optional</span>
<span class="sd">        which method to use to average the probabilities (default: &quot;sum&quot;)</span>
<span class="sd">        &quot;sum&quot; is much faster, but &quot;median&quot; is more resistant to outliers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    weights : array of shape (nx, ny - 2 * window)</span>
<span class="sd">        probabilities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Take the median/sum for each file</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
        <span class="c1"># Running median is slow</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">running_median</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sum_of_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="c1"># Running sum is fast</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">running_sum</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sum_of_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># norm probability</span>
    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">sum_of_weights</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">sum_of_weights</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weights</span></div>



<div class="viewcode-block" id="fix_bad_pixels">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.fix_bad_pixels">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_bad_pixels</span><span class="p">(</span><span class="n">probability</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">readnoise</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find and fix bad pixels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probability : array(float)</span>
<span class="sd">        probabilities</span>
<span class="sd">    buffer : array(int)</span>
<span class="sd">        image buffer</span>
<span class="sd">    readnoise : float</span>
<span class="sd">        readnoise of current amplifier</span>
<span class="sd">    gain : float</span>
<span class="sd">        gain of current amplifier</span>
<span class="sd">    threshold : float</span>
<span class="sd">        sigma threshold between observation and fit for bad pixels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array(int)</span>
<span class="sd">        input buffer, with bad pixels fixed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fit signal</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">probability</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>
    <span class="c1"># ratio = np.where(probability &gt; 0, buffer / probability, 0.)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">fitted_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">probability</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">probability</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">predicted_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fitted_signal</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">readnoise</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">fitted_signal</span> <span class="o">/</span> <span class="n">gain</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">predicted_noise</span><span class="p">)</span>

    <span class="c1"># Identify outliers</span>
    <span class="n">badpixels</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">fitted_signal</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">predicted_noise</span>
    <span class="n">nbad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">badpixels</span><span class="o">.</span><span class="n">flat</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Construct the summed flat</span>
    <span class="n">corrected_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">badpixels</span><span class="p">,</span> <span class="n">fitted_signal</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="n">corrected_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">corrected_signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corrected_signal</span><span class="p">,</span> <span class="n">nbad</span></div>



<div class="viewcode-block" id="combine_frames_simple">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.combine_frames_simple">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_frames_simple</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple addition of similar images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list(str)</span>
<span class="sd">        list of fits files to combine</span>
<span class="sd">    instrument : str</span>
<span class="sd">        instrument id for modinfo</span>
<span class="sd">    mode : str</span>
<span class="sd">        instrument mode</span>
<span class="sd">    extension : int, optional</span>
<span class="sd">        fits extension to load (default: 1)</span>
<span class="sd">    dtype : np.dtype, optional</span>
<span class="sd">        datatype of the combined image (default float32)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    combined_data, header</span>
<span class="sd">        combined image data, header</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No files given for combine frames&quot;</span><span class="p">)</span>

    <span class="c1"># Load the first file to get the shape and header</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
        <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Sum the remaining files</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>

    <span class="c1"># Update the header</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;NIMAGES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="s2">&quot;number of images summed&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="s2">&quot;total exposure time&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;DARKTIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DARKTIME&quot;</span><span class="p">,</span> <span class="n">head</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span>
        <span class="s2">&quot;total dark time&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Update the readout noise</span>
    <span class="k">if</span> <span class="s2">&quot;RDNOISE&quot;</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
        <span class="n">head</span><span class="p">[</span><span class="s2">&quot;RDNOISE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">head</span><span class="p">[</span><span class="s2">&quot;RDNOISE&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)),</span>
            <span class="s2">&quot;readout noise in combined image&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">head</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> images by simple addition&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">head</span></div>



<div class="viewcode-block" id="combine_frames">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.combine_frames">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_frames</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span>
    <span class="n">instrument</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">,</span>
    <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subroutine to correct cosmic rays blemishes, while adding otherwise</span>
<span class="sd">    similar images.</span>

<span class="sd">    combine_frames co-adds a group of FITS files with 2D images of identical dimensions.</span>
<span class="sd">    In the process it rejects cosmic ray, detector defects etc. It is capable of</span>
<span class="sd">    handling images that have strip pattern (e.g. echelle spectra) using the REDUCE</span>
<span class="sd">    modinfo conventions to figure out image orientation and useful pixel ranges.</span>
<span class="sd">    It can handle many frames. Special cases: 1 file in the list (the input is returned as output)</span>
<span class="sd">    and 2 files (straight sum is returned).</span>

<span class="sd">    If the image orientation is not predominantly vertical, the image is rotated 90 degrees (and rotated back afterwards).</span>

<span class="sd">    Open all FITS files in the list.</span>
<span class="sd">    Loop through the rows. Read next row from each file into a row buffer mBuff[nCol, nFil].</span>
<span class="sd">    Optionally correct the data for non-linearity.</span>

<span class="sd">    calc_probability::</span>

<span class="sd">        Go through the row creating &quot;probability&quot; vector. That is for column iCol take the median of</span>
<span class="sd">        the part of the row mBuff[iCol-win:iCol+win,iFil] for each file and divide these medians by the</span>
<span class="sd">        mean of them computed across the stack of files. In other words:</span>
<span class="sd">        &gt;&gt;&gt; filwt[iFil] = median(mBuff[iCol-win:iCol+win,iFil])</span>
<span class="sd">        &gt;&gt;&gt; norm_filwt = mean(filwt)</span>
<span class="sd">        &gt;&gt;&gt; prob[iCol,iFil] = (norm_filtwt&gt;0)?filwt[iCol]/norm_filwt:filwt[iCol]</span>

<span class="sd">        This is done for all iCol in the range of [win:nCol-win-1]. It is then linearly extrapolated to</span>
<span class="sd">        the win zones of both ends. E.g. for iCol in [0:win-1] range:</span>
<span class="sd">        &gt;&gt;&gt; prob[iCol,iFil]=2*prob[win,iFil]-prob[2*win-iCol,iFil]</span>

<span class="sd">        For the other end ([nCol-win:nCol-1]) it is similar:</span>
<span class="sd">        &gt;&gt;&gt; prob[iCol,iFil]=2*prob[nCol-win-1,iFil]-prob[2*(nCol-win-1)-iCol,iFil]</span>

<span class="sd">    fix_bad_pixels::</span>

<span class="sd">        Once the probailities are constructed we can do the fitting, measure scatter and detect outliers.</span>
<span class="sd">        We ignore negative or zero probabilities as it should not happen. For each iCol with (some)</span>
<span class="sd">        positive probabilities we compute tha ratios of the original data to the probabilities and get</span>
<span class="sd">        the mean amplitude of these ratios after rejecting extreme values:</span>
<span class="sd">        &gt;&gt;&gt; ratio = mBuff[iCol,iFil]/prob[iCol,iFil]</span>
<span class="sd">        &gt;&gt;&gt; amp = (total(ratio)-min(ratio)-max(ratio))/(nFil-2)</span>
<span class="sd">        &gt;&gt;&gt; mFit[iCol,iFil] = amp*prob[iCol,iFil]</span>

<span class="sd">        Note that for iFil whereprob[iCol,iFil] is zero we simply set mFit to zero. The scatter (noise)</span>
<span class="sd">        consists readout noise and shot noise of the model (fit) co-added in quadratures:</span>
<span class="sd">        &gt;&gt;&gt; sig=sqrt(rdnoise*rdnoise + abs(mFit[iCol,iFil]/gain))</span>

<span class="sd">        and the outliers are defined as:</span>
<span class="sd">        &gt;&gt;&gt; iBad=where(mBuff-mFit gt thresh*sig)</span>

<span class="sd">        &gt;&gt;&gt; Bad values are replaced from the fit:</span>
<span class="sd">        &gt;&gt;&gt; mBuff[iBad]=mFit[iBad]</span>

<span class="sd">        and mBuff is summed across the file dimension to create an output row.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list(str)</span>
<span class="sd">        list of fits files to combine</span>
<span class="sd">    instrument : str</span>
<span class="sd">        instrument id for modinfo</span>
<span class="sd">    mode : str</span>
<span class="sd">        instrument mode</span>
<span class="sd">    extension : int, optional</span>
<span class="sd">        fits extension to load (default: 1)</span>
<span class="sd">    threshold : float, optional</span>
<span class="sd">        threshold for bad pixels (default: 3.5)</span>
<span class="sd">    window : int, optional</span>
<span class="sd">        horizontal window size (default: 50)</span>
<span class="sd">    mask : array(bool), optional</span>
<span class="sd">        mask for the fits image (default: None)</span>
<span class="sd">    xr : int, optional</span>
<span class="sd">        xrange (default: None)</span>
<span class="sd">    yr : int, optional</span>
<span class="sd">        yrange (default: None)</span>
<span class="sd">    debug : bool, optional</span>
<span class="sd">        show debug plot of noise distribution (default: False)</span>
<span class="sd">    dtype : np.dtype, optional</span>
<span class="sd">        datatype of the combined image (default float32)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    combined_data, header</span>
<span class="sd">        combined image data, header</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEBUG_NROWS</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># print status update every DEBUG_NROWS rows (if debug is True)</span>
    <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">load_instrument</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>

    <span class="c1"># summarize file info</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Files:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)),</span> <span class="n">files</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="c1"># Only one image</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No files given for combine frames&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
            <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_readn&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">total_exposure_time</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">n_fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_linear&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Two images</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bias1</span><span class="p">,</span> <span class="n">head1</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
            <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">exp1</span> <span class="o">=</span> <span class="n">head1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bias2</span><span class="p">,</span> <span class="n">head2</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
            <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">head2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="n">head2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_readn&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bias2</span> <span class="o">+</span> <span class="n">bias1</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">head2</span>

        <span class="n">total_exposure_time</span> <span class="o">=</span> <span class="n">exp1</span> <span class="o">+</span> <span class="n">exp2</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">readnoise</span><span class="p">)</span>
        <span class="n">n_fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_linear&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># More than two images</span>
        <span class="c1"># Get information from headers</span>
        <span class="c1"># TODO: check if all values are the same in all the headers?</span>

        <span class="n">heads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">header_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span>
        <span class="p">]</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">heads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if sizes vary, it will show during loading of the data</span>
        <span class="n">n_columns</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="s2">&quot;naxis1&quot;</span><span class="p">]</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="s2">&quot;naxis2&quot;</span><span class="p">]</span>

        <span class="c1"># check if we deal with multiple amplifiers</span>
        <span class="n">n_amplifier</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_ampl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># check orientation of the image</span>
        <span class="c1"># orient 0, 2, 5, 7: orders are horizontal</span>
        <span class="c1"># orient 1, 3, 4, 6: orders are vertical</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_orient&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">transpose</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_transpose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="c1"># check if non-linearity correction</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_linear&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># section(s) of the detector to process, x_low, x_high, y_low, y_high</span>
        <span class="c1"># head[&quot;e_xlo*&quot;] will find all entries with * as a wildcard</span>
        <span class="c1"># we also ensure that we will have one dimensional arrays (not just the value)</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_xlo*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_xhi*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_ylo*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_yhi*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>

        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_gain*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_readn*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cards</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
        <span class="n">total_exposure_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">)</span>

        <span class="c1"># Scaling for image data</span>
        <span class="n">bscale</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bscale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">]</span>
        <span class="n">bzero</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bzero&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_columns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># the combined image</span>
        <span class="n">n_fixed</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of fixed pixels</span>

        <span class="c1"># Load all image hdus, but leave the data on the disk, using memmap</span>
        <span class="c1"># Need to scale data later</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_extension</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="p">[</span><span class="n">extension</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">heads</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">e</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;=</span> <span class="n">n_columns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">n_columns</span> <span class="o">//</span> <span class="mi">10</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Reduce Window size to fit the image&quot;</span><span class="p">)</span>

        <span class="c1"># depending on the orientation the indexing changes and the borders of the image change</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
            <span class="c1"># idx gives the index for accessing the data in the image, which is rotated depending on the orientation</span>
            <span class="c1"># We could just rotate the whole image, but that requires reading the whole image at once</span>
            <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">x_left</span><span class="p">,</span> <span class="n">x_right</span><span class="p">:</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">x_left</span><span class="p">,</span> <span class="n">x_right</span><span class="p">),</span> <span class="n">row</span><span class="p">)</span>
            <span class="c1"># Exchange the borders of the image</span>
            <span class="n">x_low</span><span class="p">,</span> <span class="n">x_high</span><span class="p">,</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">y_high</span> <span class="o">=</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">y_high</span><span class="p">,</span> <span class="n">x_low</span><span class="p">,</span> <span class="n">x_high</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">x_left</span><span class="p">,</span> <span class="n">x_right</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x_left</span><span class="p">,</span> <span class="n">x_right</span><span class="p">))</span>

        <span class="c1"># For several amplifiers, different sections of the image are set</span>
        <span class="c1"># One for each amplifier, each amplifier is treated seperately</span>
        <span class="k">for</span> <span class="n">amplifier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_amplifier</span><span class="p">):</span>
            <span class="c1"># Pick data for current amplifier</span>
            <span class="n">x_left</span> <span class="o">=</span> <span class="n">x_low</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>
            <span class="n">x_right</span> <span class="o">=</span> <span class="n">x_high</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>
            <span class="n">y_bottom</span> <span class="o">=</span> <span class="n">y_low</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>
            <span class="n">y_top</span> <span class="o">=</span> <span class="n">y_high</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>

            <span class="n">gain_amp</span> <span class="o">=</span> <span class="n">gain</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>
            <span class="n">readnoise_amp</span> <span class="o">=</span> <span class="n">readnoise</span><span class="p">[</span><span class="n">amplifier</span><span class="p">]</span>

            <span class="c1"># Prepare temporary arrays</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">x_right</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">))</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">x_right</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">))</span>

            <span class="c1"># for each row</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">y_bottom</span><span class="p">,</span> <span class="n">y_top</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rows&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">%</span> <span class="n">DEBUG_NROWS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> rows processed - </span><span class="si">%i</span><span class="s2"> pixels fixed so far&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_fixed</span>
                    <span class="p">)</span>

                <span class="c1"># load current row</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">x_left</span><span class="p">,</span> <span class="n">x_right</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
                    <span class="c1"># If the following causes int16 overflow, add .astype(&#39;float64&#39;)</span>
                    <span class="c1"># to the first term. The receiving buffer is f64 anyway.</span>
                    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">bscale</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bzero</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># Calculate probabilities</span>
                <span class="n">probability</span><span class="p">[:,</span> <span class="n">window</span><span class="p">:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_probability</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>

                <span class="c1"># extrapolate to edges</span>
                <span class="n">probability</span><span class="p">[:,</span> <span class="p">:</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">probability</span><span class="p">[:,</span> <span class="n">window</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">probability</span><span class="p">[:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">window</span> <span class="p">:</span> <span class="n">window</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">probability</span><span class="p">[:,</span> <span class="o">-</span><span class="n">window</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">probability</span><span class="p">[:,</span> <span class="o">-</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">probability</span><span class="p">[:,</span> <span class="o">-</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">window</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># fix bad pixels</span>
                <span class="n">result</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">n_bad</span> <span class="o">=</span> <span class="n">fix_bad_pixels</span><span class="p">(</span>
                    <span class="n">probability</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">readnoise_amp</span><span class="p">,</span> <span class="n">gain_amp</span><span class="p">,</span> <span class="n">threshold</span>
                <span class="p">)</span>
                <span class="n">n_fixed</span> <span class="o">+=</span> <span class="n">n_bad</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;total cosmic ray hits identified and removed: </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n_fixed</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">clipnflip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close open FITS files</span>

    <span class="c1"># Add info to header.</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;bzero&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;bscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_exposure_time</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;darktime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_exposure_time</span>
    <span class="c1"># Because we do not divide the signal by the number of files the</span>
    <span class="c1"># read-out noise goes up by the square root of the number of files</span>

    <span class="k">for</span> <span class="n">n_amp</span><span class="p">,</span> <span class="n">rdn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">readnoise</span><span class="p">):</span>
        <span class="n">head</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rdnoise</span><span class="si">{</span><span class="n">n_amp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">0&gt;1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rdn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)),</span>
            <span class="s2">&quot; noise in combined image, electrons&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;nimages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="s2">&quot; number of images summed&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;npixfix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_fixed</span><span class="p">,</span> <span class="s2">&quot; pixels corrected for cosmic rays&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span>
        <span class="s2">&quot;images coadded by combine_frames.py on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">linear</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># non-linearity was fixed. mark this in the header</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>  <span class="c1"># TODO Nonlinear</span>
        <span class="c1"># i = np.where(head[&quot;e_linear&quot;] &gt;= 0)</span>
        <span class="c1"># head[i] = np.array((head[0 : i - 1 + 1], head[i + 1 :]))</span>
        <span class="c1"># head[&quot;e_linear&quot;] = (&quot;t&quot;, &quot; image corrected of non-linearity&quot;)</span>

        <span class="c1"># ii = np.where(head[&quot;e_gain*&quot;] &gt;= 0)</span>
        <span class="c1"># if len(ii[0]) &gt; 0:</span>
        <span class="c1">#     for i in range(len(ii[0])):</span>
        <span class="c1">#         k = ii[i]</span>
        <span class="c1">#         head = np.array((head[0 : k - 1 + 1], head[k + 1 :]))</span>
        <span class="c1"># head[&quot;e_gain&quot;] = (1, &quot; image was converted to e-&quot;)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">head</span></div>



<div class="viewcode-block" id="combine_calibrate">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.combine_calibrate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_calibrate</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span>
    <span class="n">instrument</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">,</span>
    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bhead</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bias_scaling</span><span class="o">=</span><span class="s2">&quot;exposure_time&quot;</span><span class="p">,</span>
    <span class="n">norm_scaling</span><span class="o">=</span><span class="s2">&quot;divide&quot;</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine the input files and then calibrate the image with the bias</span>
<span class="sd">    and normalized flat field if provided</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        list of file names to load</span>
<span class="sd">    instrument : Instrument</span>
<span class="sd">        PyReduce instrument object with load_fits method</span>
<span class="sd">    mode : str</span>
<span class="sd">        descriptor of the instrument mode</span>
<span class="sd">    mask : array</span>
<span class="sd">        2D Bad Pixel Mask to apply to the master image</span>
<span class="sd">    bias : tuple(bias, bhead), optional</span>
<span class="sd">        bias correction to apply to the combiend image, if bias has 3 dimensions</span>
<span class="sd">        it is used as polynomial coefficients scaling with the exposure time, by default None</span>
<span class="sd">    norm_flat : tuple(norm, blaze), optional</span>
<span class="sd">        normalized flat to divide the combined image with after</span>
<span class="sd">        the bias subtraction, by default None</span>
<span class="sd">    bias_scaling : str, optional</span>
<span class="sd">        defines how the bias is subtracted, by default &quot;exposure_time&quot;</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        whether to plot the results, by default False</span>
<span class="sd">    plot_title : str, optional</span>
<span class="sd">        Name to put on the plot, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    orig : array</span>
<span class="sd">        combined image with calibrations applied</span>
<span class="sd">    thead : Header</span>
<span class="sd">        header of the combined image</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Unrecognised bias_scaling option</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Combine the images and try to remove bad pixels</span>
    <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">combine_frames</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Subtract bias</span>
    <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bias_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bias_scaling</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bias</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">bhead</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;exposure_time&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No exposure time set in bias, using number of files instead&quot;</span>
                <span class="p">)</span>
                <span class="n">bias_scaling</span> <span class="o">=</span> <span class="s2">&quot;number_of_files&quot;</span>
            <span class="k">if</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;exposure_time&quot;</span><span class="p">:</span>
                <span class="n">orig</span> <span class="o">-=</span> <span class="n">bias</span> <span class="o">*</span> <span class="n">thead</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">bhead</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;number_of_files&quot;</span><span class="p">:</span>
                <span class="n">orig</span> <span class="o">-=</span> <span class="n">bias</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">orig</span> <span class="o">-=</span> <span class="n">bias</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="n">orig</span> <span class="o">-=</span> <span class="n">bias</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected value for &#39;bias_scaling&#39;, expected one of [&#39;exposure_time&#39;, &#39;number_of_files&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;none&#39;], but got </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="n">bias_scaling</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bias_scaling</span> <span class="o">==</span> <span class="s2">&quot;exposure_time&quot;</span><span class="p">:</span>
                <span class="n">orig</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">thead</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">])</span>
            <span class="c1"># elif bias_scaling == &quot;number_of_files&quot;:</span>
            <span class="c1">#     flat -= bias * len(files)</span>
            <span class="c1"># elif bias_scaling == &quot;mean&quot;:</span>
            <span class="c1">#     flat -= bias * np.ma.mean(flat) / np.ma.mean(bias)</span>
            <span class="c1"># elif bias_scaling == &quot;median&quot;:</span>
            <span class="c1">#     flat -= bias * np.ma.median(flat) / np.ma.median(bias)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected value for &#39;bias_scaling&#39;, expected one of [&#39;exposure_time&#39;], but got </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="n">bias_scaling</span>
                <span class="p">)</span>

    <span class="c1"># Remove the Flat</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">norm_scaling</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">norm_scaling</span> <span class="o">==</span> <span class="s2">&quot;divide&quot;</span><span class="p">:</span>
            <span class="n">orig</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected value for &#39;norm_scaling&#39;, expected one of [&#39;divide&#39;, &#39;none&#39;], but got </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">norm_scaling</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Master&quot;</span>
        <span class="k">if</span> <span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
        <span class="n">bot</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">orig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bot</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">top</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="o">!=</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;crires_master_flat.png&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span></div>



<div class="viewcode-block" id="combine_polynomial">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.combine_polynomial">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_polynomial</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine the input files by fitting a polynomial of the pixel value versus</span>
<span class="sd">    the exposure time of each pixel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        list of file names</span>
<span class="sd">    instrument : Instrument</span>
<span class="sd">        PyReduce instrument object with load_fits method</span>
<span class="sd">    mode : str</span>
<span class="sd">        mode identifier for this instrument</span>
<span class="sd">    mask : array</span>
<span class="sd">        bad pixel mask to apply to the coefficients</span>
<span class="sd">    degree : int, optional</span>
<span class="sd">        polynomial degree of the fit, by default 1</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        whether to plot the results, by default False</span>
<span class="sd">    plot_title : str, optional</span>
<span class="sd">        Title of the plot, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bias : array</span>
<span class="sd">        3d array with the coefficients for each pixel</span>
<span class="sd">    bhead : Header</span>
<span class="sd">        combined FITS header of the coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdus</span> <span class="o">=</span> <span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">)]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdus</span><span class="p">])</span>
    <span class="n">exptimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdus</span><span class="p">])</span>
    <span class="c1"># Numpy polyfit can fit all polynomials at the same time</span>
    <span class="c1"># but we need to flatten the pixels into 1 dimension</span>
    <span class="n">data_flat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">exptimes</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">exptimes</span><span class="p">,</span> <span class="n">data_flat</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
    <span class="c1"># Afterwards we reshape the coefficients into the image shape</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># And apply the mask to each image of coefficients</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[</span><span class="n">mask</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="c1"># We arbitralily pick the first header as the bias header</span>
    <span class="c1"># and change the exposure time</span>
    <span class="n">bhead</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bhead</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exptimes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Master&quot;</span>
        <span class="k">if</span> <span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Coefficient </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">degree</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
            <span class="n">bot</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bot</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">top</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="o">!=</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;master_bias.png&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span></div>



<div class="viewcode-block" id="combine_bias">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.combine_frames.combine_bias">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_bias</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span>
    <span class="n">instrument</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">,</span>
    <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">science_observation_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine bias frames, determine read noise, reject bad pixels.</span>
<span class="sd">    Read noise calculation only valid if both lists yield similar noise.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list(str)</span>
<span class="sd">        bias files to combine</span>
<span class="sd">    instrument : str</span>
<span class="sd">        instrument mode for modinfo</span>
<span class="sd">    extension : {int, str}, optional</span>
<span class="sd">        fits extension to use (default: 1)</span>
<span class="sd">    xr : 2-tuple(int), optional</span>
<span class="sd">        x range to use (default: None, i.e. whole image)</span>
<span class="sd">    yr : 2-tuple(int), optional</span>
<span class="sd">        y range to use (default: None, i.e. whole image)</span>
<span class="sd">    dtype : np.dtype, optional</span>
<span class="sd">        datatype of the combined bias frame (default: float32)</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bias, bhead</span>
<span class="sd">        bias image and header</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No bias file(s) given&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># if there is just one element compare it with itself, not really useful, but it works</span>
        <span class="n">list1</span> <span class="o">=</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">files</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list1</span><span class="p">,</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">files</span><span class="p">[:</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">files</span><span class="p">[</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>

    <span class="c1"># Lists of images.</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span>

    <span class="c1"># Separately images in two groups.</span>
    <span class="n">bias1</span><span class="p">,</span> <span class="n">head1</span> <span class="o">=</span> <span class="n">combine_frames</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">bias1</span> <span class="o">/=</span> <span class="n">n1</span>

    <span class="n">bias2</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="n">combine_frames</span><span class="p">(</span><span class="n">list2</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">bias2</span> <span class="o">/=</span> <span class="n">n2</span>

    <span class="c1"># Make sure we know the gain.</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_gain*&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Construct normalized sum.</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">bias1</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">bias2</span> <span class="o">*</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">exptime_1</span> <span class="o">=</span> <span class="n">head1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">exptime_2</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">exptime_1</span> <span class="o">+</span> <span class="n">exptime_2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

    <span class="c1"># Compute noise in difference image by fitting Gaussian to distribution.</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bias1</span> <span class="o">-</span> <span class="n">bias2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
        <span class="n">crude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>  <span class="c1"># estimate of noise</span>
        <span class="n">hmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">crude</span>
        <span class="n">hmax</span> <span class="o">=</span> <span class="o">+</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">crude</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">hmax</span> <span class="o">-</span> <span class="n">hmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>

        <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">)</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">hmin</span> <span class="o">+</span> <span class="n">bin_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="n">hfit</span><span class="p">,</span> <span class="n">par</span> <span class="o">=</span> <span class="n">gaussfit</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># noise in diff, bias</span>

        <span class="c1"># Determine where wings of distribution become significantly non-Gaussian.</span>
        <span class="n">contam</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">hfit</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">hfit</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">imid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">noise</span><span class="p">)</span>
        <span class="n">consig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">contam</span><span class="p">[</span><span class="n">imid</span><span class="p">])</span>

        <span class="n">smcontam</span> <span class="o">=</span> <span class="n">gaussbroad</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">contam</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">noise</span><span class="p">)</span>
        <span class="n">igood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">smcontam</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">consig</span><span class="p">)</span>
        <span class="n">gmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xh</span><span class="p">[</span><span class="n">igood</span><span class="p">])</span>
        <span class="n">gmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xh</span><span class="p">[</span><span class="n">igood</span><span class="p">])</span>

        <span class="c1"># Find and fix bad pixels.</span>
        <span class="n">ibad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">gmin</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="n">gmax</span><span class="p">))</span>
        <span class="n">nbad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">bias</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bias1</span><span class="p">[</span><span class="n">ibad</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bias2</span><span class="p">[</span><span class="n">ibad</span><span class="p">])</span>

        <span class="c1"># Compute read noise.</span>
        <span class="n">biasnoise</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="n">noise</span>
        <span class="n">bgnoise</span> <span class="o">=</span> <span class="n">biasnoise</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Print diagnostics.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;change in bias between image sets= </span><span class="si">%f</span><span class="s2"> electrons&quot;</span><span class="p">,</span> <span class="n">gain</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;measured background noise per image= </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bgnoise</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;background noise in combined image= </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">biasnoise</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fixing </span><span class="si">%i</span><span class="s2"> bad pixels&quot;</span><span class="p">,</span> <span class="n">nbad</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># Plot noise distribution.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">hfit</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;noise distribution&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">gmin</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">gmax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

            <span class="c1"># Plot contamination estimation.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">contam</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xh</span><span class="p">,</span> <span class="n">smcontam</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">consig</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">gmin</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">gmax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;contamination estimation&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">biasnoise</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">nbad</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Master Bias&quot;</span>
        <span class="k">if</span> <span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
        <span class="n">bot</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bot</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">top</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;obslist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;nimages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;number of images summed&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;npixfix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbad</span><span class="p">,</span> <span class="s2">&quot;pixels corrected for cosmic rays&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;bgnoise&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">biasnoise</span><span class="p">,</span> <span class="s2">&quot;noise in combined image, electrons&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bias</span><span class="p">,</span> <span class="n">head</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>