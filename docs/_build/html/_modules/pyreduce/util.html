<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.util &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.util</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Collection of various useful and/or reoccuring functions across PyReduce</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.interpolate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">lstsq</span><span class="p">,</span> <span class="n">solve_banded</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">least_squares</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">binom</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="resample">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.resample">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resample</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">new_size</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">new_size</span><span class="p">)</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_bias">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.remove_bias">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_bias</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ihead</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span><span class="p">,</span> <span class="n">nfiles</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bhead</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b_exptime</span> <span class="o">=</span> <span class="n">bhead</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span>
        <span class="n">i_exptime</span> <span class="o">=</span> <span class="n">ihead</span><span class="p">[</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b_exptime</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_exptime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b_exptime</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i_exptime</span> <span class="o">=</span> <span class="n">nfiles</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">-</span> <span class="n">bias</span> <span class="o">*</span> <span class="n">i_exptime</span> <span class="o">/</span> <span class="n">b_exptime</span>
    <span class="k">return</span> <span class="n">img</span></div>



<div class="viewcode-block" id="in_ipynb">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.in_ipynb">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">in_ipynb</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;IPKernelApp&quot;</span><span class="p">][</span><span class="s2">&quot;parent_appname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ipython-notebook&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="log_version">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.log_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For Debug purposes&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PyReduce version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span></div>



<div class="viewcode-block" id="start_logging">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.start_logging">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">start_logging</span><span class="p">(</span><span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;log.log&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start logging to log file and command line</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_file : str, optional</span>
<span class="sd">        name of the logging file (default: &quot;log.log&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)-15s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(name)-8s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log_version</span><span class="p">()</span></div>



<div class="viewcode-block" id="vac2air">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.vac2air">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">vac2air</span><span class="p">(</span><span class="n">wl_vac</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert vacuum wavelengths to wavelengths in air</span>
<span class="sd">    Author: Nikolai Piskunov</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wl_air</span> <span class="o">=</span> <span class="n">wl_vac</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wl_vac</span> <span class="o">&gt;</span> <span class="mf">2e3</span><span class="p">)</span>

    <span class="n">sigma2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e4</span> <span class="o">/</span> <span class="n">wl_vac</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Compute wavenumbers squared</span>
    <span class="n">fact</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">1e0</span>
        <span class="o">+</span> <span class="mf">8.34254e-5</span>
        <span class="o">+</span> <span class="mf">2.406147e-2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">130e0</span> <span class="o">-</span> <span class="n">sigma2</span><span class="p">)</span>
        <span class="o">+</span> <span class="mf">1.5998e-4</span> <span class="o">/</span> <span class="p">(</span><span class="mf">38.9e0</span> <span class="o">-</span> <span class="n">sigma2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">wl_air</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl_vac</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="n">fact</span>  <span class="c1"># Convert to air wavelength</span>
    <span class="k">return</span> <span class="n">wl_air</span></div>



<div class="viewcode-block" id="air2vac">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.air2vac">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">air2vac</span><span class="p">(</span><span class="n">wl_air</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert wavelengths in air to vacuum wavelength</span>
<span class="sd">    Author: Nikolai Piskunov</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wl_vac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wl_air</span><span class="p">)</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wl_air</span> <span class="o">&gt;</span> <span class="mf">1999.352</span><span class="p">)</span>

    <span class="n">sigma2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e4</span> <span class="o">/</span> <span class="n">wl_air</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Compute wavenumbers squared</span>
    <span class="n">fact</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">1e0</span>
        <span class="o">+</span> <span class="mf">8.336624212083e-5</span>
        <span class="o">+</span> <span class="mf">2.408926869968e-2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.301065924522e2</span> <span class="o">-</span> <span class="n">sigma2</span><span class="p">)</span>
        <span class="o">+</span> <span class="mf">1.599740894897e-4</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.892568793293e1</span> <span class="o">-</span> <span class="n">sigma2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">wl_vac</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl_air</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">fact</span>  <span class="c1"># Convert to vacuum wavelength</span>
    <span class="k">return</span> <span class="n">wl_vac</span></div>



<div class="viewcode-block" id="swap_extension">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.swap_extension">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">swap_extension</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;exchange the extension of the given file with a new one&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">nameout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nameout</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
        <span class="n">nameout</span> <span class="o">=</span> <span class="n">nameout</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">nameout</span> <span class="o">=</span> <span class="n">nameout</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nameout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">nameout</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nameout</span></div>



<div class="viewcode-block" id="find_first_index">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.find_first_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_first_index</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;find the first element equal to value in the array arr&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Value </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="interpolate_masked">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.interpolate_masked">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interpolate_masked</span><span class="p">(</span><span class="n">masked</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolate masked values, from non masked values</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    masked : masked_array</span>
<span class="sd">        masked array to interpolate on</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    interpolated : array</span>
<span class="sd">        interpolated non masked array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">interpol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masked</span><span class="p">)),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">masked</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">interpol</span></div>



<div class="viewcode-block" id="cutout_image">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.cutout_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cutout_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cut a section of an image out</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array</span>
<span class="sd">        image</span>
<span class="sd">    ymin : array[ncol](int)</span>
<span class="sd">        lower y value</span>
<span class="sd">    ymax : array[ncol](int)</span>
<span class="sd">        upper y value</span>
<span class="sd">    xmin : int</span>
<span class="sd">        lower x value</span>
<span class="sd">    xmax : int</span>
<span class="sd">        upper x value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cutout : array[height, ncol]</span>
<span class="sd">        selection of the image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cutout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ymax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)):</span>
        <span class="n">cutout</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">ymin</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">:</span> <span class="n">ymax</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cutout</span></div>



<div class="viewcode-block" id="make_index">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.make_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_index</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an index (numpy style) that will select part of an image with changing position but fixed height</span>

<span class="sd">    The user is responsible for making sure the height is constant, otherwise it will still work, but the subsection will not have the desired format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ymin : array[ncol](int)</span>
<span class="sd">        lower y border</span>
<span class="sd">    ymax : array[ncol](int)</span>
<span class="sd">        upper y border</span>
<span class="sd">    xmin : int</span>
<span class="sd">        leftmost column</span>
<span class="sd">    xmax : int</span>
<span class="sd">        rightmost colum</span>
<span class="sd">    zero : bool, optional</span>
<span class="sd">        if True count y array from 0 instead of xmin (default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    index : tuple(array[height, width], array[height, width])</span>
<span class="sd">        numpy index for the selection of a subsection of an image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO</span>
    <span class="c1"># Define the indices for the pixels between two y arrays, e.g. pixels in an order</span>
    <span class="c1"># in x: the rows between ymin and ymax</span>
    <span class="c1"># in y: the column, but n times to match the x index</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zero</span><span class="p">:</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">xmin</span>

    <span class="n">index_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">ymax</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">zero</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">zero</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">index_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ymax</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">zero</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">zero</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">index_x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">index_y</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">zero</span>

    <span class="k">return</span> <span class="n">index</span></div>



<div class="viewcode-block" id="gridsearch">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gridsearch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gridsearch</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">matrix</span></div>



<div class="viewcode-block" id="gaussfit">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussfit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a simple gaussian to data</span>

<span class="sd">    gauss(x, a, mu, sigma) = a * exp(-z**2/2)</span>
<span class="sd">    with z = (x - mu) / sigma</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array(float)</span>
<span class="sd">        x values</span>
<span class="sd">    y : array(float)</span>
<span class="sd">        y values</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gauss(x), parameters</span>
<span class="sd">        fitted values for x, fit paramters (a, mu, sigma)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">gauss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">:</span> <span class="n">A0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">A1</span><span class="p">)</span> <span class="o">/</span> <span class="n">A2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span> <span class="n">popt</span></div>



<div class="viewcode-block" id="gaussfit2">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussfit2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussfit2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit a gaussian(normal) curve to data x, y</span>

<span class="sd">    gauss = A * exp(-(x-mu)**2/(2*sig**2)) + offset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array[n]</span>
<span class="sd">        x values</span>
<span class="sd">    y : array[n]</span>
<span class="sd">        y values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt : array[4]</span>
<span class="sd">        coefficients of the gaussian: A, mu, sigma**2, offset</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gaussval2</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All values masked&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The masks of x and y are different&quot;</span><span class="p">)</span>

    <span class="c1"># Find the peak in the center of the image</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">midpoint</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">weights</span><span class="p">[:</span><span class="n">midpoint</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">midpoint</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">weights</span><span class="p">[</span><span class="n">midpoint</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">midpoint</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span>
            <span class="n">p0</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;soft_l1&quot;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">popt</span></div>



<div class="viewcode-block" id="gaussfit3">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussfit3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussfit3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A very simple (and relatively fast) gaussian fit</span>
<span class="sd">    gauss = A * exp(-(x-mu)**2/(2*sig**2)) + offset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array of shape (n,)</span>
<span class="sd">        x data</span>
<span class="sd">    y : array of shape (n,)</span>
<span class="sd">        y data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt : list of shape (4,)</span>
<span class="sd">        Parameters A, mu, sigma**2, offset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gaussval2</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">//</span> <span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">popt</span></div>



<div class="viewcode-block" id="gaussfit4">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussfit4">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussfit4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A very simple (and relatively fast) gaussian fit</span>
<span class="sd">    gauss = A * exp(-(x-mu)**2/(2*sig**2)) + offset</span>

<span class="sd">    Assumes x is sorted</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array of shape (n,)</span>
<span class="sd">        x data</span>
<span class="sd">    y : array of shape (n,)</span>
<span class="sd">        y data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt : list of shape (4,)</span>
<span class="sd">        Parameters A, mu, sigma**2, offset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gaussval2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">popt</span></div>



<div class="viewcode-block" id="gaussfit_linear">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussfit_linear">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussfit_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the gaussian fit into a linear least squares problem, and solve that instead of the non-linear curve fit</span>
<span class="sd">    For efficiency reasons. (roughly 10 times faster than the curve fit)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array of shape (n,)</span>
<span class="sd">        x data</span>
<span class="sd">    y : array of shape (n,)</span>
<span class="sd">        y data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coef : tuple</span>
<span class="sd">        a, mu, sig, 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">+</span> <span class="mf">1e-12</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">y</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">G</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">G</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">beta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">((</span><span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="gaussval2">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussval2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussval2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">const</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig</span><span class="p">))</span> <span class="o">+</span> <span class="n">const</span></div>



<div class="viewcode-block" id="gaussbroad">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.gaussbroad">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gaussbroad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">hwhm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply gaussian broadening to x, y data with half width half maximum hwhm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array(float)</span>
<span class="sd">        x values</span>
<span class="sd">    y : array(float)</span>
<span class="sd">        y values</span>
<span class="sd">    hwhm : float &gt; 0</span>
<span class="sd">        half width half maximum</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array(float)</span>
<span class="sd">        broadened y values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># alternatively use:</span>
    <span class="c1"># from scipy.ndimage.filters import gaussian_filter1d as gaussbroad</span>
    <span class="c1"># but that doesn&#39;t have an x coordinate</span>

    <span class="n">nw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hwhm</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">nhalf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">3.3972872</span> <span class="o">*</span> <span class="n">hwhm</span> <span class="o">/</span> <span class="n">dw</span><span class="p">)</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nhalf</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># points in gaussian (odd!)</span>
    <span class="c1"># wavelength scale of gaussian</span>
    <span class="n">wg</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ng</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">xg</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.83255461</span> <span class="o">/</span> <span class="n">hwhm</span><span class="p">)</span> <span class="o">*</span> <span class="n">wg</span>  <span class="c1"># convenient absisca</span>
    <span class="n">gpro</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.46974832</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">/</span> <span class="n">hwhm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span> <span class="o">*</span> <span class="n">xg</span><span class="p">)</span>  <span class="c1"># unit area gaussian w/ FWHM</span>
    <span class="n">gpro</span> <span class="o">=</span> <span class="n">gpro</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gpro</span><span class="p">)</span>

    <span class="c1"># Pad spectrum ends to minimize impact of Fourier ringing.</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="n">nhalf</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># pad pixels on each end</span>
    <span class="n">spad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">npad</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">npad</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>

    <span class="c1"># Convolve and trim.</span>
    <span class="n">sout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">spad</span><span class="p">,</span> <span class="n">gpro</span><span class="p">)</span>  <span class="c1"># convolve with gaussian</span>
    <span class="n">sout</span> <span class="o">=</span> <span class="n">sout</span><span class="p">[</span><span class="n">npad</span> <span class="p">:</span> <span class="n">npad</span> <span class="o">+</span> <span class="n">nw</span><span class="p">]</span>  <span class="c1"># trim to original data / length</span>
    <span class="k">return</span> <span class="n">sout</span>  <span class="c1"># return broadened spectrum.</span></div>



<div class="viewcode-block" id="polyfit1d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyfit1d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyfit1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">regularization</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">regularization</span> <span class="o">*</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">])</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">A</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">I</span> <span class="o">@</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">b</span>

    <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">coeff</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_coeff_idx</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># degree = coeff.shape</span>
    <span class="c1"># idx = [[i, j] for i, j in product(range(degree[0]), range(degree[1]))]</span>
    <span class="c1"># idx = np.asarray(idx)</span>
    <span class="k">return</span> <span class="n">idx</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_scale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Normalize x and y to avoid huge numbers</span>
    <span class="c1"># Mean 0, Variation 1</span>
    <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">norm_x</span><span class="p">,</span> <span class="n">norm_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">norm_x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">norm_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">norm_y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">offset_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_x</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">offset_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_y</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">norm_x</span><span class="p">,</span> <span class="n">norm_y</span><span class="p">),</span> <span class="p">(</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_unscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>


<div class="viewcode-block" id="polyvander2d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyvander2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyvander2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">degree</span><span class="p">):</span>
    <span class="c1"># A = np.array([x ** i * y ** j for i, j in idx], dtype=float).T</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyvander2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span></div>



<div class="viewcode-block" id="polyscale2d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyscale2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyscale2d</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_get_coeff_idx</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale_x</span><span class="o">**</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale_y</span><span class="o">**</span><span class="n">j</span>
    <span class="k">return</span> <span class="n">coeff</span></div>



<div class="viewcode-block" id="polyshift2d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyshift2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyshift2d</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_get_coeff_idx</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="c1"># Copy coeff because it changes during the loop</span>
    <span class="n">coeff2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
        <span class="n">not_the_same</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">idx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">above</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_the_same</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="n">above</span><span class="p">]:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">binom</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">binom</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">m</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_x</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">offset_y</span> <span class="o">**</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">coeff2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">coeff</span></div>



<div class="viewcode-block" id="plot2d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.plot2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># regular grid covering the domain of the data</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">choice</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">choice</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyval2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="c1"># ax.axis(&quot;equal&quot;)</span>
    <span class="c1"># ax.axis(&quot;tight&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="polyfit2d">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyfit2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyfit2d</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_degree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple 2D plynomial fit to data x, y, z</span>
<span class="sd">    The polynomial can be evaluated with numpy.polynomial.polynomial.polyval2d</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array[n]</span>
<span class="sd">        x coordinates</span>
<span class="sd">    y : array[n]</span>
<span class="sd">        y coordinates</span>
<span class="sd">    z : array[n]</span>
<span class="sd">        data values</span>
<span class="sd">    degree : int, optional</span>
<span class="sd">        degree of the polynomial fit (default: 1)</span>
<span class="sd">    max_degree : {int, None}, optional</span>
<span class="sd">        if given the maximum combined degree of the coefficients is limited to this value</span>
<span class="sd">    scale : bool, optional</span>
<span class="sd">        Wether to scale the input arrays x and y to mean 0 and variance 1, to avoid numerical overflows.</span>
<span class="sd">        Especially useful at higher degrees. (default: True)</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        wether to plot the fitted surface and data (slow) (default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff : array[degree+1, degree+1]</span>
<span class="sd">        the polynomial coefficients in numpy 2d format, i.e. coeff[i, j] for x**i * y**j</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Flatten input</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Removed masked values</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">_scale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Create combinations of degree of x and y</span>
    <span class="c1"># usually: [(0, 0), (1, 0), (0, 1), (1, 1), (2, 0), ....]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Only 2D polynomials can be fitted&quot;</span>
    <span class="n">degree</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="c1"># idx = [[i, j] for i, j in product(range(degree[0] + 1), range(degree[1] + 1))]</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">degree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">degree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_get_coeff_idx</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>

    <span class="c1"># Calculate elements 1, x, y, x*y, x**2, y**2, ...</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">polyvander2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>

    <span class="c1"># We only want the combinations with maximum order COMBINED power</span>
    <span class="k">if</span> <span class="n">max_degree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_degree</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Do least squares fit</span>
    <span class="n">C</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="c1"># Reorder coefficients into numpy compatible 2d array</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># # Backup copy of coeff</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">polyscale2d</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="o">*</span><span class="n">norm</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">polyshift2d</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_unscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">plot2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coeff</span></div>



<div class="viewcode-block" id="polyfit2d_2">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.polyfit2d_2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polyfit2d_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;arctan&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;trf&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span>
        <span class="n">degree_x</span> <span class="o">=</span> <span class="n">degree_y</span> <span class="o">=</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">degree_x</span> <span class="o">=</span> <span class="n">degree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">degree_y</span> <span class="o">=</span> <span class="n">degree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">polyval2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyval2d</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">degree_x</span><span class="p">,</span> <span class="n">degree_y</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">polyval2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">-</span> <span class="n">z</span>

    <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">degree_x</span> <span class="o">*</span> <span class="n">degree_y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">degree_x</span><span class="p">,</span> <span class="n">degree_y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># regular grid covering the domain of the data</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">choice</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">choice</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyval2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">coef</span></div>



<div class="viewcode-block" id="bezier_interp">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.bezier_interp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bezier_interp</span><span class="p">(</span><span class="n">x_old</span><span class="p">,</span> <span class="n">y_old</span><span class="p">,</span> <span class="n">x_new</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bezier interpolation, based on the scipy methods</span>

<span class="sd">    This mostly sanitizes the input by removing masked values and duplicate entries</span>
<span class="sd">    Note that in case of duplicate entries (in x_old) the results are not well defined as only one of the entries is used and the other is discarded</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_old : array[n]</span>
<span class="sd">        old x values</span>
<span class="sd">    y_old : array[n]</span>
<span class="sd">        old y values</span>
<span class="sd">    x_new : array[m]</span>
<span class="sd">        new x values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_new : array[m]</span>
<span class="sd">        new y values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Handle masked arrays</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">x_old</span><span class="p">):</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">y_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">y_old</span><span class="p">)</span>

    <span class="c1"># avoid duplicate entries in x</span>
    <span class="k">assert</span> <span class="n">x_old</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">y_old</span><span class="o">.</span><span class="n">size</span>
    <span class="n">x_old</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_old</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y_old</span> <span class="o">=</span> <span class="n">y_old</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="n">knots</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x_old</span><span class="p">,</span> <span class="n">y_old</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y_new</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">order</span><span class="p">)(</span><span class="n">x_new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_new</span></div>



<div class="viewcode-block" id="safe_interpolation">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.safe_interpolation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_interpolation</span><span class="p">(</span><span class="n">x_old</span><span class="p">,</span> <span class="n">y_old</span><span class="p">,</span> <span class="n">x_new</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &#39;Safe&#39; interpolation method that should avoid</span>
<span class="sd">    the common pitfalls of spline interpolation</span>

<span class="sd">    masked arrays are compressed, i.e. only non masked entries are used</span>
<span class="sd">    remove NaN input in x_old and y_old</span>
<span class="sd">    only unique x values are used, corresponding y values are &#39;random&#39;</span>
<span class="sd">    if all else fails, revert to linear interpolation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_old : array of size (n,)</span>
<span class="sd">        x values of the data</span>
<span class="sd">    y_old : array of size (n,)</span>
<span class="sd">        y values of the data</span>
<span class="sd">    x_new : array of size (m, ) or None, optional</span>
<span class="sd">        x values of the interpolated values</span>
<span class="sd">        if None will return the interpolator object</span>
<span class="sd">        (default: None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_new: array of size (m, ) or interpolator</span>
<span class="sd">        if x_new was given, return the interpolated values</span>
<span class="sd">        otherwise return the interpolator object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Handle masked arrays</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">x_old</span><span class="p">):</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">x_old</span><span class="p">)</span>
        <span class="n">y_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">y_old</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_old</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_old</span><span class="p">)</span>
    <span class="n">x_old</span> <span class="o">=</span> <span class="n">x_old</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">y_old</span> <span class="o">=</span> <span class="n">y_old</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># avoid duplicate entries in x</span>
    <span class="c1"># also sorts data, which allows us to use assume_sorted below</span>
    <span class="n">x_old</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_old</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y_old</span> <span class="o">=</span> <span class="n">y_old</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">x_old</span><span class="p">,</span>
            <span class="n">y_old</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Could not instantiate cubic spline interpolation, using linear instead&quot;</span>
        <span class="p">)</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">x_old</span><span class="p">,</span>
            <span class="n">y_old</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">x_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">interpolator</span></div>



<div class="viewcode-block" id="bottom">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.bottom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bottom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    bottom tries to fit a smooth curve to the lower envelope</span>
<span class="sd">    of 1D data array f. Filter size &quot;filter&quot;</span>
<span class="sd">    together with the total number of iterations determine</span>
<span class="sd">    the smoothness and the quality of the fit. The total</span>
<span class="sd">    number of iterations can be controlled by limiting the</span>
<span class="sd">    maximum number of iterations (iter) and/or by setting</span>
<span class="sd">    the convergence criterion for the fit (eps)</span>
<span class="sd">    04-Nov-2000 N.Piskunov wrote.</span>
<span class="sd">    09-Nov-2011 NP added weights and 2nd derivative constraint as LAM2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : Callable</span>
<span class="sd">        Function to fit</span>
<span class="sd">    filter : int</span>
<span class="sd">        Smoothing parameter of the optimal filter (or polynomial degree of poly is True)</span>
<span class="sd">    iter : int</span>
<span class="sd">        maximum number of iterations [def: 40]</span>
<span class="sd">    eps : float</span>
<span class="sd">        convergence level [def: 0.001]</span>
<span class="sd">    mn : float</span>
<span class="sd">        minimum function values to be considered [def: min(f)]</span>
<span class="sd">    mx : float</span>
<span class="sd">        maximum function values to be considered [def: max(f)]</span>
<span class="sd">    lam2 : float</span>
<span class="sd">        constraint on 2nd derivative</span>
<span class="sd">    weight : array(float)</span>
<span class="sd">        vector of weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">lambda2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lambda2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="n">mn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="n">mx</span><span class="p">))</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fff</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span>
        <span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fff</span> <span class="o">=</span> <span class="p">(</span><span class="n">fff</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">fff</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is a bug in rsi poly routine</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">)</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">opt_filter</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">opt_filter</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">order</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                    <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t</span>
        <span class="p">)</span>  <span class="c1"># the order matters, t dominates</span>
        <span class="n">dev2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="n">ff_old</span><span class="p">))</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>
        <span class="k">if</span> <span class="n">dev2</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is a bug in rsi poly routine</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="n">fff</span> <span class="o">*</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmin</span></div>



<div class="viewcode-block" id="middle">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.middle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">middle</span><span class="p">(</span>
    <span class="n">f</span><span class="p">,</span>
    <span class="n">param</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">lambda2</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    middle tries to fit a smooth curve that is located</span>
<span class="sd">    along the &quot;middle&quot; of 1D data array f. Filter size &quot;filter&quot;</span>
<span class="sd">    together with the total number of iterations determine</span>
<span class="sd">    the smoothness and the quality of the fit. The total</span>
<span class="sd">    number of iterations can be controlled by limiting the</span>
<span class="sd">    maximum number of iterations (iter) and/or by setting</span>
<span class="sd">    the convergence criterion for the fit (eps)</span>
<span class="sd">    04-Nov-2000 N.Piskunov wrote.</span>
<span class="sd">    09-Nov-2011 NP added weights and 2nd derivative constraint as LAM2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : Callable</span>
<span class="sd">        Function to fit</span>
<span class="sd">    filter : int</span>
<span class="sd">        Smoothing parameter of the optimal filter (or polynomial degree of poly is True)</span>
<span class="sd">    iter : int</span>
<span class="sd">        maximum number of iterations [def: 40]</span>
<span class="sd">    eps : float</span>
<span class="sd">        convergence level [def: 0.001]</span>
<span class="sd">    mn : float</span>
<span class="sd">        minimum function values to be considered [def: min(f)]</span>
<span class="sd">    mx : float</span>
<span class="sd">        maximum function values to be considered [def: max(f)]</span>
<span class="sd">    lam2 : float</span>
<span class="sd">        constraint on 2nd derivative</span>
<span class="sd">    weight : array(float)</span>
<span class="sd">        vector of weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span> <span class="k">if</span> <span class="n">mn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span> <span class="k">if</span> <span class="n">mx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="n">mn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="n">mx</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="nb">round</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span>

        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="n">xx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">opt_filter</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">opt_filter</span><span class="p">(</span>
                <span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span>
            <span class="p">)</span>

        <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dev</span><span class="p">)</span>
        <span class="n">dev2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="n">ff_old</span><span class="p">))</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>

        <span class="c1"># print(dev2)</span>
        <span class="k">if</span> <span class="n">dev2</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">param</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmin</span></div>



<div class="viewcode-block" id="top">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.top">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">top</span><span class="p">(</span>
    <span class="n">f</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">lambda2</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    top tries to fit a smooth curve to the upper envelope</span>
<span class="sd">    of 1D data array f. Filter size &quot;filter&quot;</span>
<span class="sd">    together with the total number of iterations determine</span>
<span class="sd">    the smoothness and the quality of the fit. The total</span>
<span class="sd">    number of iterations can be controlled by limiting the</span>
<span class="sd">    maximum number of iterations (iter) and/or by setting</span>
<span class="sd">    the convergence criterion for the fit (eps)</span>
<span class="sd">    04-Nov-2000 N.Piskunov wrote.</span>
<span class="sd">    09-Nov-2011 NP added weights and 2nd derivative constraint as LAM2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : Callable</span>
<span class="sd">        Function to fit</span>
<span class="sd">    filter : int</span>
<span class="sd">        Smoothing parameter of the optimal filter (or polynomial degree of poly is True)</span>
<span class="sd">    iter : int</span>
<span class="sd">        maximum number of iterations [def: 40]</span>
<span class="sd">    eps : float</span>
<span class="sd">        convergence level [def: 0.001]</span>
<span class="sd">    mn : float</span>
<span class="sd">        minimum function values to be considered [def: min(f)]</span>
<span class="sd">    mx : float</span>
<span class="sd">        maximum function values to be considered [def: max(f)]</span>
<span class="sd">    lam2 : float</span>
<span class="sd">        constraint on 2nd derivative</span>
<span class="sd">    weight : array(float)</span>
<span class="sd">        vector of weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span> <span class="k">if</span> <span class="n">mn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span> <span class="k">if</span> <span class="n">mx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="n">mn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="n">mx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">round</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough points&quot;</span><span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fff</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span>
        <span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fff</span> <span class="o">=</span> <span class="p">(</span><span class="n">fff</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">fff</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">)</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">opt_filter</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">opt_filter</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="n">t</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">order</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                <span class="n">lambda2</span><span class="o">=</span><span class="n">lambda2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">eps</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dev</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">dev2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="n">ff_old</span><span class="p">))</span>
        <span class="n">ff_old</span> <span class="o">=</span> <span class="n">ff</span>
        <span class="k">if</span> <span class="n">dev2</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">xx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="n">fff</span> <span class="o">*</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">-</span> <span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmin</span></div>



<div class="viewcode-block" id="opt_filter">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.opt_filter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">opt_filter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">par1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimal filtering of 1D and 2D arrays.</span>
<span class="sd">    Uses tridiag in 1D case and sprsin and linbcg in 2D case.</span>
<span class="sd">    Written by N.Piskunov 8-May-2000</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : array</span>
<span class="sd">        1d or 2d array</span>
<span class="sd">    xwidth : int</span>
<span class="sd">        filter width (for 2d array width in x direction (1st index)</span>
<span class="sd">    ywidth : int</span>
<span class="sd">        (for 2d array only) filter width in y direction (2nd index) if ywidth is missing for 2d array, it set equal to xwidth</span>
<span class="sd">    weight : array(float)</span>
<span class="sd">        an array of the same size(s) as f containing values between 0 and 1</span>
<span class="sd">    lambda1: float</span>
<span class="sd">        regularization parameter</span>
<span class="sd">    maxiter : int</span>
<span class="sd">        maximum number of iteration for filtering of 2d array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input y must have 1 or 2 dimensions&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">par</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">par</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># 1D case</span>
    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">weight</span><span class="p">):</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lambda2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Apply regularization lambda</span>
            <span class="n">aij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="c1"># 2nd lower subdiagonal</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">lambda2</span>
            <span class="c1"># Lower subdiagonal</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="c1"># Main diagonal</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">par</span> <span class="o">+</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">par</span> <span class="o">+</span> <span class="n">lambda2</span>
            <span class="c1"># Upper subdiagonal</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">par</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda2</span>
            <span class="c1"># 2nd lower subdiagonal</span>
            <span class="n">aij</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda2</span>
            <span class="c1"># RHS</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">y</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">solve_banded</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">aij</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
            <span class="n">aba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">solve_banded</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">aba</span><span class="p">,</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 2D case</span>
        <span class="k">if</span> <span class="n">par1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">par1</span> <span class="o">=</span> <span class="n">par</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">par1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xwidth and ywidth can&#39;t both be 0&quot;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">lam_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="n">lam_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">par1</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="n">ndiag</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">aij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ndiag</span><span class="p">))</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lam_x</span> <span class="o">+</span> <span class="n">lam_y</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lam_x</span> <span class="o">+</span> <span class="n">lam_y</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nx</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">lam_x</span> <span class="o">+</span> <span class="n">lam_y</span><span class="p">)</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nx</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lam_x</span> <span class="o">+</span> <span class="n">lam_y</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lam_x</span> <span class="o">+</span> <span class="n">lam_y</span>

        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_x</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_x</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arrange</span><span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aij</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lam_x</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">aij</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">lam_x</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arrange</span><span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">nx</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">aij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_y</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">ndiag</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_y</span>

        <span class="n">rhs</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">weight</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">solve_banded</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">aij</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">model</span></div>



<div class="viewcode-block" id="helcorr">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.util.helcorr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">helcorr</span><span class="p">(</span><span class="n">obs_long</span><span class="p">,</span> <span class="n">obs_lat</span><span class="p">,</span> <span class="n">obs_alt</span><span class="p">,</span> <span class="n">ra2000</span><span class="p">,</span> <span class="n">dec2000</span><span class="p">,</span> <span class="n">jd</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="s2">&quot;barycentric&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculates heliocentric Julian date, barycentric and heliocentric radial</span>
<span class="sd">    velocity corrections, using astropy functions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    obs_long : float</span>
<span class="sd">        Longitude of observatory (degrees, western direction is positive)</span>
<span class="sd">    obs_lat : float</span>
<span class="sd">        Latitude of observatory (degrees)</span>
<span class="sd">    obs_alt : float</span>
<span class="sd">        Altitude of observatory (meters)</span>
<span class="sd">    ra2000 : float</span>
<span class="sd">        Right ascension of object for epoch 2000.0 (hours)</span>
<span class="sd">    dec2000 : float</span>
<span class="sd">        Declination of object for epoch 2000.0 (degrees)</span>
<span class="sd">    jd : float</span>
<span class="sd">        Julian date for the middle of exposure in MJD</span>
<span class="sd">    system : {&quot;barycentric&quot;, &quot;heliocentric&quot;}, optional</span>
<span class="sd">        reference system of the result, barycentric: around earth-sun gravity center,</span>
<span class="sd">        heliocentric: around sun, usually barycentric is preferred (default: &quot;barycentric)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    correction : float</span>
<span class="sd">        radial velocity correction due to barycentre offset</span>
<span class="sd">    hjd : float</span>
<span class="sd">        Heliocentric Julian date for middle of exposure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># jd = 2400000.5 + jd</span>
    <span class="n">jd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">Longitude</span><span class="p">(</span><span class="n">ra2000</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">Latitude</span><span class="p">(</span><span class="n">dec2000</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

    <span class="n">observatory</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">obs_long</span><span class="p">,</span> <span class="n">obs_lat</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">obs_alt</span><span class="p">)</span>
    <span class="n">sky_location</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">jd</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">observatory</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">observatory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;barycentric&quot;</span><span class="p">:</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="n">sky_location</span><span class="o">.</span><span class="n">radial_velocity_correction</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ltt</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="n">sky_location</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;heliocentric&quot;</span><span class="p">:</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sky_location</span><span class="o">.</span><span class="n">radial_velocity_correction</span><span class="p">(</span><span class="s2">&quot;heliocentric&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>
        <span class="n">ltt</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="n">sky_location</span><span class="p">,</span> <span class="s2">&quot;heliocentric&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s2">&quot;Could not parse system, values are: (&#39;barycentric&#39;, &#39;heliocentric&#39;)&quot;</span>
        <span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">utc</span> <span class="o">+</span> <span class="n">ltt</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">2400000</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">correction</span><span class="p">,</span> <span class="n">times</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>