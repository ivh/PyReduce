<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.instruments.common &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.instruments.common</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Abstract parent module for all other instruments</span>
<span class="sd">Contains some general functionality, which may be overridden by the children of course</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">parser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..clipnflip</span><span class="w"> </span><span class="kn">import</span> <span class="n">clipnflip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">Filter</span><span class="p">,</span> <span class="n">InstrumentFilter</span><span class="p">,</span> <span class="n">ModeFilter</span><span class="p">,</span> <span class="n">NightFilter</span><span class="p">,</span> <span class="n">ObjectFilter</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="find_first_index">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.find_first_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_first_index</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;find the first element equal to value in the array arr&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Value </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="observation_date_to_night">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.observation_date_to_night">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">observation_date_to_night</span><span class="p">(</span><span class="n">observation_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an observation timestamp into the date of the observation night</span>
<span class="sd">    Nights start at 12am and end at 12 am the next day</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    observation_date : datetime</span>
<span class="sd">        timestamp of the observation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    night : datetime.date</span>
<span class="sd">        night of the observation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">observation_date</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">observation_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">observation_date</span><span class="p">)</span>
    <span class="n">oneday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">observation_date</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">observation_date</span> <span class="o">-=</span> <span class="n">oneday</span>
    <span class="k">return</span> <span class="n">observation_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span></div>



<div class="viewcode-block" id="getter">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.getter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">getter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get data from a header/dict, based on the given mode, and applies replacements&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">find_first_index</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">],</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No instrument modes found in instrument info&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Pick values for the given mode</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span>

<div class="viewcode-block" id="getter.get">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.getter.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            key of the data in the header</span>
<span class="sd">        alt : obj, optional</span>
<span class="sd">            alternative value, if key does not exist (default: None)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value : obj</span>
<span class="sd">            value found in header (or alternatively alt)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1"># if isinstance(value, list):</span>
        <span class="c1">#     value = value[self.index]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>
</div>



<div class="viewcode-block" id="Instrument">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Instrument</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract parent class for all instruments</span>
<span class="sd">    Handles the instrument specific information</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#:str: Name of the instrument (lowercase)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1">#:dict: Information about the instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="n">InstrumentFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">],</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">NightFilter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">timeformat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_format&quot;</span><span class="p">,</span> <span class="s2">&quot;fits&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">ObjectFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_bias&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_flat&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_orders&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_curvature&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_scatter&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;wave&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_wave&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;comb&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_comb&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_spec&quot;</span><span class="p">]),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">night</span> <span class="o">=</span> <span class="s2">&quot;night&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">science</span> <span class="o">=</span> <span class="s2">&quot;science&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">,</span> <span class="s2">&quot;night&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_closest</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;bias&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wavecal_master&quot;</span><span class="p">,</span>
            <span class="s2">&quot;freq_comb_master&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orders&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;curvature&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Instrument.get">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">get</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">)</span></div>


<div class="viewcode-block" id="Instrument.get_extension">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_extension">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">imode</span> <span class="o">=</span> <span class="n">find_first_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">extension</span></div>


<div class="viewcode-block" id="Instrument.load_info">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.load_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load static instrument information</span>
<span class="sd">        Either as fits header keywords or static values</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        info : dict(str:object)</span>
<span class="sd">            dictionary of REDUCE names for properties to Header keywords/static values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Tips &amp; Tricks:</span>
        <span class="c1"># if several modes are supported, use a list for modes</span>
        <span class="c1"># if a value changes depending on the mode, use a list with the same order as &quot;modes&quot;</span>
        <span class="c1"># you can also use values from this dictionary as placeholders using {name}, just like str.format</span>

        <span class="n">this</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span></div>


<div class="viewcode-block" id="Instrument.load_fits">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.load_fits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_fits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load fits file, REDUCE style</span>

<span class="sd">        primary and extension header are combined</span>
<span class="sd">        modeinfo is applied to header</span>
<span class="sd">        data is clipnflipped</span>
<span class="sd">        mask is applied</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            filename</span>
<span class="sd">        instrument : str</span>
<span class="sd">            name of the instrument</span>
<span class="sd">        mode : str</span>
<span class="sd">            instrument mode</span>
<span class="sd">        extension : int</span>
<span class="sd">            data extension of the FITS file to load</span>
<span class="sd">        mask : array, optional</span>
<span class="sd">            mask to add to the data</span>
<span class="sd">        header_only : bool, optional</span>
<span class="sd">            only load the header, not the data</span>
<span class="sd">        dtype : str, optional</span>
<span class="sd">            numpy datatype to convert the read data to</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        data : masked_array</span>
<span class="sd">            FITS data, clipped and flipped, and with mask</span>
<span class="sd">        header : fits.header</span>
<span class="sd">            FITS header (Primary and Extension + Modeinfo)</span>

<span class="sd">        ONLY the header is returned if header_only is True</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">h_prime</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extension</span><span class="p">(</span><span class="n">h_prime</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">h_prime</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_header_info</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s2">&quot;Original input filename&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header_only</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">header</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">clipnflip</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span></div>


<div class="viewcode-block" id="Instrument.add_header_info">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.add_header_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_header_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;read data from header and add it as REDUCE keyword back to the header</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : fits.header, dict</span>
<span class="sd">            header to read/write info from/to</span>
<span class="sd">        mode : str</span>
<span class="sd">            instrument mode</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        header : fits.header, dict</span>
<span class="sd">            header with added information</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span>
        <span class="n">get</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;instrument&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_telescope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;telescope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_exptime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;exposure_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">jd</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_format&quot;</span><span class="p">,</span> <span class="s2">&quot;fits&quot;</span><span class="p">))</span>
            <span class="n">jd</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_orient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;orientation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># As per IDL rotate if orient is 4 or larger and transpose is undefined</span>
        <span class="c1"># the image is transposed</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_transpose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;transpose&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_orient&quot;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">naxis_x</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;naxis_x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">naxis_y</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;naxis_y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">prescan_x</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;prescan_x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">overscan_x</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;overscan_x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">prescan_y</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;prescan_y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">overscan_y</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;overscan_y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_xlo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prescan_x</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_xhi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">naxis_x</span> <span class="o">-</span> <span class="n">overscan_x</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_ylo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prescan_y</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_yhi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">naxis_y</span> <span class="o">-</span> <span class="n">overscan_y</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_gain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;gain&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_readn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;readnoise&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_sky&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;sky&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_drk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;dark&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_backg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_gain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_drk&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_sky&quot;</span><span class="p">])</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_imtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_type&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_ctg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_jd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jd</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_obslon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_obslat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;e_obsalt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavecal_element&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HIERARCH e_wavecal_element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;wavecal_element&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavecal_element&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="Instrument.find_files">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.find_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find fits files in the given folder</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_dir : string</span>
<span class="sd">            directory to look for fits and fits.gz files in, may include bash style wildcards</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files: array(string)</span>
<span class="sd">            absolute path filenames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s2">&quot;/*.fits&quot;</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s2">&quot;/*.fits.gz&quot;</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="Instrument.get_expected_values">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_expected_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_expected_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">expectations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_bias&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_flat&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_orders&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_scatter&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_curvature&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;wavecal_master&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;wave&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_wave&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;freq_comb_master&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;comb&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_comb&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;science&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_instrument&quot;</span><span class="p">],</span>
                <span class="s2">&quot;night&quot;</span><span class="p">:</span> <span class="n">night</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_spec&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">expectations</span></div>


<div class="viewcode-block" id="Instrument.populate_filters">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.populate_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">populate_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract values from the fits headers and store them in self.filters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            list of fits files</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filters: list(Filter)</span>
<span class="sd">            list of populated filters (identical to self.filters)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Empty filters</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fil</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fil</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">fil</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span></div>


<div class="viewcode-block" id="Instrument.apply_filters">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.apply_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">allow_calibration_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the relevant files for a given set of expected values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(files)</span>
<span class="sd">            list if fits files</span>
<span class="sd">        expected : dict</span>
<span class="sd">            dictionary with expected header values for each reduction step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files: list((dict, dict))</span>
<span class="sd">            list of files. The first element of each tuple is the used setting,</span>
<span class="sd">            and the second are the files for each step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Fill the filters with header information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_filters</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="c1"># Use the header information determined in populate filters</span>
        <span class="c1"># to find potential science and calibration files in the list of files</span>
        <span class="c1"># result = {step : [ {setting : value}, [files] ] }</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># Get all combinations of possible filter values</span>
            <span class="c1"># e.g. if several nights are allowed</span>
            <span class="k">for</span> <span class="n">thingy</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">thingy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thingy</span><span class="p">)):</span>
                    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">thingy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">thingy</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="c1"># Filter for only nights that have a science observation</span>
        <span class="c1"># files = [{setting: value}, {step: files}]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">allow_calibration_only</span><span class="p">:</span>
            <span class="c1"># Use all unique nights</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">shared</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">settings</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Or use only science nights</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">shared</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">science</span><span class="p">]]</span>
                <span class="n">settings</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
            <span class="n">night</span> <span class="o">=</span> <span class="n">setting</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">night</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># For each step look for files with matching settings</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">step_data</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">step_key</span><span class="p">,</span> <span class="n">step_files</span> <span class="ow">in</span> <span class="n">step_data</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">setting</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">==</span> <span class="n">step_key</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">shared</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>
                        <span class="k">if</span> <span class="n">shared</span> <span class="ow">in</span> <span class="n">step_key</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
                        <span class="n">f</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_files</span>
                        <span class="k">break</span>
                <span class="c1"># If no matching files are found ...</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">step</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_closest</span><span class="p">:</span>
                        <span class="c1"># Show a warning</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Could not find any files for step &#39;</span><span class="si">%s</span><span class="s2">&#39; with settings </span><span class="si">%s</span><span class="s2">, sharing parameters </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">step</span><span class="p">,</span>
                            <span class="n">setting</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Or find the closest night instead</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">step_key</span><span class="p">,</span> <span class="n">step_files</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step_data</span><span class="p">):</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">setting</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">==</span> <span class="n">step_key</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">shared</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>
                                <span class="k">if</span> <span class="n">shared</span> <span class="ow">in</span> <span class="n">step_key</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">shared</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">night</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">diff_old</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">night</span><span class="p">]</span> <span class="o">-</span> <span class="n">night</span><span class="p">)</span>
                                    <span class="n">diff_new</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">night</span><span class="p">]</span> <span class="o">-</span> <span class="n">night</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">diff_new</span> <span class="o">&lt;</span> <span class="n">diff_old</span><span class="p">:</span>
                                        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># We still dont find any files</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Could not find any files for step &#39;</span><span class="si">%s</span><span class="s2">&#39; in any night with settings </span><span class="si">%s</span><span class="s2">, sharing parameters </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">step</span><span class="p">,</span>
                                <span class="n">setting</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># We found files in a close night</span>
                            <span class="n">closest_key</span><span class="p">,</span> <span class="n">closest_files</span> <span class="o">=</span> <span class="n">step_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Using &#39;</span><span class="si">%s</span><span class="s2">&#39; files from night </span><span class="si">%s</span><span class="s2"> for observations of night </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">step</span><span class="p">,</span>
                                <span class="n">night</span><span class="p">,</span>
                                <span class="n">closest_key</span><span class="p">[</span><span class="s2">&quot;night&quot;</span><span class="p">],</span>
                            <span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">closest_files</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">setting</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No </span><span class="si">%s</span><span class="s2"> files found matching the expected values </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">science</span><span class="p">,</span>
                <span class="n">expected</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">science</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="Instrument.sort_files">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.sort_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">allow_calibration_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort a set of fits files into different categories</span>
<span class="sd">        types are: bias, flat, wavecal, orderdef, spec</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_dir : str</span>
<span class="sd">            input directory containing the files to sort</span>
<span class="sd">        target : str</span>
<span class="sd">            name of the target as in the fits headers</span>
<span class="sd">        night : str</span>
<span class="sd">            observation night, possibly with wildcards</span>
<span class="sd">        mode : str</span>
<span class="sd">            instrument mode</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files_per_night : list[dict{str:dict{str:list[str]}}]</span>
<span class="sd">            a list of file sets, one entry per night, where each night consists of a dictionary with one entry per setting,</span>
<span class="sd">            each fileset has five lists of filenames: &quot;bias&quot;, &quot;flat&quot;, &quot;order&quot;, &quot;wave&quot;, &quot;spec&quot;, organised in another dict</span>
<span class="sd">        nights_out : list[datetime]</span>
<span class="sd">            a list of observation times, same order as files_per_night</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_dir</span> <span class="o">=</span> <span class="n">input_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="o">=</span><span class="n">night</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">input_dir</span><span class="p">)</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expected_values</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">(</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">allow_calibration_only</span><span class="o">=</span><span class="n">allow_calibration_only</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="Instrument.get_wavecal_filename">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_wavecal_filename">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavecal_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the filename of the pre-existing wavelength solution for the current setting</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : fits.header, dict</span>
<span class="sd">            header of the wavelength calibration file</span>
<span class="sd">        mode : str</span>
<span class="sd">            instrument mode</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filename : str</span>
<span class="sd">            name of the wavelength solution file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">specifier</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavecal_specifier&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="s2">&quot;wavecal&quot;</span>

        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instrument</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">specifier</span><span class="si">}</span><span class="s2">.npz&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;wavecal&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname</span></div>


<div class="viewcode-block" id="Instrument.get_supported_modes">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_supported_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_supported_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Instrument.get_mask_filename">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_mask_filename">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mask_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname</span></div>


<div class="viewcode-block" id="Instrument.get_wavelength_range">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.Instrument.get_wavelength_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelength_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavelength_range&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="InstrumentWithModes">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.InstrumentWithModes">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">InstrumentWithModes</span><span class="p">(</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># replacement = {k: v for k, v in zip(self.info[&quot;id_modes&quot;], self.info[&quot;modes&quot;])}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModeFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;kw_modes&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="InstrumentWithModes.get_expected_values">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.InstrumentWithModes.get_expected_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_expected_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">expectations</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_expected_values</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="n">id_mode</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;id_modes&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="n">mode</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expectations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">expectations</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_mode</span>

        <span class="k">return</span> <span class="n">expectations</span></div>
</div>



<div class="viewcode-block" id="COMMON">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.COMMON">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">COMMON</span><span class="p">(</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="create_custom_instrument">
<a class="viewcode-back" href="../../../pyreduce.instruments.html#pyreduce.instruments.common.create_custom_instrument">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_custom_instrument</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wavecal_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hasModes</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">Instrument</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">hasModes</span> <span class="k">else</span> <span class="n">InstrumentWithModes</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">CUSTOM</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">load_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">COMMON</span><span class="p">()</span><span class="o">.</span><span class="n">info</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">info</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">extension</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_mask_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mask_file</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_wavecal_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">wavecal_file</span>

    <span class="k">return</span> <span class="n">CUSTOM</span><span class="p">()</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>