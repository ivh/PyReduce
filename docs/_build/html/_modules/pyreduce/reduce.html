<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyreduce.reduce &#8212; PyReduce unknown documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=3f1b9271"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyreduce.reduce</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">REDUCE script for spectrograph data</span>

<span class="sd">Authors</span>
<span class="sd">-------</span>
<span class="sd">Ansgar Wehrhahn  (ansgar.wehrhahn@physics.uu.se)</span>
<span class="sd">Thomas Marquart  (thomas.marquart@physics.uu.se)</span>
<span class="sd">Alexis Lavail    (alexis.lavail@physics.uu.se)</span>
<span class="sd">Nikolai Piskunov (nikolai.piskunov@physics.uu.se)</span>

<span class="sd">Version</span>
<span class="sd">-------</span>
<span class="sd">1.0 - Initial PyReduce</span>

<span class="sd">License</span>
<span class="sd">--------</span>
<span class="sd">...</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">join</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io.fits.verify</span><span class="w"> </span><span class="kn">import</span> <span class="n">VerifyWarning</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">VerifyWarning</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># PyReduce subpackages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">echelle</span><span class="p">,</span> <span class="n">instruments</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.combine_frames</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">combine_bias</span><span class="p">,</span>
    <span class="n">combine_calibrate</span><span class="p">,</span>
    <span class="n">combine_polynomial</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.configuration</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.continuum_normalization</span><span class="w"> </span><span class="kn">import</span> <span class="n">continuum_normalize</span><span class="p">,</span> <span class="n">splice_orders</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.estimate_background_scatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">estimate_background_scatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.extract</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.instruments.instrument_info</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_instrument</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.make_shear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Curvature</span> <span class="k">as</span> <span class="n">CurvatureModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.rectify</span><span class="w"> </span><span class="kn">import</span> <span class="n">merge_images</span><span class="p">,</span> <span class="n">rectify_image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.trace_orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">mark_orders</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wavelength_calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineList</span><span class="p">,</span> <span class="n">WavelengthCalibrationComb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wavelength_calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">WavelengthCalibration</span> <span class="k">as</span> <span class="n">WavelengthCalibrationModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wavelength_calibration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">WavelengthCalibrationInitialize</span> <span class="k">as</span> <span class="n">WavelengthCalibrationInitializeModule</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># TODO Naming of functions and modules</span>
<span class="c1"># TODO License</span>

<span class="c1"># TODO automatic determination of the extraction width</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">instrument</span><span class="p">,</span>
    <span class="n">target</span><span class="p">,</span>
    <span class="n">night</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">input_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">configuration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">order_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_calibration_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for REDUCE scripts,</span>
<span class="sd">    default values can be changed as required if reduce is used as a script</span>
<span class="sd">    Finds input directories, and loops over observation nights and instrument modes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instrument : str, list[str]</span>
<span class="sd">        instrument used for the observation (e.g. UVES, HARPS)</span>
<span class="sd">    target : str, list[str]</span>
<span class="sd">        the observed star, as named in the folder structure/fits headers</span>
<span class="sd">    night : str, list[str]</span>
<span class="sd">        the observation nights to reduce, as named in the folder structure. Accepts bash wildcards (i.e. \*, ?), but then relies on the folder structure for restricting the nights</span>
<span class="sd">    modes : str, list[str], dict[{instrument}:list], None, optional</span>
<span class="sd">        the instrument modes to use, if None will use all known modes for the current instrument. See instruments for possible options</span>
<span class="sd">    steps : tuple(str), &quot;all&quot;, optional</span>
<span class="sd">        which steps of the reduction process to perform</span>
<span class="sd">        the possible steps are: &quot;bias&quot;, &quot;flat&quot;, &quot;orders&quot;, &quot;norm_flat&quot;, &quot;wavecal&quot;, &quot;science&quot;</span>
<span class="sd">        alternatively set steps to &quot;all&quot;, which is equivalent to setting all steps</span>
<span class="sd">        Note that the later steps require the previous intermediary products to exist and raise an exception otherwise</span>
<span class="sd">    base_dir : str, optional</span>
<span class="sd">        base data directory that Reduce should work in, is prefixxed on input_dir and output_dir (default: use settings_pyreduce.json)</span>
<span class="sd">    input_dir : str, optional</span>
<span class="sd">        input directory containing raw files. Can contain placeholders {instrument}, {target}, {night}, {mode} as well as wildcards. If relative will use base_dir as root (default: use settings_pyreduce.json)</span>
<span class="sd">    output_dir : str, optional</span>
<span class="sd">        output directory for intermediary and final results. Can contain placeholders {instrument}, {target}, {night}, {mode}, but no wildcards. If relative will use base_dir as root (default: use settings_pyreduce.json)</span>
<span class="sd">    configuration : dict[str:obj], str, list[str], dict[{instrument}:dict,str], optional</span>
<span class="sd">        configuration file for the current run, contains parameters for different parts of reduce. Can be a path to a json file, or a dict with configurations for the different instruments. When a list, the order must be the same as instruments (default: settings_{instrument.upper()}.json)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">night</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">night</span><span class="p">):</span>
        <span class="n">night</span> <span class="o">=</span> <span class="p">[</span><span class="n">night</span><span class="p">]</span>

    <span class="n">isNone</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;modes&quot;</span><span class="p">:</span> <span class="n">modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;base_dir&quot;</span><span class="p">:</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;input_dir&quot;</span><span class="p">:</span> <span class="n">input_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over everything</span>

    <span class="c1"># settings: default settings of PyReduce</span>
    <span class="c1"># config: paramters for the current reduction</span>
    <span class="c1"># info: constant, instrument specific parameters</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">instruments</span><span class="o">.</span><span class="n">instrument_info</span><span class="o">.</span><span class="n">load_instrument</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">info</span>

    <span class="c1"># load default settings from settings_pyreduce.json</span>
    <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce&quot;</span><span class="p">][</span><span class="s2">&quot;base_dir&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">input_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_dir</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce&quot;</span><span class="p">][</span><span class="s2">&quot;input_dir&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;reduce&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>

    <span class="n">input_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">modes</span><span class="p">):</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">modes</span><span class="p">):</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
            <span class="n">base_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">modes</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">t</span><span class="p">),</span>
            <span class="s2">&quot;logs/</span><span class="si">%s</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">start_logging</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="c1"># find input files and sort them by type</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">sort_files</span><span class="p">(</span>
            <span class="n">input_dir</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">n</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
            <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">],</span>
            <span class="n">allow_calibration_only</span><span class="o">=</span><span class="n">allow_calibration_only</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No files found for instrument: </span><span class="si">%s</span><span class="s2">, target: </span><span class="si">%s</span><span class="s2">, night: </span><span class="si">%s</span><span class="s2">, mode: </span><span class="si">%s</span><span class="s2"> in folder: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">instrument</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="n">m</span><span class="p">,</span>
                <span class="n">input_dir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Settings:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Files:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="n">reducer</span> <span class="o">=</span> <span class="n">Reducer</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
                <span class="n">instrument</span><span class="p">,</span>
                <span class="n">m</span><span class="p">,</span>
                <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;night&quot;</span><span class="p">),</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">order_range</span><span class="o">=</span><span class="n">order_range</span><span class="p">,</span>
                <span class="n">skip_existing</span><span class="o">=</span><span class="n">skip_existing</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># try:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">run_steps</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># except Exception as e:</span>
            <span class="c1">#     logger.error(&quot;Reduction failed with error message: %s&quot;, str(e))</span>
            <span class="c1">#     logger.info(&quot;------------&quot;)</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="Step">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Step">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent class for all steps&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">order_range</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#:str: Name of the instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="c1">#:str: Name of the instrument mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="c1">#:str: Name of the observation target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="c1">#:str: Date of the observation (as a string)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">night</span> <span class="o">=</span> <span class="n">night</span>
        <span class="c1">#:tuple(int, int): First and Last(+1) order to process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_range</span> <span class="o">=</span> <span class="n">order_range</span>
        <span class="c1">#:bool: Whether to plot the results or the progress of this step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1">#:str: Title used in the plots, if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot_title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

<div class="viewcode-block" id="Step.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Step.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the current step</span>

<span class="sd">        This should fail if files are missing or anything else goes wrong.</span>
<span class="sd">        If the user does not want to run this step, they should not specify it in steps.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            data files required for this step</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            needs to be implemented for each step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Step.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Step.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the results of this step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args : obj</span>
<span class="sd">            things to save</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            Needs to be implemented for each step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Step.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Step.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load results from a previous execution</span>

<span class="sd">        If this raises a FileNotFoundError, run() will be used instead</span>
<span class="sd">        For calibration steps it is preferred however to print a warning</span>
<span class="sd">        and return None. Other modules can then use a default value instead.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            Needs to be implemented for each step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dependsOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;list(str): Steps that are required before running this step&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadDependsOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;list(str): Steps that are required before loading data from this step&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: output directory, may contain tags {instrument}, {night}, {target}, {mode}&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="n">night</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">night</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: temporary file prefix&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span></div>



<div class="viewcode-block" id="CalibrationStep">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.CalibrationStep">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CalibrationStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>

        <span class="c1">#:{&#39;number_of_files&#39;, &#39;exposure_time&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;none&#39;}: how to adjust for diferences between the bias and flat field exposure times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_scaling</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias_scaling&quot;</span><span class="p">]</span>
        <span class="c1">#:{&#39;divide&#39;, &#39;none&#39;}: how to apply the normalized flat field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_scaling</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;norm_scaling&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CalibrationStep.calibrate">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.CalibrationStep.calibrate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm_flat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span> <span class="o">=</span> <span class="n">bias</span> <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span> <span class="o">=</span> <span class="n">norm_flat</span> <span class="k">if</span> <span class="n">norm_flat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">combine_calibrate</span><span class="p">(</span>
            <span class="n">files</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">bhead</span><span class="o">=</span><span class="n">bhead</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
            <span class="n">bias_scaling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_scaling</span><span class="p">,</span>
            <span class="n">norm_scaling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_scaling</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span></div>
</div>



<div class="viewcode-block" id="ExtractionStep">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ExtractionStep">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExtractionStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s2">&quot;orders&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1">#:{&#39;arc&#39;, &#39;optimal&#39;}: Extraction method to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span> <span class="o">==</span> <span class="s2">&quot;arc&quot;</span><span class="p">:</span>
            <span class="c1">#:dict: arguments for the extraction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;extraction_width&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sigma_cutoff&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_cutoff&quot;</span><span class="p">],</span>
                <span class="s2">&quot;collapse_function&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;collapse_function&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span> <span class="o">==</span> <span class="s2">&quot;optimal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;extraction_width&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">],</span>
                <span class="s2">&quot;lambda_sf&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;smooth_slitfunction&quot;</span><span class="p">],</span>
                <span class="s2">&quot;lambda_sp&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;smooth_spectrum&quot;</span><span class="p">],</span>
                <span class="s2">&quot;osample&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;oversampling&quot;</span><span class="p">],</span>
                <span class="s2">&quot;swath_width&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;swath_width&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sigma_cutoff&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_cutoff&quot;</span><span class="p">],</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Extraction method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span><span class="si">}</span><span class="s2"> not supported for step &#39;wavecal&#39;&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="ExtractionStep.extract">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ExtractionStep.extract">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">orders</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span> <span class="o">=</span> <span class="n">curvature</span> <span class="k">if</span> <span class="n">curvature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">slitfu</span><span class="p">,</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">gain</span><span class="o">=</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_gain&quot;</span><span class="p">],</span>
            <span class="n">readnoise</span><span class="o">=</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_readn&quot;</span><span class="p">],</span>
            <span class="n">dark</span><span class="o">=</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_drk&quot;</span><span class="p">],</span>
            <span class="n">column_range</span><span class="o">=</span><span class="n">column_range</span><span class="p">,</span>
            <span class="n">extraction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span><span class="p">,</span>
            <span class="n">order_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_range</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="n">scatter</span><span class="o">=</span><span class="n">scatter</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">slitfu</span><span class="p">,</span> <span class="n">cr</span></div>
</div>



<div class="viewcode-block" id="FitsIOStep">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.FitsIOStep">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FitsIOStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_failure</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="FitsIOStep.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.FitsIOStep.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data to a FITS file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array of shape (nrow, ncol)</span>
<span class="sd">            bias data</span>
<span class="sd">        head : FITS header</span>
<span class="sd">            bias header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">head</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;silentfix+ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created data file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="FitsIOStep.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.FitsIOStep.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the master bias from a previous run</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : masked array of shape (nrow, ncol)</span>
<span class="sd">            master bias data, with the bad pixel mask applied</span>
<span class="sd">        head : FITS header</span>
<span class="sd">            header of the master bias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_failure</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No data file found&quot;</span><span class="p">)</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">head</span></div>
</div>



<div class="viewcode-block" id="Mask">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Mask">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Mask</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the bad pixel mask for the given instrument/mode&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="Mask.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Mask.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the mask file from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask for this setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>


<div class="viewcode-block" id="Mask.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Mask.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the mask file from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask for this setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_mask_filename</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span><span class="n">mask_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># REDUCE mask are inverse to numpy masks</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bad pixel mask file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Bad Pixel Mask datafile </span><span class="si">%s</span><span class="s2"> not found. Using all pixels instead.&quot;</span><span class="p">,</span>
                <span class="n">mask_file</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">mask</span></div>
</div>



<div class="viewcode-block" id="Bias">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Bias">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bias</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the master bias&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>

        <span class="c1">#:int: polynomial degree of the fit between exposure time and pixel values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of master bias fits file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.bias.fits&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Bias.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Bias.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the master bias</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            bias files</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            bad pixel map</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bias : masked array of shape (nrow, ncol)</span>
<span class="sd">            master bias data, with the bad pixel mask applied</span>
<span class="sd">        bhead : FITS header</span>
<span class="sd">            header of the master bias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bias Files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If the degree is 0, we just combine all images into a single master bias</span>
            <span class="c1"># this works great if we assume there is no dark at exposure time 0</span>
            <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span> <span class="o">=</span> <span class="n">combine_bias</span><span class="p">(</span>
                <span class="n">files</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise we fit a polynomial to each pixel in the image, with</span>
            <span class="c1"># the pixel value versus the exposure time. The constant coefficients</span>
            <span class="c1"># are then the bias, and the others are used to scale with the</span>
            <span class="c1"># exposure time</span>
            <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span> <span class="o">=</span> <span class="n">combine_polynomial</span><span class="p">(</span>
                <span class="n">files</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bhead</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span></div>


<div class="viewcode-block" id="Bias.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Bias.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the master bias to a FITS file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bias : array of shape (nrow, ncol)</span>
<span class="sd">            bias data</span>
<span class="sd">        bhead : FITS header</span>
<span class="sd">            bias header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hdus</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">bhead</span><span class="p">,</span> <span class="n">scale_back</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdus</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="n">bhead</span><span class="p">,</span> <span class="n">scale_back</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias</span><span class="p">)):</span>
                <span class="n">hdus</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="n">hdus</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hdus</span><span class="p">)</span>

        <span class="n">hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BZERO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;fix&quot;</span><span class="p">,</span>  <span class="c1"># &quot;silentfix+ignore&quot;,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created master bias file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bias.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Bias.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the master bias from a previous run</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bias : masked array of shape (nrow, ncol)</span>
<span class="sd">            master bias data, with the bad pixel mask applied</span>
<span class="sd">        bhead : FITS header</span>
<span class="sd">            header of the master bias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Master bias file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">degree</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bhead</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">])</span>
                    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span>
                        <span class="n">bias</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[</span><span class="n">mask</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdu</span><span class="p">))]</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No intermediate bias file found. Using Bias = 0 instead.&quot;</span><span class="p">)</span>
            <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bhead</span></div>
</div>



<div class="viewcode-block" id="Flat">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Flat">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Flat</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the master flat&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of master bias fits file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.flat.fits&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Flat.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Flat.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the master flat to a FITS file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flat : array of shape (nrow, ncol)</span>
<span class="sd">            master flat data</span>
<span class="sd">        fhead : FITS header</span>
<span class="sd">            master flat header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">fhead</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;silentfix+ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created master flat file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Flat.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Flat.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the master flat, with the bias already subtracted</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            flat files</span>
<span class="sd">        bias : tuple(array of shape (nrow, ncol), FITS header)</span>
<span class="sd">            master bias and header</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        flat : masked array of shape (nrow, ncol)</span>
<span class="sd">            Master flat with bad pixel map applied</span>
<span class="sd">        fhead : FITS header</span>
<span class="sd">            Master flat FITS header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Flat files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
        <span class="c1"># This is just the calibration of images</span>
        <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># And then save it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fhead</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span></div>


<div class="viewcode-block" id="Flat.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Flat.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load master flat from disk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        flat : masked array of shape (nrow, ncol)</span>
<span class="sd">            Master flat with bad pixel map applied</span>
<span class="sd">        fhead : FITS header</span>
<span class="sd">            Master flat FITS header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Master flat file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No intermediate file for the flat field found. Using Flat = 1 instead&quot;</span>
            <span class="p">)</span>
            <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span></div>
</div>



<div class="viewcode-block" id="OrderTracing">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.OrderTracing">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderTracing</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the polynomial fits describing the pixel locations of each order&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1">#:int: Minimum size of each cluster to be included in further processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_cluster</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;min_cluster&quot;</span><span class="p">]</span>
        <span class="c1">#:int, float: Minimum width of each cluster after mergin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Size of the gaussian filter for smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_size&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Background noise value threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Polynomial degree of the fit to each order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">degree_before_merge</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree_before_merge&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;regularization&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closing_shape</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;closing_shape&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_merge_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;auto_merge_threshold&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_min_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge_min_threshold&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;split_sigma&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Number of pixels at the edge of the detector to ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_width&quot;</span><span class="p">]</span>
        <span class="c1">#:bool: Whether to use manual alignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;manual&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the order tracing file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.ord_default.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="OrderTracing.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.OrderTracing.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine polynomial coefficients describing order locations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            Observation used for order tracing (should only have one element)</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        orders : array of shape (nord, ndegree+1)</span>
<span class="sd">            polynomial coefficients for each order</span>
<span class="sd">        column_range : array of shape (nord, 2)</span>
<span class="sd">            first and last(+1) column that carries signal in each order</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Order tracing files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="n">order_img</span><span class="p">,</span> <span class="n">ohead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">mark_orders</span><span class="p">(</span>
            <span class="n">order_img</span><span class="p">,</span>
            <span class="n">min_cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cluster</span><span class="p">,</span>
            <span class="n">min_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_width</span><span class="p">,</span>
            <span class="n">filter_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_size</span><span class="p">,</span>
            <span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span>
            <span class="n">opower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_degree</span><span class="p">,</span>
            <span class="n">degree_before_merge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_before_merge</span><span class="p">,</span>
            <span class="n">regularization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">,</span>
            <span class="n">closing_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">closing_shape</span><span class="p">,</span>
            <span class="n">border_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">border_width</span><span class="p">,</span>
            <span class="n">manual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">,</span>
            <span class="n">auto_merge_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_merge_threshold</span><span class="p">,</span>
            <span class="n">merge_min_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_min_threshold</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span></div>


<div class="viewcode-block" id="OrderTracing.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.OrderTracing.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save order tracing results to disk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orders : array of shape (nord, ndegree+1)</span>
<span class="sd">            polynomial coefficients</span>
<span class="sd">        column_range : array of shape (nord, 2)</span>
<span class="sd">            first and last(+1) column that carry signal in each order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span><span class="o">=</span><span class="n">column_range</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created order tracing file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderTracing.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.OrderTracing.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load order tracing results</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        orders : array of shape (nord, ndegree+1)</span>
<span class="sd">            polynomial coefficients for each order</span>
<span class="sd">        column_range : array of shape (nord, 2)</span>
<span class="sd">            first and last(+1) column that carries signal in each order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Order tracing file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span>
        <span class="n">column_range</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;column_range&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span></div>
</div>



<div class="viewcode-block" id="BackgroundScatter">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.BackgroundScatter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BackgroundScatter</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the background scatter&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span>

        <span class="c1">#:tuple(int, int): Polynomial degrees for the background scatter fit, in row, column direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scatter_degree&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cutoff</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scatter_cutoff&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_width&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the scatter file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.scatter.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BackgroundScatter.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.BackgroundScatter.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">orders</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Background scatter files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="n">scatter_img</span><span class="p">,</span> <span class="n">shead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>

        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">estimate_background_scatter</span><span class="p">(</span>
            <span class="n">scatter_img</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">column_range</span><span class="o">=</span><span class="n">column_range</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">scatter_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_degree</span><span class="p">,</span>
            <span class="n">sigma_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_cutoff</span><span class="p">,</span>
            <span class="n">border_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">border_width</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scatter</span></div>


<div class="viewcode-block" id="BackgroundScatter.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.BackgroundScatter.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scatter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save scatter results to disk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scatter : array</span>
<span class="sd">            scatter coefficients</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created background scatter file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="BackgroundScatter.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.BackgroundScatter.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load scatter results from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scatter : array</span>
<span class="sd">            scatter coefficients</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Background scatter file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No intermediate files found for the scatter. Using scatter = 0 instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;scatter&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">scatter</span></div>
</div>



<div class="viewcode-block" id="NormalizeFlatField">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.NormalizeFlatField">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NormalizeFlatField</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the &#39;normalized&#39; flat field image&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="s2">&quot;curvature&quot;</span><span class="p">]</span>

        <span class="c1">#:{&#39;normalize&#39;}: Extraction method to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span> <span class="o">==</span> <span class="s2">&quot;normalize&quot;</span><span class="p">:</span>
            <span class="c1">#:dict: arguments for the extraction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;extraction_width&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">],</span>
                <span class="s2">&quot;lambda_sf&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;smooth_slitfunction&quot;</span><span class="p">],</span>
                <span class="s2">&quot;lambda_sp&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;smooth_spectrum&quot;</span><span class="p">],</span>
                <span class="s2">&quot;osample&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;oversampling&quot;</span><span class="p">],</span>
                <span class="s2">&quot;swath_width&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;swath_width&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sigma_cutoff&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_cutoff&quot;</span><span class="p">],</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Extraction method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span><span class="si">}</span><span class="s2"> not supported for step &#39;norm_flat&#39;&quot;</span>
            <span class="p">)</span>
        <span class="c1">#:int: Threshold of the normalized flat field (values below this are just 1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_lower</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold_lower&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the blaze file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.flat_norm.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="NormalizeFlatField.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.NormalizeFlatField.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">scatter</span><span class="p">,</span> <span class="n">curvature</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the &#39;normalized&#39; flat field</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flat : tuple(array, header)</span>
<span class="sd">            Master flat, and its FITS header</span>
<span class="sd">        orders : tuple(array, array)</span>
<span class="sd">            Polynomial coefficients for each order, and the first and last(+1) column containing signal</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        norm : array of shape (nrow, ncol)</span>
<span class="sd">            normalized flat field</span>
<span class="sd">        blaze : array of shape (nord, ncol)</span>
<span class="sd">            Continuum level as determined from the flat field for each order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat</span><span class="p">,</span> <span class="n">fhead</span> <span class="o">=</span> <span class="n">flat</span>
        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span> <span class="o">=</span> <span class="n">curvature</span>

        <span class="c1"># if threshold is smaller than 1, assume percentage value is given</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="n">norm</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">blaze</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span>
            <span class="n">flat</span><span class="p">,</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">gain</span><span class="o">=</span><span class="n">fhead</span><span class="p">[</span><span class="s2">&quot;e_gain&quot;</span><span class="p">],</span>
            <span class="n">readnoise</span><span class="o">=</span><span class="n">fhead</span><span class="p">[</span><span class="s2">&quot;e_readn&quot;</span><span class="p">],</span>
            <span class="n">dark</span><span class="o">=</span><span class="n">fhead</span><span class="p">[</span><span class="s2">&quot;e_drk&quot;</span><span class="p">],</span>
            <span class="n">order_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_range</span><span class="p">,</span>
            <span class="n">column_range</span><span class="o">=</span><span class="n">column_range</span><span class="p">,</span>
            <span class="n">scatter</span><span class="o">=</span><span class="n">scatter</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">threshold_lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_lower</span><span class="p">,</span>
            <span class="n">extraction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_method</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">blaze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">blaze</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span></div>


<div class="viewcode-block" id="NormalizeFlatField.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.NormalizeFlatField.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save normalized flat field results to disk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        norm : array of shape (nrow, ncol)</span>
<span class="sd">            normalized flat field</span>
<span class="sd">        blaze : array of shape (nord, ncol)</span>
<span class="sd">            Continuum level as determined from the flat field for each order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">blaze</span><span class="o">=</span><span class="n">blaze</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created normalized flat file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="NormalizeFlatField.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.NormalizeFlatField.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load normalized flat field results from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        norm : array of shape (nrow, ncol)</span>
<span class="sd">            normalized flat field</span>
<span class="sd">        blaze : array of shape (nord, ncol)</span>
<span class="sd">            Continuum level as determined from the flat field for each order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalized flat file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No intermediate files found for the normalized flat field. Using flat = 1 instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;blaze&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">blaze</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blaze&quot;</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibrationMaster">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationMaster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibrationMaster</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">,</span> <span class="n">ExtractionStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create wavelength calibration master image&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;norm_flat&quot;</span><span class="p">,</span> <span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the wavelength echelle file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.thar_master.fits&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="WavelengthCalibrationMaster.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationMaster.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform wavelength calibration</span>

<span class="sd">        This consists of extracting the wavelength image</span>
<span class="sd">        and fitting a polynomial the the known spectral lines</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            wavelength calibration files</span>
<span class="sd">        orders : tuple(array, array)</span>
<span class="sd">            Polynomial coefficients of each order, and columns with signal of each order</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            wavelength for each point in the spectrum</span>
<span class="sd">        thar : array of shape (nrow, ncol)</span>
<span class="sd">            extracted wavelength calibration image</span>
<span class="sd">        coef : array of shape (*ndegrees,)</span>
<span class="sd">            polynomial coefficients of the wavelength fit</span>
<span class="sd">        linelist : record array of shape (nlines,)</span>
<span class="sd">            Updated line information for all lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No files found for wavelength calibration&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wavelength calibration files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
        <span class="c1"># Load wavecal image</span>
        <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">)</span>
        <span class="c1"># Extract wavecal spectrum</span>
        <span class="n">thar</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">thead</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">curvature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">thar</span><span class="p">,</span> <span class="n">thead</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span></div>


<div class="viewcode-block" id="WavelengthCalibrationMaster.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationMaster.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the master wavelength calibration to a FITS file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        thar : array of shape (nrow, ncol)</span>
<span class="sd">            master flat data</span>
<span class="sd">        thead : FITS header</span>
<span class="sd">            master flat header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">thar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">thar</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">thead</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;silentfix+ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created wavelength calibration spectrum file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="WavelengthCalibrationMaster.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationMaster.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load master wavelength calibration from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        thar : masked array of shape (nrow, ncol)</span>
<span class="sd">            Master wavecal with bad pixel map applied</span>
<span class="sd">        thead : FITS header</span>
<span class="sd">            Master wavecal FITS header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
            <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wavelength calibration spectrum file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibrationInitialize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationInitialize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibrationInitialize</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the initial wavelength solution file&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;wavecal_master&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;wavecal_master&quot;</span><span class="p">]</span>

        <span class="c1">#:tuple(int, int): Polynomial degree of the wavelength calibration in order, column direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>
        <span class="c1">#:float: wavelength range around the initial guess to explore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;wave_delta&quot;</span><span class="p">]</span>
        <span class="c1">#:int: number of walkers in the MCMC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nwalkers&quot;</span><span class="p">]</span>
        <span class="c1">#:int: number of steps in the MCMC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
        <span class="c1">#:float: resiudal range to accept as match between peaks and atlas in m/s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_delta</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;resid_delta&quot;</span><span class="p">]</span>
        <span class="c1">#:str: element for the atlas to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="c1">#:str: medium the medium of the instrument, air or vac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">]</span>
        <span class="c1">#:float: Gaussian smoothing parameter applied to the observed spectrum in pixel scale, set to 0 to disable smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;smoothing&quot;</span><span class="p">]</span>
        <span class="c1">#:float: Minimum height of spectral lines in the normalized spectrum, values of 1 and above are interpreted as percentiles of the spectrum, set to 0 to disable the cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;cutoff&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the wavelength echelle file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.linelist.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="WavelengthCalibrationInitialize.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationInitialize.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavecal_master</span><span class="p">):</span>
        <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">wavecal_master</span>

        <span class="c1"># Get the initial wavelength guess from the instrument</span>
        <span class="n">wave_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_wavelength_range</span><span class="p">(</span><span class="n">thead</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wave_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;This instrument is missing an initial wavelength guess for wavecal_init&quot;</span>
            <span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">WavelengthCalibrationInitializeModule</span><span class="p">(</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">wave_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_delta</span><span class="p">,</span>
            <span class="n">nwalkers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span>
            <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span>
            <span class="n">resid_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resid_delta</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
            <span class="n">smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">,</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">thar</span><span class="p">,</span> <span class="n">wave_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">linelist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationInitialize.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linelist</span><span class="p">):</span>
        <span class="n">linelist</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created wavelength calibration linelist file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="WavelengthCalibrationInitialize.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationInitialize.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">wavecal_master</span><span class="p">):</span>
        <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">wavecal_master</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try loading the custom reference file</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="c1"># If that fails, load the file provided by PyReduce</span>
            <span class="c1"># It usually fails because we want to use this one</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_wavecal_filename</span><span class="p">(</span>
                <span class="n">thead</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># This should fail if there is no provided file by PyReduce</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wavelength calibration linelist file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist</span></div>
</div>



<div class="viewcode-block" id="WavelengthCalibrationFinalize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationFinalize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WavelengthCalibrationFinalize</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform wavelength calibration&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;wavecal_master&quot;</span><span class="p">,</span> <span class="s2">&quot;wavecal_init&quot;</span><span class="p">]</span>

        <span class="c1">#:tuple(int, int): Polynomial degree of the wavelength calibration in order, column direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>
        <span class="c1">#:bool: Whether to use manual alignment instead of cross correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;manual&quot;</span><span class="p">]</span>
        <span class="c1">#:float: residual threshold in m/s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Number of iterations in the remove lines, auto id cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>
        <span class="c1">#:{&#39;1D&#39;, &#39;2D&#39;}: Whether to use 1d or 2d polynomials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Number of detector offset steps, due to detector design</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstep</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nstep&quot;</span><span class="p">]</span>
        <span class="c1">#:int: How many columns to use in the 2D cross correlation alignment. 0 means all pixels (slow).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;correlate_cols&quot;</span><span class="p">]</span>
        <span class="c1">#:float: fraction of columns, to allow individual orders to shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_window</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;shift_window&quot;</span><span class="p">]</span>
        <span class="c1">#:str: elements of the spectral lamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="c1">#:str: medium of the detector, vac or air</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the wavelength echelle file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.thar.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="WavelengthCalibrationFinalize.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationFinalize.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavecal_master</span><span class="p">,</span> <span class="n">wavecal_init</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform wavelength calibration</span>

<span class="sd">        This consists of extracting the wavelength image</span>
<span class="sd">        and fitting a polynomial the the known spectral lines</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavecal_master : tuple</span>
<span class="sd">            results of the wavecal_master step, containing the master wavecal image</span>
<span class="sd">            and its header</span>
<span class="sd">        wavecal_init : LineList</span>
<span class="sd">            the initial LineList guess with the positions and wavelengths of lines</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            wavelength for each point in the spectrum</span>
<span class="sd">        coef : array of shape (*ndegrees,)</span>
<span class="sd">            polynomial coefficients of the wavelength fit</span>
<span class="sd">        linelist : record array of shape (nlines,)</span>
<span class="sd">            Updated line information for all lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thar</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="n">wavecal_master</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">wavecal_init</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">WavelengthCalibrationModule</span><span class="p">(</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">manual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">,</span>
            <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">iterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span>
            <span class="n">dimensionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">,</span>
            <span class="n">nstep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nstep</span><span class="p">,</span>
            <span class="n">correlate_cols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correlate_cols</span><span class="p">,</span>
            <span class="n">shift_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_window</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">thar</span><span class="p">,</span> <span class="n">linelist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span></div>


<div class="viewcode-block" id="WavelengthCalibrationFinalize.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationFinalize.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the results of the wavelength calibration</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            wavelength for each point in the spectrum</span>
<span class="sd">        coef : array of shape (ndegrees,)</span>
<span class="sd">            polynomial coefficients of the wavelength fit</span>
<span class="sd">        linelist : record array of shape (nlines,)</span>
<span class="sd">            Updated line information for all lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span><span class="o">=</span><span class="n">linelist</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created wavelength calibration file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="WavelengthCalibrationFinalize.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.WavelengthCalibrationFinalize.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the results of the wavelength calibration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            wavelength for each point in the spectrum</span>
<span class="sd">        coef : array of shape (*ndegrees,)</span>
<span class="sd">            polynomial coefficients of the wavelength fit</span>
<span class="sd">        linelist : record array of shape (nlines,)</span>
<span class="sd">            Updated line information for all lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wavelength calibration file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;coef&quot;</span><span class="p">]</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;linelist&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span></div>
</div>



<div class="viewcode-block" id="LaserFrequencyCombMaster">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombMaster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LaserFrequencyCombMaster</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">,</span> <span class="n">ExtractionStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a laser frequency comb (or similar) master image&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;norm_flat&quot;</span><span class="p">,</span> <span class="s2">&quot;curvature&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the wavelength echelle file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.comb_master.fits&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LaserFrequencyCombMaster.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombMaster.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Improve the wavelength calibration with a laser frequency comb (or similar)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            observation files</span>
<span class="sd">        orders : tuple</span>
<span class="sd">            results from the order tracing step</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>
<span class="sd">        curvature : tuple</span>
<span class="sd">            results from the curvature step</span>
<span class="sd">        bias : tuple</span>
<span class="sd">            results from the bias step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        comb : array of shape (nord, ncol)</span>
<span class="sd">            extracted frequency comb image</span>
<span class="sd">        chead : Header</span>
<span class="sd">            FITS header of the combined image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No files for Laser Frequency Comb found&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Frequency comb files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="c1"># Combine the input files and calibrate</span>
        <span class="n">orig</span><span class="p">,</span> <span class="n">chead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">)</span>
        <span class="c1"># Extract the spectrum</span>
        <span class="n">comb</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">chead</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">curvature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="n">chead</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comb</span><span class="p">,</span> <span class="n">chead</span></div>


<div class="viewcode-block" id="LaserFrequencyCombMaster.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombMaster.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comb</span><span class="p">,</span> <span class="n">chead</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the master comb to a FITS file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comb : array of shape (nrow, ncol)</span>
<span class="sd">            master comb data</span>
<span class="sd">        chead : FITS header</span>
<span class="sd">            master comb header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">comb</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">chead</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;silentfix+ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created frequency comb master spectrum: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="LaserFrequencyCombMaster.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombMaster.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load master comb from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        comb : masked array of shape (nrow, ncol)</span>
<span class="sd">            Master comb with bad pixel map applied</span>
<span class="sd">        chead : FITS header</span>
<span class="sd">            Master comb FITS header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
            <span class="n">comb</span><span class="p">,</span> <span class="n">chead</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Frequency comb master spectrum: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comb</span><span class="p">,</span> <span class="n">chead</span></div>
</div>



<div class="viewcode-block" id="LaserFrequencyCombFinalize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombFinalize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LaserFrequencyCombFinalize</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Improve the precision of the wavelength calibration with a laser frequency comb&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;freq_comb_master&quot;</span><span class="p">,</span> <span class="s2">&quot;wavecal&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;wavecal&quot;</span><span class="p">]</span>

        <span class="c1">#:tuple(int, int): polynomial degree of the wavelength fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>
        <span class="c1">#:float: residual threshold in m/s above which to remove lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="c1">#:{&#39;1D&#39;, &#39;2D&#39;}: Whether to use 1D or 2D polynomials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstep</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nstep&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Width of the peaks for finding them in the spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lfc_peak_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lfc_peak_width&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the wavelength echelle file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.comb.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LaserFrequencyCombFinalize.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombFinalize.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq_comb_master</span><span class="p">,</span> <span class="n">wavecal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Improve the wavelength calibration with a laser frequency comb (or similar)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            observation files</span>
<span class="sd">        wavecal : tuple()</span>
<span class="sd">            results from the wavelength calibration step</span>
<span class="sd">        orders : tuple</span>
<span class="sd">            results from the order tracing step</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            improved wavelength solution</span>
<span class="sd">        comb : array of shape (nord, ncol)</span>
<span class="sd">            extracted frequency comb image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comb</span><span class="p">,</span> <span class="n">chead</span> <span class="o">=</span> <span class="n">freq_comb_master</span>
        <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span> <span class="o">=</span> <span class="n">wavecal</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">WavelengthCalibrationComb</span><span class="p">(</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">dimensionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">,</span>
            <span class="n">nstep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nstep</span><span class="p">,</span>
            <span class="n">lfc_peak_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lfc_peak_width</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">linelist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wave</span></div>


<div class="viewcode-block" id="LaserFrequencyCombFinalize.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombFinalize.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the results of the frequency comb improvement</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            improved wavelength solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created frequency comb wavecal file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="LaserFrequencyCombFinalize.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.LaserFrequencyCombFinalize.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavecal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the results of the frequency comb improvement if possible,</span>
<span class="sd">        otherwise just use the normal wavelength solution</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavecal : tuple</span>
<span class="sd">            results from the wavelength calibration step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            improved wavelength solution</span>
<span class="sd">        comb : array of shape (nord, ncol)</span>
<span class="sd">            extracted frequency comb image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Frequency comb wavecal file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No data for Laser Frequency Comb found, using regular wavelength calibration instead&quot;</span>
            <span class="p">)</span>
            <span class="n">wave</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">linelist</span> <span class="o">=</span> <span class="n">wavecal</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;wave&quot;</span><span class="p">:</span> <span class="n">wave</span><span class="p">}</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">wave</span></div>
</div>



<div class="viewcode-block" id="SlitCurvatureDetermination">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.SlitCurvatureDetermination">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SlitCurvatureDetermination</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">,</span> <span class="n">ExtractionStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the curvature of the slit&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1">#:float: how many sigma of bad lines to cut away</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cutoff</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;curvature_cutoff&quot;</span><span class="p">]</span>
        <span class="c1">#:float: width of the orders in the extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Polynomial degree of the overall fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span>
        <span class="c1">#:int: Orders of the curvature to fit, currently supports only 1 and 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curv_degree</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;curv_degree&quot;</span><span class="p">]</span>
        <span class="c1">#:{&#39;1D&#39;, &#39;2D&#39;}: Whether to use 1d or 2d polynomials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvature_mode</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span>
        <span class="c1">#:float: peak finding noise threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;peak_threshold&quot;</span><span class="p">]</span>
        <span class="c1">#:int: peak width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;peak_width&quot;</span><span class="p">]</span>
        <span class="c1">#:float: window width to search for peak in each row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;window_width&quot;</span><span class="p">]</span>
        <span class="c1">#:str: Function shape that is fit to individual peaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_function</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;peak_function&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Name of the tilt/shear save file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.shear.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SlitCurvatureDetermination.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.SlitCurvatureDetermination.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the curvature of the slit</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            files to use for this</span>
<span class="sd">        orders : tuple</span>
<span class="sd">            results of the order tracing</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            Bad pixel mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tilt : array of shape (nord, ncol)</span>
<span class="sd">            first order slit curvature at each point</span>
<span class="sd">        shear : array of shape (nord, ncol)</span>
<span class="sd">            second order slit curvature at each point</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Slit curvature files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="n">orig</span><span class="p">,</span> <span class="n">thead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">extracted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">thead</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">CurvatureModule</span><span class="p">(</span>
            <span class="n">orders</span><span class="p">,</span>
            <span class="n">column_range</span><span class="o">=</span><span class="n">column_range</span><span class="p">,</span>
            <span class="n">extraction_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span><span class="p">,</span>
            <span class="n">order_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_range</span><span class="p">,</span>
            <span class="n">fit_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_degree</span><span class="p">,</span>
            <span class="n">curv_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curv_degree</span><span class="p">,</span>
            <span class="n">sigma_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_cutoff</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature_mode</span><span class="p">,</span>
            <span class="n">peak_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_threshold</span><span class="p">,</span>
            <span class="n">peak_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span><span class="p">,</span>
            <span class="n">window_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_width</span><span class="p">,</span>
            <span class="n">peak_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_function</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span></div>


<div class="viewcode-block" id="SlitCurvatureDetermination.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.SlitCurvatureDetermination.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save results from the curvature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tilt : array of shape (nord, ncol)</span>
<span class="sd">            first order slit curvature at each point</span>
<span class="sd">        shear : array of shape (nord, ncol)</span>
<span class="sd">            second order slit curvature at each point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created slit curvature file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="SlitCurvatureDetermination.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.SlitCurvatureDetermination.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the curvature if possible, otherwise return None, None, i.e. use vertical extraction</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tilt : array of shape (nord, ncol)</span>
<span class="sd">            first order slit curvature at each point</span>
<span class="sd">        shear : array of shape (nord, ncol)</span>
<span class="sd">            second order slit curvature at each point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Slit curvature file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No data for slit curvature found, setting it to 0.&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tilt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;shear&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">tilt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tilt&quot;</span><span class="p">]</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shear&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span></div>
</div>



<div class="viewcode-block" id="RectifyImage">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.RectifyImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RectifyImage</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a 2D image of the rectified orders&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_comb&quot;</span><span class="p">]</span>
        <span class="c1"># self._loadDependsOn += []</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extraction_width&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_files&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="RectifyImage.filename">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.RectifyImage.filename">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">swap_extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;.rectify.fits&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="RectifyImage.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.RectifyImage.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">freq_comb</span><span class="p">):</span>
        <span class="n">orders</span><span class="p">,</span> <span class="n">column_range</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="n">tilt</span><span class="p">,</span> <span class="n">shear</span> <span class="o">=</span> <span class="n">curvature</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">freq_comb</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_files</span><span class="p">]</span>

        <span class="n">rectified</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Files&quot;</span><span class="p">):</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">load_fits</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;f8&quot;</span>
            <span class="p">)</span>

            <span class="n">images</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">xwd</span> <span class="o">=</span> <span class="n">rectify_image</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">orders</span><span class="p">,</span>
                <span class="n">column_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extraction_width</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order_range</span><span class="p">,</span>
                <span class="n">tilt</span><span class="p">,</span>
                <span class="n">shear</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">wavelength</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">merge_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">xwd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">head</span><span class="p">)</span>
            <span class="n">rectified</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rectified</span></div>


<div class="viewcode-block" id="RectifyImage.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.RectifyImage.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Change filename</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="c1"># Create HDU List, one extension per order</span>
        <span class="n">primary</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="n">secondary</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">wavelength</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
        <span class="n">tertiary</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">([</span><span class="n">column</span><span class="p">])</span>
        <span class="n">hdus</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">tertiary</span><span class="p">])</span>
        <span class="c1"># Save data to file</span>
        <span class="n">hdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;silentfix&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RectifyImage.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.RectifyImage.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_files</span><span class="p">]</span>

        <span class="n">rectified</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">orig_fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">orig_fname</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">wave</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>
            <span class="n">rectified</span><span class="p">[</span><span class="n">orig_fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rectified</span></div>
</div>



<div class="viewcode-block" id="ScienceExtraction">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ScienceExtraction">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScienceExtraction</span><span class="p">(</span><span class="n">CalibrationStep</span><span class="p">,</span> <span class="n">ExtractionStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the science spectra&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;norm_flat&quot;</span><span class="p">,</span> <span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ScienceExtraction.science_file">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ScienceExtraction.science_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">science_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of the science file in disk, based on the input file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            name of the observation file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        name : str</span>
<span class="sd">            science file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">swap_extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;.science.ech&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScienceExtraction.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ScienceExtraction.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">scatter</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract Science spectra from observation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list(str)</span>
<span class="sd">            list of observations</span>
<span class="sd">        bias : tuple</span>
<span class="sd">            results from master bias step</span>
<span class="sd">        orders : tuple</span>
<span class="sd">            results from order tracing step</span>
<span class="sd">        norm_flat : tuple</span>
<span class="sd">            results from flat normalization</span>
<span class="sd">        curvature : tuple</span>
<span class="sd">            results from slit curvature step</span>
<span class="sd">        mask : array of shape (nrow, ncol)</span>
<span class="sd">            bad pixel map</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heads : list(FITS header)</span>
<span class="sd">            FITS headers of each observation</span>
<span class="sd">        specs : list(array of shape (nord, ncol))</span>
<span class="sd">            extracted spectra</span>
<span class="sd">        sigmas : list(array of shape (nord, ncol))</span>
<span class="sd">            uncertainties of the extracted spectra</span>
<span class="sd">        slitfu: list(array of shape (nord, (extr_height*oversample+1)+1)</span>
<span class="sd">            slit illumination function</span>
<span class="sd">        columns : list(array of shape (nord, 2))</span>
<span class="sd">            column ranges for each spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">slitfus</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Files&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Science file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="c1"># Calibrate the input image</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">([</span><span class="n">fname</span><span class="p">],</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">)</span>
            <span class="c1"># Optimally extract science spectrum</span>
            <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">slitfu</span><span class="p">,</span> <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">im</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="n">scatter</span>
            <span class="p">)</span>

            <span class="c1"># make slitfus from swaths into one</span>
            <span class="c1"># print(len(slitfu),[len(sf) for sf in slitfu])</span>
            <span class="c1"># slitfu = np.median(np.array(slitfu),axis=0)</span>
            <span class="c1"># save spectrum to disk</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">slitfu</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
            <span class="n">heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
            <span class="n">slitfus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slitfu</span><span class="p">)</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">slitfus</span><span class="p">,</span> <span class="n">columns</span></div>


<div class="viewcode-block" id="ScienceExtraction.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ScienceExtraction.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">slitfu</span><span class="p">,</span> <span class="n">column_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the results of one extraction</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            filename to save to</span>
<span class="sd">        head : FITS header</span>
<span class="sd">            FITS header</span>
<span class="sd">        spec : array of shape (nord, ncol)</span>
<span class="sd">            extracted spectrum</span>
<span class="sd">        sigma : array of shape (nord, ncol)</span>
<span class="sd">            uncertainties of the extracted spectrum</span>
<span class="sd">        slitfu: list(array of shape (nord, (extr_height*oversample+1)+1)</span>
<span class="sd">            slit illumination function</span>
<span class="sd">        column_range : array of shape (nord, 2)</span>
<span class="sd">            range of columns that have spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nameout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">echelle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">nameout</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">slitfu</span><span class="o">=</span><span class="n">slitfu</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_range</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created science file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nameout</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScienceExtraction.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ScienceExtraction.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all science spectra from disk</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heads : list(FITS header)</span>
<span class="sd">            FITS headers of each observation</span>
<span class="sd">        specs : list(array of shape (nord, ncol))</span>
<span class="sd">            extracted spectra</span>
<span class="sd">        sigmas : list(array of shape (nord, ncol))</span>
<span class="sd">            uncertainties of the extracted spectra</span>
<span class="sd">        columns : list(array of shape (nord, 2))</span>
<span class="sd">            column ranges for each spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s2">&quot;science&quot;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">science_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Science files are required to load them&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Science files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># fname = join(self.output_dir, fname)</span>
            <span class="n">science</span> <span class="o">=</span> <span class="n">echelle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span>
                <span class="n">continuum_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">barycentric_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">radial_velociy_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>
            <span class="n">sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">])</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">columns</span></div>
</div>



<div class="viewcode-block" id="ContinuumNormalization">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ContinuumNormalization">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ContinuumNormalization</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the continuum to each observation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;science&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_comb&quot;</span><span class="p">,</span> <span class="s2">&quot;norm_flat&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadDependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;norm_flat&quot;</span><span class="p">,</span> <span class="s2">&quot;science&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">savefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: savefile name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.cont.npz&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ContinuumNormalization.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ContinuumNormalization.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">science</span><span class="p">,</span> <span class="n">freq_comb</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the continuum to each observation</span>
<span class="sd">        Also splices the orders together</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        science : tuple</span>
<span class="sd">            results from science step</span>
<span class="sd">        freq_comb : tuple</span>
<span class="sd">            results from freq_comb step (or wavecal if those don&#39;t exist)</span>
<span class="sd">        norm_flat : tuple</span>
<span class="sd">            results from the normalized flatfield step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heads : list(FITS header)</span>
<span class="sd">            FITS headers of each observation</span>
<span class="sd">        specs : list(array of shape (nord, ncol))</span>
<span class="sd">            extracted spectra</span>
<span class="sd">        sigmas : list(array of shape (nord, ncol))</span>
<span class="sd">            uncertainties of the extracted spectra</span>
<span class="sd">        conts : list(array of shape (nord, ncol))</span>
<span class="sd">            continuum for each spectrum</span>
<span class="sd">        columns : list(array of shape (nord, 2))</span>
<span class="sd">            column ranges for each spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">freq_comb</span>
        <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">science</span>
        <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span> <span class="o">=</span> <span class="n">norm_flat</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Continuum normalization&quot;</span><span class="p">)</span>
        <span class="n">conts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Splicing orders&quot;</span><span class="p">)</span>
            <span class="n">specs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">wave</span><span class="p">,</span> <span class="n">blaze</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">splice_orders</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span>
                <span class="n">wave</span><span class="p">,</span>
                <span class="n">blaze</span><span class="p">,</span>
                <span class="n">sigma</span><span class="p">,</span>
                <span class="n">scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalizing continuum&quot;</span><span class="p">)</span>
            <span class="n">conts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuum_normalize</span><span class="p">(</span>
                <span class="n">specs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">wave</span><span class="p">,</span>
                <span class="n">blaze</span><span class="p">,</span>
                <span class="n">sigmas</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                <span class="n">plot_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span></div>


<div class="viewcode-block" id="ContinuumNormalization.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ContinuumNormalization.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the results from the continuum normalization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        heads : list(FITS header)</span>
<span class="sd">            FITS headers of each observation</span>
<span class="sd">        specs : list(array of shape (nord, ncol))</span>
<span class="sd">            extracted spectra</span>
<span class="sd">        sigmas : list(array of shape (nord, ncol))</span>
<span class="sd">            uncertainties of the extracted spectra</span>
<span class="sd">        conts : list(array of shape (nord, ncol))</span>
<span class="sd">            continuum for each spectrum</span>
<span class="sd">        columns : list(array of shape (nord, 2))</span>
<span class="sd">            column ranges for each spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;heads&quot;</span><span class="p">:</span> <span class="n">heads</span><span class="p">,</span>
            <span class="s2">&quot;specs&quot;</span><span class="p">:</span> <span class="n">specs</span><span class="p">,</span>
            <span class="s2">&quot;sigmas&quot;</span><span class="p">:</span> <span class="n">sigmas</span><span class="p">,</span>
            <span class="s2">&quot;conts&quot;</span><span class="p">:</span> <span class="n">conts</span><span class="p">,</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created continuum normalization file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span></div>


<div class="viewcode-block" id="ContinuumNormalization.load">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.ContinuumNormalization.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_flat</span><span class="p">,</span> <span class="n">science</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the results from the continuum normalization</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heads : list(FITS header)</span>
<span class="sd">            FITS headers of each observation</span>
<span class="sd">        specs : list(array of shape (nord, ncol))</span>
<span class="sd">            extracted spectra</span>
<span class="sd">        sigmas : list(array of shape (nord, ncol))</span>
<span class="sd">            uncertainties of the extracted spectra</span>
<span class="sd">        conts : list(array of shape (nord, ncol))</span>
<span class="sd">            continuum for each spectrum</span>
<span class="sd">        columns : list(array of shape (nord, 2))</span>
<span class="sd">            column ranges for each spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Continuum normalization file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="c1"># Use science files instead</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No continuum normalized data found. Using unnormalized results instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">science</span>
            <span class="n">norm</span><span class="p">,</span> <span class="n">blaze</span> <span class="o">=</span> <span class="n">norm_flat</span>
            <span class="n">conts</span> <span class="o">=</span> <span class="p">[</span><span class="n">blaze</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">heads</span><span class="o">=</span><span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="o">=</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span>
            <span class="p">)</span>
        <span class="n">heads</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;heads&quot;</span><span class="p">]</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sigmas&quot;</span><span class="p">]</span>
        <span class="n">conts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;conts&quot;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span></div>
</div>



<div class="viewcode-block" id="Finalize">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Finalize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Finalize</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the final output files&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependsOn</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;continuum&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_comb&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="Finalize.output_file">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Finalize.output_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: output file name&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">night</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">night</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="Finalize.save_config_to_header">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Finalize.save_config_to_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_config_to_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;PR&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_config_to_header</span><span class="p">(</span>
                    <span class="n">head</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="s2">&quot;$schema&quot;</span><span class="p">,</span> <span class="s2">&quot;__skip_existing__&quot;</span><span class="p">]:</span>
                    <span class="c1"># Skip values that are not relevant to the file product</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">head</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;HIERARCH </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">head</span></div>


<div class="viewcode-block" id="Finalize.run">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Finalize.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continuum</span><span class="p">,</span> <span class="n">freq_comb</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the final output files</span>

<span class="sd">        this is includes:</span>
<span class="sd">         - heliocentric corrections</span>
<span class="sd">         - creating one echelle file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        continuum : tuple</span>
<span class="sd">            results from the continuum normalization</span>
<span class="sd">        freq_comb : tuple</span>
<span class="sd">            results from the frequency comb step (or wavelength calibration)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">continuum</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">freq_comb</span>

        <span class="n">fnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Combine science with wavecal and continuum</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">blaze</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_erscle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;absolute&quot;</span><span class="p">,</span> <span class="s2">&quot;error scale&quot;</span><span class="p">)</span>

            <span class="c1"># Add heliocentric correction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rv_corr</span><span class="p">,</span> <span class="n">bjd</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">helcorr</span><span class="p">(</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_obslon&quot;</span><span class="p">],</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_obslat&quot;</span><span class="p">],</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_obsalt&quot;</span><span class="p">],</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_ra&quot;</span><span class="p">],</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_dec&quot;</span><span class="p">],</span>
                    <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_jd&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Heliocentric correction: </span><span class="si">%f</span><span class="s2"> km/s&quot;</span><span class="p">,</span> <span class="n">rv_corr</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Heliocentric Julian Date: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bjd</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not calculate heliocentric correction&quot;</span><span class="p">)</span>
                <span class="c1"># logger.warning(&quot;Telescope is in space?&quot;)</span>
                <span class="n">rv_corr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bjd</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_jd&quot;</span><span class="p">]</span>

            <span class="n">head</span><span class="p">[</span><span class="s2">&quot;barycorr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv_corr</span>
            <span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_jd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bjd</span>
            <span class="n">head</span><span class="p">[</span><span class="s2">&quot;HIERARCH PR_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>

            <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_config_to_header</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">spec</span> <span class="o">/</span> <span class="n">blaze</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">blaze</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="n">fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fnames</span></div>


<div class="viewcode-block" id="Finalize.save">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Finalize.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save one output spectrum to disk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int</span>
<span class="sd">            individual number of each file</span>
<span class="sd">        head : FITS header</span>
<span class="sd">            FITS header</span>
<span class="sd">        spec : array of shape (nord, ncol)</span>
<span class="sd">            final spectrum</span>
<span class="sd">        sigma : array of shape (nord, ncol)</span>
<span class="sd">            final uncertainties</span>
<span class="sd">        cont : array of shape (nord, ncol)</span>
<span class="sd">            final continuum scales</span>
<span class="sd">        wave : array of shape (nord, ncol)</span>
<span class="sd">            wavelength solution</span>
<span class="sd">        columns : array of shape (nord, 2)</span>
<span class="sd">            columns that carry signal</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out_file : str</span>
<span class="sd">            name of the output file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="s2">&quot;e_input&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">original_name</span><span class="p">)</span>
        <span class="n">echelle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">out_file</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="n">cont</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Final science file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_file</span></div>
</div>



<div class="viewcode-block" id="Reducer">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Reducer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Reducer</span><span class="p">:</span>
    <span class="n">step_order</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
        <span class="s2">&quot;norm_flat&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;wavecal_master&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;wavecal_init&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
        <span class="s2">&quot;wavecal&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span>
        <span class="s2">&quot;freq_comb_master&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;freq_comb&quot;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span>
        <span class="s2">&quot;rectify&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
        <span class="s2">&quot;science&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s2">&quot;continuum&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
        <span class="s2">&quot;finalize&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">Mask</span><span class="p">,</span>
        <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="n">Bias</span><span class="p">,</span>
        <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="n">Flat</span><span class="p">,</span>
        <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="n">OrderTracing</span><span class="p">,</span>
        <span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="n">BackgroundScatter</span><span class="p">,</span>
        <span class="s2">&quot;norm_flat&quot;</span><span class="p">:</span> <span class="n">NormalizeFlatField</span><span class="p">,</span>
        <span class="s2">&quot;wavecal_master&quot;</span><span class="p">:</span> <span class="n">WavelengthCalibrationMaster</span><span class="p">,</span>
        <span class="s2">&quot;wavecal_init&quot;</span><span class="p">:</span> <span class="n">WavelengthCalibrationInitialize</span><span class="p">,</span>
        <span class="s2">&quot;wavecal&quot;</span><span class="p">:</span> <span class="n">WavelengthCalibrationFinalize</span><span class="p">,</span>
        <span class="s2">&quot;freq_comb_master&quot;</span><span class="p">:</span> <span class="n">LaserFrequencyCombMaster</span><span class="p">,</span>
        <span class="s2">&quot;freq_comb&quot;</span><span class="p">:</span> <span class="n">LaserFrequencyCombFinalize</span><span class="p">,</span>
        <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="n">SlitCurvatureDetermination</span><span class="p">,</span>
        <span class="s2">&quot;science&quot;</span><span class="p">:</span> <span class="n">ScienceExtraction</span><span class="p">,</span>
        <span class="s2">&quot;continuum&quot;</span><span class="p">:</span> <span class="n">ContinuumNormalization</span><span class="p">,</span>
        <span class="s2">&quot;finalize&quot;</span><span class="p">:</span> <span class="n">Finalize</span><span class="p">,</span>
        <span class="s2">&quot;rectify&quot;</span><span class="p">:</span> <span class="n">RectifyImage</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">files</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">instrument</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">night</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">order_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce all observations from a single night and instrument mode</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files: dict{str:str}</span>
<span class="sd">            Data files for each step</span>
<span class="sd">        output_dir : str</span>
<span class="sd">            directory to place output files in</span>
<span class="sd">        target : str</span>
<span class="sd">            observed targets as used in directory names/fits headers</span>
<span class="sd">        instrument : str</span>
<span class="sd">            instrument used for observations</span>
<span class="sd">        mode : str</span>
<span class="sd">            instrument mode used (e.g. &quot;red&quot; or &quot;blue&quot; for HARPS)</span>
<span class="sd">        night : str</span>
<span class="sd">            Observation night, in the same format as used in the directory structure/file sorting</span>
<span class="sd">        config : dict</span>
<span class="sd">            numeric reduction specific settings, like pixel threshold, which may change between runs</span>
<span class="sd">        info : dict</span>
<span class="sd">            fixed instrument specific values, usually header keywords for gain, readnoise, etc.</span>
<span class="sd">        skip_existing : bool</span>
<span class="sd">            Whether to skip reductions with existing output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#:dict(str:str): Filenames sorted by usecase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">),</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="o">=</span><span class="n">night</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="n">load_instrument</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">order_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_existing</span> <span class="o">=</span> <span class="n">skip_existing</span>

<div class="viewcode-block" id="Reducer.run_module">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Reducer.run_module">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># The Module this step is based on (An object of the Step class)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">step</span><span class="p">](</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="c1"># Load the dependencies necessary for loading/running this step</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">dependsOn</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span> <span class="k">else</span> <span class="n">module</span><span class="o">.</span><span class="n">loadDependsOn</span>
        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dependency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">dependency</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_module</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">}</span>

        <span class="c1"># Try to load the data, if the step is not specifically given as necessary</span>
        <span class="c1"># If the intermediate data is not available, run it normally instead</span>
        <span class="c1"># But give a warning</span>
        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading data from step &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Intermediate File(s) for loading step </span><span class="si">%s</span><span class="s2"> not found. Running it instead.&quot;</span><span class="p">,</span>
                    <span class="n">step</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_module</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running step &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Reducer.prepare_output_dir">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Reducer.prepare_output_dir">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create output folder structure if necessary</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="Reducer.run_steps">
<a class="viewcode-back" href="../../pyreduce.html#pyreduce.reduce.Reducer.run_steps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the steps as required</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        steps : {tuple(str), &quot;all&quot;}, optional</span>
<span class="sd">            which steps of the reduction process to perform</span>
<span class="sd">            the possible steps are: &quot;bias&quot;, &quot;flat&quot;, &quot;orders&quot;, &quot;norm_flat&quot;, &quot;wavecal&quot;, &quot;freq_comb&quot;,</span>
<span class="sd">            &quot;curvature&quot;, &quot;science&quot;, &quot;continuum&quot;, &quot;finalize&quot;</span>
<span class="sd">            alternatively set steps to &quot;all&quot;, which is equivalent to setting all steps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_output_dir</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_order</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_existing</span> <span class="ow">and</span> <span class="s2">&quot;finalize&quot;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;finalize&quot;</span><span class="p">](</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;finalize&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="p">)</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;science&quot;</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;finalize&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;science&quot;</span><span class="p">])}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;science&quot;</span><span class="p">]):</span>
                <span class="n">fname_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">fname_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname_in</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fname_out</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">output_file</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">fname_in</span><span class="p">)</span>
                <span class="n">fname_out</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fname_out</span><span class="p">)</span>
                <span class="n">exists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_out</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;finalize&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">exists</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All science files already exist, skipping this set&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>

        <span class="n">steps</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_order</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_module</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyReduce</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How To use PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_file.html">PyReduce Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Supporting Custom instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyReduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wavecal_linelist.html">Wavelength Calibration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyreduce.html">pyreduce</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Ansgar Wehrhahn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>